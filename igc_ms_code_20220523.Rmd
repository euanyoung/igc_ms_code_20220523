---
title: Code for "Lifetime reproductive success is an imprecise but largely unbiased predictor of long-term genetic contribution in humans"
author: "Euan A Young"
date: '2022-05-23'
output: html_document
---

In this Rmarkdown document contains all the code necessary to repeat the analyses from "Lifetime reproductive success is an imprecise but largely unbiased predictor of long-term genetic contribution in humans" (Young et al. in press). 

This is broken down here into four sections:
1. Import of raw data and estimation of arrival and departure years
2. Estimation of IGC and subset of data for analysis
3. Zero-inflated models and output

# 1. Import of raw data and estimation of arrival and departure years

### Packages for this section

```{r}

library(tidyverse)

```

## Data import and descriptive statistics

```{r}
data <- read.delim("data_20220527.txt", sep ="\t") #import raw dataset

# number of unique individuals, (total sample size)
data %>% distinct(IDp) %>% count()
```

#### Missing birth and marriage locations

```{r}

data %>% 
  distinct(IDp,.keep_all = T) %>% 
  count(!is.na(cregcode))

data %>%
  distinct(IDp, .keep_all = T) %>% 
  count(!is.na(sregcode))

```

#### Missing birth and death years

```{r}

data %>% count(!is.na(byear))
data %>% count(!is.na(dyear))

```

#### Dispersal between each parishes

```{r}
data %>% filter(cregcode=="GL03") %>% count(sregcode)
data %>% filter(cregcode=="GL09") %>% count(sregcode)
```

#### Age of Adulthood estimation

Defined as the fifth percentile age at first reproduction. Here broken down by sex

```{r}

data %>% 
  group_by(sex) %>% 
  summarise(afr_5thp=as.numeric(quantile(afr,0.05,na.rm = T)))
# fifth percentile age at first reproduction

data %>% 
  group_by(sex) %>% 
  summarise(afr_med=as.numeric(quantile(afr,0.5,na.rm = T)))

adulthood <- data %>% 
  summarise(afr_5thp=as.numeric(quantile(afr,0.05,na.rm = T))) %>% 
  as.numeric()
# fifth percentile age at first reproduction

data %>% 
  summarise(afr_med=as.numeric(quantile(afr,0.5,na.rm = T)))

```

#### Basic descriptive variables

```{r}

data %>% 
  drop_na(lifespan) %>% 
  summarise(median=median(lifespan))

data %>% 
  drop_na(lifespan) %>% 
  count(lifespan>5)


data %>% 
    drop_na(lrs) %>% 
   summarise(median=median(lrs),max=max(lrs))

data %>% 
    drop_na(lrs,sex) %>% 
  group_by(sex) %>% 
   summarise(median=median(lrs),max=max(lrs))

data %>% 
    drop_na(lrs) %>% 
   count(lrs<1)

```

## Pedigree statistics

### Installing packages

```{r}

library(genetics)
library(kinship2)
library(MCMCglmm)
library(MasterBayes)

packageurl <- "https://cran.r-project.org/src/contrib/Archive/pedantics/pedantics_1.7.tar.gz"
install.packages(packageurl, repos=NULL, type="source")
library(pedantics)
```
### Fixing pedigree with pedantics and generating pedigree statistics

```{r}

ped <- data %>%
  rename(id=IDp) %>% 
  rename(dam=IDm) %>%
  rename(sire=IDf)

ped <- ped %>% dplyr::select(id,dam,sire)

ped.fixed <- fixPedigree(Ped=ped[,1:3])
head(ped.fixed)

ped.stats <- pedigreeStats(Ped=ped.fixed, lowMem=TRUE, graphicalReport = "n")

pedStatSummary(ped.stats)

hist.default(ped.stats$inbreedingCoefficients)

```

#### Known never to have married

```{r}
data %>% count(unmarried)
```

## Estimating arrival and departure years

The first task is to estimate when individuals were present in the population of elmthal and therefore were making genetic contributions. This involves estimating an arrival year (when the individual first appeared in the population) and departure year (when the individual left the population). For fully residential individuals, this would be their birth and death years, respectively.

I will use 4 variables to help estimate when individuals arrived and departed the population: **byear **(birth year), **dyear** (death year), **cregcode** (the town in which their birth was registered), **sregcode** (the town in which their offspring births were registered).

The full dataset contains individuals from all accross Glarus. I am focusing on individuals from the parishes of Linthal and Elm. I will do these separately for both parishes. I will now import the dataset and subset for those who were either born or had children in lin (c/sregcode=GL03).

### Linthal

*lin = Linthal

```{r import_and_subset}

data_lin <- data[data$cregcode=="GL09"|data$sregcode=="GL09",] # subset for only individuals who were born or had family in lin (i.e. have a recorded appearance in the population)

data_lin <-  data_lin[!is.na(data_lin$IDp)==T,] #this also removes rows that are blank and should be ignored (ID is used for this because every row must have an ID by definition)

data_lin %>% count(is.na(byear))
# Removed individuals with no byear
data_lin <-  data_lin[!is.na(data_lin$byear)==T,]

# I will also add a 10 year and 20 year cohort variable
first_byear <- min(data_lin$byear,na.rm = T)
last_byear <- max(data_lin$byear,na.rm = T)

first_dyear <- min(data_lin$dyear,na.rm = T)
last_dyear <- max(data_lin$dyear,na.rm = T)

data_lin$bcohort.20 <- cut(data_lin$byear,seq(first_byear-1,first_byear+459,20))
data_lin$bcohort.10 <- cut(data_lin$byear,seq(first_byear-1,first_byear+449,10))

sex.bcohort10.lifespan <- data_lin %>% 
  group_by(bcohort.10,sex) %>% 
  summarise(predicted_lifespan=median(lifespan,na.rm = T)) %>% 
  drop_na(bcohort.10,sex)

bcohort10.lifespan <- data_lin %>% 
  group_by(bcohort.10) %>% 
  summarise(predicted_lifespan=median(lifespan,na.rm = T)) %>% 
  drop_na(bcohort.10)
bcohort10.lifespan$sex <- NA

bcohort10.lifespan_tojoin <- rbind(bcohort10.lifespan,sex.bcohort10.lifespan)

data_lin<- left_join(data_lin, bcohort10.lifespan_tojoin, by = c("sex"="sex", "bcohort.10"="bcohort.10"))

```

#### Predicting dyear for missing data

First I need to predict the death year for individuals without a recorded death year.

There are more death years missing in the final years.

```{r}

data_lin %>% 
  count(byear,is.na(dyear)) %>% 
  ggplot(aes(x=byear, y=n,fill=`is.na(dyear)`), fill="steelblue") +
  geom_density(stat="identity", width=0.8,alpha=0.3) +
  theme_bw() +
  ylim(c(0,110))+
  theme(axis.line = element_line(colour = "black"), 
        axis.line.x.bottom = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 10, angle = 0, family = "serif")) +
  theme(legend.position = "top",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="bold")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="bold", lineheight = 0.5))

```

This is because they are still alive. For these I will need to set them to still be alive at the final death year (the end of the study period). I will estimate the individuals who are still alive if the fall within the one [sex specific median lifespan for the 1910-1920 cohort] of the study end year].

The lifespans are variable over time and sex specific. To get an estimate of lifespan for these individuals I will use the lifespan of individuals from the 1910-1920 cohort. This is the most recent cohort estimate available before the decline in lifespan due to censoring. 

For the remaining death years that are unknown I will uses the cohort and sex specific median lifespan.

```{r}

ls.1910_20_male <- sex.bcohort10.lifespan$predicted_lifespan[sex.bcohort10.lifespan$bcohort.10=="(1.91e+03,1.92e+03]" & sex.bcohort10.lifespan$sex=="M"]
ls.1910_20_female <- sex.bcohort10.lifespan$predicted_lifespan[sex.bcohort10.lifespan$bcohort.10=="(1.91e+03,1.92e+03]" & sex.bcohort10.lifespan$sex=="F"]
ls.1910_20_unsexed <- bcohort10.lifespan$predicted_lifespan[bcohort10.lifespan$bcohort.10=="(1.91e+03,1.92e+03]"]

data_lin %>%
  drop_na(lifespan) %>% 
  group_by(bcohort.10,sex) %>% 
  summarise(median.ls=median(lifespan),sd.ls=sd(lifespan)) %>% 
  ggplot(aes(x=bcohort.10, y=median.ls, color=sex)) +
  geom_point(size=1,position=position_dodge(.9))  +
  geom_errorbar(aes(ymin=median.ls-1.96*sd.ls, ymax=median.ls+1.96*sd.ls), width=.2,
                 position=position_dodge(.9)) +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"), 
        axis.line.x.bottom = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 16, angle = 90, family = "serif")) +
  theme(legend.position = "right",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="bold")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="bold", lineheight = 0.5))

# Assinging is.dyear.known class
for(i in seq_along(data_lin$IDp)) {
  crr <- data_lin[i,]
  if(is.na(crr$dyear)==F) {data_lin$is.dyear.known[i]<-"yes"}
    else{if(is.na(crr$sex)==T & crr$byear>(last_byear-ls.1910_20_unsexed)) {data_lin$is.dyear.known[i]<-"no:incomplete_lifespan"} 
      else{if(is.na(crr$sex)==T & crr$byear<=(last_byear-ls.1910_20_unsexed)) {data_lin$is.dyear.known[i]<-"no:dyear_missing"} 
        else{if(crr$sex=="M" & crr$byear>(last_byear-ls.1910_20_male)) {data_lin$is.dyear.known[i]<-"no:incomplete_lifespan"} 
          else{if(crr$sex=="M" & crr$byear<=(last_byear-ls.1910_20_male)) {data_lin$is.dyear.known[i]<-"no:dyear_missing"} 
            else{if(crr$sex=="F" & crr$byear>(last_byear-ls.1910_20_female)) {data_lin$is.dyear.known[i]<-"no:incomplete_lifespan"} 
              else{data_lin$is.dyear.known[i]<-"no:dyear_missing"} 
            }
          }
        }
      }
    }
}

# check this has worked
summary(data_lin$byear[data_lin$is.dyear.known=="yes"])
summary(data_lin$byear[data_lin$is.dyear.known=="no:dyear_missing"])
summary(data_lin$byear[data_lin$is.dyear.known=="no:incomplete_lifespan"])

# predicting death year
for(i in seq_along(data_lin$IDp)) {
  crr <- data_lin[i,]
  if(crr$is.dyear.known=="yes") {data_lin$dyear.predicted[i]<-data_lin$dyear[i]}
    else{if(crr$is.dyear.known=="no:dyear_missing") {data_lin$dyear.predicted[i]<-(data_lin$byear[i]+data_lin$predicted_lifespan[i])}
      else{data_lin$dyear.predicted[i]<-last_dyear}}
}

# Check this has worked
hist.default(data_lin$dyear.predicted[data_lin$is.dyear.known=="no:dyear_missing"])
# Looks good

```

#### Estimating migrant status

To estimate arrival and departure years I am first going to estimate a migrant status for all lin individuals using the cregcode and sregcode. First I will do this for individuals we know the sregcode for.

The definitions for the classes of this are as follows:
- **resident**, born in the population and reproduced in the population
- **emmigrant**, born in the population but reproduced outside of the population
- **immigrant**, born outside of the population but reproduced inside of the population
- **sregcode unknown**, will class these after.

Some of these estamations rely on life history information from the population, therefore I will first estimate these parameters. I have defined these variables in order to best estimate the population size based on average. 

```{r}

for(i in seq_along(data_lin$IDp)) {
  crr <- data_lin[i,]
  if(is.na(crr$cregcode)==T & is.na(crr$sregcode)==T) {data_lin$migrantstatus[i]<-NA}
  else{if(is.na(crr$cregcode)==F & is.na(crr$sregcode)==T) {data_lin$migrantstatus[i]<-"sregcode_unknown"}
    else{if(is.na(crr$cregcode)==T & crr$sregcode=="GL09") {data_lin$migrantstatus[i]<-"immigrant"}
      else{if(crr$cregcode!="GL09" & crr$sregcode=="GL09") {data_lin$migrantstatus[i]<-"immigrant"}
          else{if(crr$cregcode=="GL09" & crr$sregcode!="GL09") {data_lin$migrantstatus[i]<-"emigrant"}
            else{if(crr$cregcode=="GL09" & crr$sregcode=="GL09") {data_lin$migrantstatus[i]<-"resident"}
              else{}}
        }
      }
      }
    }
}

summary(as.factor(data_lin$migrantstatus))

```

#### Sregcode unknown

When the marriage location is unknown, I class individuals as the following:

Definition	(Arrival year,	Departure year):
**Died in childhood**	- Any individual who’s lifespan is less than their sex specific 20-year cohort’s 5th percentile for AFR	(Birth year	Death year)
**Incomplete life history** -	Any individual who born after 1946	(Birth year,	Death year)
**Assumed migrant**	- All other individuals	(Birth year,Birth year + 18 (unless they die before the age of 18))

#### Adding Cohort-specific parameters

```{r}
# fifth percentile age at first reproduction
sex.bcohort20.afr_5thp <- data_lin %>% 
  group_by(bcohort.20,sex) %>% 
  summarise(afr_5thp=as.numeric(quantile(afr,0.05,na.rm = T))) %>% 
  drop_na(bcohort.20,sex)

bcohort20.afr_5thp <- data_lin %>% 
  group_by(bcohort.20) %>% 
  summarise(afr_5thp=as.numeric(quantile(afr,0.05,na.rm = T))) %>% 
  drop_na(bcohort.20)
bcohort20.afr_5thp$sex <- NA

bcohort20.afr_5thp_tojoin <- rbind(bcohort20.afr_5thp,sex.bcohort20.afr_5thp)

# extrapolate for missing cohorts
bcohort20.afr_5thp_tojoin$afr_5thp[22] <- bcohort20.afr_5thp_tojoin$afr_5thp[21]

bcohort20.afr_5thp_tojoin$afr_5thp[66] <- bcohort20.afr_5thp_tojoin$afr_5thp[62]
bcohort20.afr_5thp_tojoin$afr_5thp[64] <- bcohort20.afr_5thp_tojoin$afr_5thp[62]

bcohort20.afr_5thp_tojoin$afr_5thp[65] <- bcohort20.afr_5thp_tojoin$afr_5thp[63]

data_lin<- left_join(data_lin, bcohort20.afr_5thp_tojoin, by = c("sex"="sex", "bcohort.20"="bcohort.20"))

summary(data_lin$afr_5thp)

data_lin[is.na(data_lin$afr_5thp)==T,] # check this has worked

bcohort20.afr_5thp_tojoin

```

```{r}
# median age at first reproduction
sex.bcohort20.afr_median <- data_lin %>% 
  group_by(bcohort.20,sex) %>% 
  summarise(afr_median=median(afr,na.rm = T)) %>% 
  drop_na(bcohort.20,sex)

bcohort20.afr_median <- data_lin %>% 
  group_by(bcohort.20) %>% 
  summarise(afr_median=median(afr,na.rm = T)) %>% 
  drop_na(bcohort.20)


bcohort20.afr_median$sex <- NA

bcohort20.afr_median_tojoin <- rbind(bcohort20.afr_median,sex.bcohort20.afr_median)

# extrapolate for missing cohorts
bcohort20.afr_median_tojoin$afr_median[22] <- bcohort20.afr_median_tojoin$afr_median[21]

bcohort20.afr_median_tojoin$afr_median[66] <- bcohort20.afr_median_tojoin$afr_median[62]
bcohort20.afr_median_tojoin$afr_median[64] <- bcohort20.afr_median_tojoin$afr_median[62]

bcohort20.afr_median_tojoin$afr_median[65] <- bcohort20.afr_median_tojoin$afr_median[63]

data_lin<- left_join(data_lin, bcohort20.afr_median_tojoin, by = c("sex"="sex", "bcohort.20"="bcohort.20"))

summary(as.numeric(data_lin$afr_median))

bcohort20.afr_median_tojoin 

data_lin %>%
  drop_na(afr) %>% 
  group_by(bcohort.20,sex) %>% 
  summarise(median.afr=median(afr),sd.afr=sd(afr)) %>% 
  ggplot(aes(x=bcohort.20, y=median.afr, color=sex)) +
  geom_point(size=1,position=position_dodge(.9))  +
  geom_errorbar(aes(ymin=median.afr-1.96*sd.afr, ymax=median.afr+1.96*sd.afr), width=.2,
                 position=position_dodge(.9)) +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"), 
        axis.line.x.bottom = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 16, angle = 90, family = "serif")) +
  theme(legend.position = "right",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="bold")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="bold", lineheight = 0.5))


```


```{r}

data_lin %>% 
  count(byear,is.na(sregcode)) %>% 
  ggplot(aes(x=byear, y=n,fill=`is.na(sregcode)`), fill="steelblue") +
  geom_density(stat="identity", width=0.8,alpha=0.3) +
  theme_bw() +
  ylim(c(0,110))+
  theme(axis.line = element_line(colour = "black"), 
        axis.line.x.bottom = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 10, angle = 0, family = "serif")) +
  theme(legend.position = "top",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="bold")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="bold", lineheight = 0.5))

# Decline starts at around '47 also so will used that to determine incomplete life history individuals

for(i in seq_along(data_lin$IDp)) {
  crr <- data_lin[i,]
  if(crr$migrantstatus=="sregcode_unknown") 
    {if((crr$dyear.predicted-crr$byear)<crr$afr_5thp) {data_lin$migrantstatus[i]<-"died_in_childhood"}
      else{if(crr$byear>1946) {data_lin$migrantstatus[i]<-"incomplete_life_history"}
     else{data_lin$migrantstatus[i]<-"assumed_immigrant"}}    
    }
    else{}
}
summary(as.factor(data_lin$migrantstatus))


```

#### Assigning arrival and departure year

Now I will use these classses to assgin a arrival and departure year. These are assigned as follows

Resident	                Cregcode and Sregcode, both equal the study parish	(Birth year,	Death year)
Emigrant	                Cregcode equals the study parish; sregcode does not equal the study parish	(Birth year,	Birth year of first offspring outside of the parish)
Immigrant	                Cregcode does not equal the study parish; sregcode equals the study parish	(Birth year of first offspring outside of the parish,	Death year)
Died in childhood	        Any individual who’s lifespan is less than their sex specific 20-year cohort’s 5th percentile for AFR	(Birth year, Death year)
Incomplete life history	  Any individual who born after 1946	(Birth year, Death year)
Assumed migrant	          All other individuals	Birth year	(Birth year + 18 (unless they die before the age of 18))


```{r}

# Died in childhood
data_lin %>% 
  count(round(lifespan,0),is.na(sregcode)) %>% 
  ggplot(aes(x=`round(lifespan, 0)`, y=n,fill=`is.na(sregcode)`), fill="steelblue") +
  geom_density(stat="identity", width=0.8,alpha=0.3) +
  theme_bw() +
  ylim(c(0,1100)) +
  theme(axis.line = element_line(colour = "black"), 
        axis.line.x.bottom = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 10, angle = 0, family = "serif")) +
  theme(legend.position = "top",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="bold")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="bold", lineheight = 0.5))


data <- data[!is.na(data$byear),]
# Assigning Arrival year

for(i in seq_along(data_lin$IDp)) {
  crr <- data_lin[i,]
  if(crr$migrantstatus=="immigrant" & crr$sex=="F") {
            offspring <- data[data$IDm==crr$IDp & !is.na(data$IDm),]
            offspring <-  offspring[na.omit(offspring$cregcode=="GL09"),]
            if((length(offspring$byear)==0)==T) {data_lin$arryear[i]<-data_lin$byear[i]+data_lin$afr_median[i]}
      else{data_lin$arryear[i]<- min(na.omit(offspring$byear)) }}
              
  else{if(crr$migrantstatus=="immigrant" & crr$sex=="M") {
              offspring <- data[data$IDf==crr$IDp & !is.na(data$IDf),]
              offspring <-  offspring[na.omit(offspring$cregcode=="GL09"),]
                  if((length(offspring$byear)==0)==T) {data_lin$arryear[i]<-data_lin$byear[i]+data_lin$afr_median[i]}
      else{
              data_lin$arryear[i]<- min(na.omit(offspring$byear)) }}
                   else{data_lin$arryear[i]<-crr$byear} # for resident, emmigrant, died in childhood, assumed migrant, incomplete life history
            }
}

data_lin[is.infinite(data_lin$arryear),] # none

```


```{r}
migration_age <- 18

# Assigning departure year
for(i in seq_along(data_lin$IDp)) {
  crr <- data_lin[i,]
  if(crr$migrantstatus=="emigrant" & crr$sex=="F") {
            offspring <- data[data$IDm==crr$IDp & !is.na(data$IDm),]
            offspring <-  offspring[na.omit(!offspring$cregcode=="GL09"),]
            if((length(offspring$byear)==0)==T) {data_lin$depyear[i]<-data_lin$byear[i]+data_lin$afr_median[i]}
      else{
            data_lin$depyear[i]<- min(na.omit(offspring$byear)) }}
              else{if(crr$migrantstatus=="emigrant" & crr$sex=="M") {
              offspring <- data[data$IDf==crr$IDp & !is.na(data$IDf),]
              offspring <-  offspring[na.omit(!offspring$cregcode=="GL09"),]
                  if((length(offspring$byear)==0)==T) {data_lin$depyear[i]<-data_lin$byear[i]+data_lin$afr_median[i]}
      else{
              data_lin$depyear[i]<- min(na.omit(offspring$byear)) }}
                   else{if(crr$migrantstatus=="assumed_emigrant") {data_lin$depyear[i]<-crr$byear+ migration_age}
                     else{data_lin$depyear[i]<-crr$dyear.predicted} # for resident, immigrant, died in childhood, incomplete life history
                   }
              }
}
```


#### Sorting Negative immigrants

```{r}
# Check it all looks correct
data_lin$arr_dep_dif <- data_lin$depyear-data_lin$arryear

data_lin %>% group_by(migrantstatus) %>% summarise(mean=mean(arr_dep_dif))


data_lin %>% 
  group_by(migrantstatus) %>% 
  summarise(mean_presence=mean(arr_dep_dif),sd_presence=sd(arr_dep_dif)) %>% 
  ggplot(aes(x=migrantstatus, y=mean_presence)) +
  geom_point()+
    geom_errorbar(aes(ymin=mean_presence+1.96*sd_presence,ymax=mean_presence-1.96*sd_presence)) +
    theme_classic()

hist.default(data_lin$arr_dep_dif[data_lin$migrantstatus=="emigrant"])
hist.default(data_lin$arr_dep_dif[data_lin$migrantstatus=="resident"])
hist.default(data_lin$arr_dep_dif[data_lin$migrantstatus=="died_in_childhood"])
hist.default(data_lin$arr_dep_dif[data_lin$migrantstatus=="incomplete_life_history"])

immigrant_errors <- data_lin[data_lin$migrantstatus=="immigrant" & data_lin$arr_dep_dif<5,] # where I have predicted dyear for some of the immigrants the death year is smaller than when they reproduced first (negative arr_dep_dif). For these I will set their depyear for one more year than their arrival year

data_lin$depyear[data_lin$migrantstatus=="immigrant" & data_lin$arr_dep_dif<1] <- data_lin$arryear[data_lin$migrantstatus=="immigrant" & data_lin$arr_dep_dif<1]+1

# Check it all looks correct
data_lin$arr_dep_dif <- data_lin$depyear-data_lin$arryear

hist.default(data_lin$arr_dep_dif[data_lin$migrantstatus=="immigrant"])

```

#### Sorting multiplesreg individuals 

A few individuals (n=~450) have multiple family code locations, i.e. have reproduced with different spouses or in different towns.

All individuals that had multiple family codes were residents and emigrants, so I have classed them as emigrants and used the byear of first child outside population as departure year

``` {r multiplesreg}
# Assigning multiplesreg individuals
data_lin$multiplesreg <- duplicated(data_lin$IDp)
dup.ind<- as.data.frame(data_lin$IDp[data_lin$multiplesreg==TRUE])#this code includes individuals who have multiple rows but sregs are all the same (e.g. multiple wives)

dup.data <- data_lin[data_lin$IDp %in% dup.ind,]

dup.ind$multiplesreg <- TRUE

colnames(dup.ind) <- c("IDp","multiplesreg")

data_lin <- left_join(data_lin, dup.ind)

# So use this code, I first create a summary table of migrant statuses and I can then filter for those that have the same migrant status multiple times. To check what they are. In this case only emmigrants have multiple so it is fine to use the loop below.
count.mst <- dup.data %>%
  count(IDp,migrantstatus) %>%
  arrange(IDp)

count.moves <- data_lin %>%
  filter(multiplesreg==TRUE) %>%
  count(IDp)

count.mst<-left_join(count.mst,count.moves, by="IDp")

count.mst %>% arrange(n.y)

count.mst <- count.mst %>%
  filter(!n.x==n.y)

for(i in seq_along(data_lin$IDp)) {
  if((data_lin$IDp[i] %in% count.mst$IDp)) {data_lin$multiplediffsreg[i] <- TRUE}
    else {data_lin$multiplediffsreg[i] <- FALSE}
}

# create unique individual df
data_lin_uni <- data_lin[data_lin$multiplesreg==FALSE,]

# Combining individual migrant statuses correctly for multiple regs
for(i in seq_along(data_lin_uni$IDp)) {
  id <- data_lin_uni$IDp[i]
  if(length(data_lin$multiplesreg[data_lin$IDp==id]>1)) {
    id.data <- data_lin[data_lin$IDp==id,]
    id.data <- id.data[id.data$migrantstatus=="emmigrant",]  ### This currently only works for emmigrant and resident combinations (the only combinations found with GL09)
    data_lin_uni$depyear[i] <- min(id.data$depyear)
  }
  else{
  }
}
sum(is.na(data_lin$arryear))
```
Now I am writing this to a csv.

``` {r }
data_lin_uni$arryear <- round(data_lin_uni$arryear,0)
data_lin_uni$depyear <- round(data_lin_uni$depyear,0)

# We have successfully predicted the arrival and departure years for all individuals.
data_lin_uni %>% count(!is.na(arryear))
data_lin_uni %>% count(!is.na(depyear))

write.csv(data_lin_uni,"data_lin_uni.csv")

```

### Elm

Now the same for the parish of Elm. (c/sregcode=GL03).


#### Estimating arrival and departure years for individuals

The first task is to estimate when individuals were present in the population of elm and therefore were making genetic contributions. This involves estimating an arrival year (when the individual first appeared in the population) and departure year (when the individual left the population). For fully residential individuals, this would be their birth and death years, respectively.

I will use 4 variables to help estimate when individuals arrived and departed the population: **byear**(birth year), **dyear** (death year), **cregcode** (the town in which their birth was registered), **sregcode** (the town in which their offspring births were registered).

The full dataset contains individuals from all across Glarus. I will now import the dataset and subset for those who were either born or had children in elm (c/sregcode=GL03).

```{r import_and_subset}

data_elm <- data[data$cregcode=="GL03"|data$sregcode=="GL03",] # subset for only individuals who were born or had family in elm (i.e. have a recorded appearance in the population)

data_elm <-  data_elm[!is.na(data_elm$IDp)==T,] #this also removes rows that are blank and should be ignored (ID is used for this because every row must have an ID by definition)

data_elm %>% count(is.na(byear))
# Removed individuals with no byear
data_elm <-  data_elm[!is.na(data_elm$byear)==T,]

# I will also add a 10 year and 20 year cohort variable
first_byear <- min(data_elm$byear,na.rm = T)
last_byear <- max(data_elm$byear,na.rm = T)

first_dyear <- min(data_elm$dyear,na.rm = T)
last_dyear <- max(data_elm$dyear,na.rm = T)

data_elm$bcohort.20 <- cut(data_elm$byear,seq(first_byear-1,first_byear+459,20))
data_elm$bcohort.10 <- cut(data_elm$byear,seq(first_byear-1,first_byear+449,10))

sex.bcohort10.lifespan <- data_elm %>% 
  group_by(bcohort.10,sex) %>% 
  summarise(predicted_lifespan=median(lifespan,na.rm = T)) %>% 
  drop_na(bcohort.10,sex)

bcohort10.lifespan <- data_elm %>% 
  group_by(bcohort.10) %>% 
  summarise(predicted_lifespan=median(lifespan,na.rm = T)) %>% 
  drop_na(bcohort.10)
bcohort10.lifespan$sex <- NA

bcohort10.lifespan_tojoin <- rbind(bcohort10.lifespan,sex.bcohort10.lifespan)

data_elm<- left_join(data_elm, bcohort10.lifespan_tojoin, by = c("sex"="sex", "bcohort.10"="bcohort.10"))

```

#### Predicting dyear for missing data

First I need to predict the death year for individuals without a recorded death year.

There are more death years missing in the final years.

```{r}

data_elm %>% 
  count(byear,is.na(dyear)) %>% 
  ggplot(aes(x=byear, y=n,fill=`is.na(dyear)`), fill="steelblue") +
  geom_density(stat="identity", width=0.8,alpha=0.3) +
  theme_bw() +
  ylim(c(0,110))+
  theme(axis.line = element_line(colour = "black"), 
        axis.line.x.bottom = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 10, angle = 0, family = "serif")) +
  theme(legend.position = "top",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="bold")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="bold", lineheight = 0.5))

```

This is because they are still alive. For these I will need to set them to still be alive at the final death year (the end of the study period). I will estimate the individuals who are still alive if the fall within the one [sex specific median lifespan for the 1910-1920 cohort] of the study end year].

The lifespans are variable over time and sex specific. To get an estimate of lifespan for these individuals I will use the lifespan of individuals from the 1910-1920 cohort. This is the most recent cohort estimate available before the decline in lifespan due to censoring. 

For the remaining death years that are unknown I will uses the cohort and sex specific median lifespan.

```{r}

ls.1910_20_male <- sex.bcohort10.lifespan$predicted_lifespan[sex.bcohort10.lifespan$bcohort.10=="(1.91e+03,1.92e+03]" & sex.bcohort10.lifespan$sex=="M"]
ls.1910_20_female <- sex.bcohort10.lifespan$predicted_lifespan[sex.bcohort10.lifespan$bcohort.10=="(1.91e+03,1.92e+03]" & sex.bcohort10.lifespan$sex=="F"]
ls.1910_20_unsexed <- bcohort10.lifespan$predicted_lifespan[bcohort10.lifespan$bcohort.10=="(1.91e+03,1.92e+03]"]

# pdf(file = "lifespan_sex_cohort.10.pdf",   # The directory you want to save the file in
#     width = 10, # The width of the plot in inches
#     height = 6) # The height of the plot in inches

data_elm %>%
  drop_na(lifespan) %>% 
  group_by(bcohort.10,sex) %>% 
  summarise(median.ls=median(lifespan),sd.ls=sd(lifespan)) %>% 
  ggplot(aes(x=bcohort.10, y=median.ls, color=sex)) +
  geom_point(size=1,position=position_dodge(.9))  +
  geom_errorbar(aes(ymin=median.ls-1.96*sd.ls, ymax=median.ls+1.96*sd.ls), width=.2,
                 position=position_dodge(.9)) +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"), 
        axis.line.x.bottom = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 16, angle = 90, family = "serif")) +
  theme(legend.position = "right",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="bold")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="bold", lineheight = 0.5))

# Assinging is.dyear.known class
for(i in seq_along(data_elm$IDp)) {
  crr <- data_elm[i,]
  if(is.na(crr$dyear)==F) {data_elm$is.dyear.known[i]<-"yes"}
    else{if(is.na(crr$sex)==T & crr$byear>(last_byear-ls.1910_20_unsexed)) {data_elm$is.dyear.known[i]<-"no:incomplete_lifespan"} 
      else{if(is.na(crr$sex)==T & crr$byear<=(last_byear-ls.1910_20_unsexed)) {data_elm$is.dyear.known[i]<-"no:dyear_missing"} 
        else{if(crr$sex=="M" & crr$byear>(last_byear-ls.1910_20_male)) {data_elm$is.dyear.known[i]<-"no:incomplete_lifespan"} 
          else{if(crr$sex=="M" & crr$byear<=(last_byear-ls.1910_20_male)) {data_elm$is.dyear.known[i]<-"no:dyear_missing"} 
            else{if(crr$sex=="F" & crr$byear>(last_byear-ls.1910_20_female)) {data_elm$is.dyear.known[i]<-"no:incomplete_lifespan"} 
              else{data_elm$is.dyear.known[i]<-"no:dyear_missing"} 
            }
          }
        }
      }
    }
}

# check this has worked
summary(data_elm$byear[data_elm$is.dyear.known=="yes"])
summary(data_elm$byear[data_elm$is.dyear.known=="no:dyear_missing"])
summary(data_elm$byear[data_elm$is.dyear.known=="no:incomplete_lifespan"])

# predicting death year
for(i in seq_along(data_elm$IDp)) {
  crr <- data_elm[i,]
  if(crr$is.dyear.known=="yes") {data_elm$dyear.predicted[i]<-data_elm$dyear[i]}
    else{if(crr$is.dyear.known=="no:dyear_missing") {data_elm$dyear.predicted[i]<-(data_elm$byear[i]+data_elm$predicted_lifespan[i])}
      else{data_elm$dyear.predicted[i]<-last_dyear}}
}

# Check this has worked
hist.default(data_elm$dyear.predicted[data_elm$is.dyear.known=="no:dyear_missing"])
# Looks good

```

#### Estimating migrant status

To estimate arrival and departure years I am first going to estimate a migrant status for all elm individuals using the cregcode and sregcode. First I will do this for individuals we know the sregcode for.

The definitions for the classes of this are as follows:
- **resident**, born in the population and reproduced in the population
- **emmigrant**, born in the population but reproduced outside of the population
- **immigrant**, born outside of the population but reproduced inside of the population
- **sregcode unknown**, will class these after.

Some of these estamations rely on life history information from the population, therefore I will first estimate these parameters. I have defined these variables in order to best estimate the population size based on average. 

```{r}

for(i in seq_along(data_elm$IDp)) {
  crr <- data_elm[i,]
  if(is.na(crr$cregcode)==T & is.na(crr$sregcode)==T) {data_elm$migrantstatus[i]<-NA}
  else{if(is.na(crr$cregcode)==F & is.na(crr$sregcode)==T) {data_elm$migrantstatus[i]<-"sregcode_unknown"}
    else{if(is.na(crr$cregcode)==T & crr$sregcode=="GL03") {data_elm$migrantstatus[i]<-"immigrant"}
      else{if(crr$cregcode!="GL03" & crr$sregcode=="GL03") {data_elm$migrantstatus[i]<-"immigrant"}
          else{if(crr$cregcode=="GL03" & crr$sregcode!="GL03") {data_elm$migrantstatus[i]<-"emigrant"}
            else{if(crr$cregcode=="GL03" & crr$sregcode=="GL03") {data_elm$migrantstatus[i]<-"resident"}
              else{}}
        }
      }
      }
    }
}

summary(as.factor(data_elm$migrantstatus))

```

#### Cregcode unknown

Definition	(Arrival year,	Departure year):
**Died in childhood**	- Any individual who’s lifespan is less than their sex specific 20-year cohort’s 5th percentile for AFR	(Birth year	Death year)
**Incomplete life history** -	Any individual who born after 1946	(Birth year,	Death year)
**Assumed migrant**	- All other individuals	(Birth year,Birth year + 18 (unless they die before the age of 18))

#### Adding Cohort-specific parameters

```{r}
# fifth percentile age at first reproduction
sex.bcohort20.afr_5thp <- data_elm %>% 
  group_by(bcohort.20,sex) %>% 
  summarise(afr_5thp=as.numeric(quantile(afr,0.05,na.rm = T))) %>% 
  drop_na(bcohort.20,sex)

bcohort20.afr_5thp <- data_elm %>% 
  group_by(bcohort.20) %>% 
  summarise(afr_5thp=as.numeric(quantile(afr,0.05,na.rm = T))) %>% 
  drop_na(bcohort.20)
bcohort20.afr_5thp$sex <- NA

bcohort20.afr_5thp_tojoin <- rbind(bcohort20.afr_5thp,sex.bcohort20.afr_5thp)

# Extropolating... for missing data

# for the first 2 NA sex cohorts extropolating also as they seem unrealistic
bcohort20.afr_5thp_tojoin$afr_5thp[c(1,2)] <- bcohort20.afr_5thp_tojoin$afr_5thp[3]

# extrapolate for missing cohorts (late 20th century unsexed)
bcohort20.afr_5thp_tojoin$afr_5thp[c(22,23)] <- bcohort20.afr_5thp_tojoin$afr_5thp[21]

# early population
bcohort20.afr_5thp_tojoin$afr_5thp[c(24,25)] <- bcohort20.afr_5thp_tojoin$afr_5thp[27]
bcohort20.afr_5thp_tojoin$afr_5thp[26] <- bcohort20.afr_5thp_tojoin$afr_5thp[28]

# Late
bcohort20.afr_5thp_tojoin$afr_5thp[c(64,66)] <- bcohort20.afr_5thp_tojoin$afr_5thp[62]
bcohort20.afr_5thp_tojoin$afr_5thp[c(65,67)] <- bcohort20.afr_5thp_tojoin$afr_5thp[63]

data_elm<- left_join(data_elm, bcohort20.afr_5thp_tojoin, by = c("sex"="sex", "bcohort.20"="bcohort.20"))

summary(data_elm$afr_5thp)

data_elm[is.na(data_elm$afr_5thp)==T,] # check this has worked

bcohort20.afr_5thp_tojoin

```

```{r}
# median age at first reproduction
sex.bcohort20.afr_median <- data_elm %>% 
  group_by(bcohort.20,sex) %>% 
  summarise(afr_median=median(afr,na.rm = T)) %>% 
  drop_na(bcohort.20,sex)

bcohort20.afr_median <- data_elm %>% 
  group_by(bcohort.20) %>% 
  summarise(afr_median=median(afr,na.rm = T)) %>% 
  drop_na(bcohort.20)

################## TOOO SORRT - This note was put, not sure why

bcohort20.afr_median$sex <- NA

bcohort20.afr_median_tojoin <- rbind(bcohort20.afr_median,sex.bcohort20.afr_median)

# extrapolate for missing cohorts
bcohort20.afr_median_tojoin$afr_median[1] <- bcohort20.afr_median_tojoin$afr_median[2]

bcohort20.afr_median_tojoin$afr_median[c(22,23)] <- bcohort20.afr_median_tojoin$afr_median[21]
bcohort20.afr_median_tojoin$afr_median[c(64,66)] <- bcohort20.afr_median_tojoin$afr_median[62]
bcohort20.afr_median_tojoin$afr_median[c(67,65)] <- bcohort20.afr_median_tojoin$afr_median[63]

bcohort20.afr_median_tojoin$afr_median[c(24)] <- bcohort20.afr_median_tojoin$afr_median[25]

data_elm<- left_join(data_elm, bcohort20.afr_median_tojoin, by = c("sex"="sex", "bcohort.20"="bcohort.20"))

summary(as.numeric(data_elm$afr_median))

bcohort20.afr_median_tojoin 

# pdf(file = "afr_sex_cohort.20.pdf",   # The directory you want to save the file in
#     width = 10, # The width of the plot in inches
#     height = 6) # The height of the plot in inches

data_elm %>%
  drop_na(afr) %>% 
  group_by(bcohort.20,sex) %>% 
  summarise(median.afr=median(afr),sd.afr=sd(afr)) %>% 
  ggplot(aes(x=bcohort.20, y=median.afr, color=sex)) +
  geom_point(size=1,position=position_dodge(.9))  +
  geom_errorbar(aes(ymin=median.afr-1.96*sd.afr, ymax=median.afr+1.96*sd.afr), width=.2,
                 position=position_dodge(.9)) +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"), 
        axis.line.x.bottom = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 16, angle = 90, family = "serif")) +
  theme(legend.position = "right",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="bold")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="bold", lineheight = 0.5))


```


```{r}

# pdf(file = "known_unknown_sregcode_byear.pdf",   # The directory you want to save the file in
#     width = 10, # The width of the plot in inches
#     height = 6) # The height of the plot in inches

data_elm %>% 
  count(byear,is.na(sregcode)) %>% 
  ggplot(aes(x=byear, y=n,fill=`is.na(sregcode)`), fill="steelblue") +
  geom_density(stat="identity", width=0.8,alpha=0.3) +
  theme_bw() +
  ylim(c(0,110))+
  theme(axis.line = element_line(colour = "black"), 
        axis.line.x.bottom = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 10, angle = 0, family = "serif")) +
  theme(legend.position = "top",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="bold")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="bold", lineheight = 0.5))

# Decline starts at around 47 also (same as linthal) so will used that to determine incomplete life history individuals

for(i in seq_along(data_elm$IDp)) {
  crr <- data_elm[i,]
  if(crr$migrantstatus=="sregcode_unknown") 
    {if((crr$dyear.predicted-crr$byear)<crr$afr_5thp) {data_elm$migrantstatus[i]<-"died_in_childhood"}
      else{if(crr$byear>1946) {data_elm$migrantstatus[i]<-"incomplete_life_history"}
     else{data_elm$migrantstatus[i]<-"assumed_immigrant"}}    
    }
    else{}
}
summary(as.factor(data_elm$migrantstatus))


```

#### Assigning arrival and departure year

Now I will use these classses to assgin a arrival and departure year. These are assigned as follows

Resident	                Cregcode and Sregcode, both equal the study parish	(Birth year,	Death year)
Emigrant	                Cregcode equals the study parish; sregcode does not equal the study parish	(Birth year,	Birth year of first offspring outside of the parish)
Immigrant	                Cregcode does not equal the study parish; sregcode equals the study parish	(Birth year of first offspring outside of the parish,	Death year)
Died in childhood	        Any individual who’s lifespan is less than their sex specific 20-year cohort’s 5th percentile for AFR	(Birth year, Death year)
Incomplete life history	  Any individual who born after 1946	(Birth year, Death year)
Assumed migrant	          All other individuals	Birth year	(Birth year + 18 (unless they die before the age of 18))


```{r}

# Died in childhood
# pdf(file = "known_unknown_sregcode_lifespan.pdf",   # The directory you want to save the file in
#     width = 10, # The width of the plot in inches
#     height = 6) # The height of the plot in inches

data_elm %>% 
  count(round(lifespan,0),is.na(sregcode)) %>% 
  ggplot(aes(x=`round(lifespan, 0)`, y=n,fill=`is.na(sregcode)`), fill="steelblue") +
  geom_density(stat="identity", width=0.8,alpha=0.3) +
  theme_bw() +
  ylim(c(0,1100)) +
  theme(axis.line = element_line(colour = "black"), 
        axis.line.x.bottom = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 10, angle = 0, family = "serif")) +
  theme(legend.position = "top",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="bold")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="bold", lineheight = 0.5))


# Assigning Arrival year

for(i in seq_along(data_elm$IDp)) {
  crr <- data_elm[i,]
  if(crr$migrantstatus=="immigrant" & crr$sex=="F") {
            offspring <- data[data$IDm==crr$IDp & !is.na(data$IDm),]
            offspring <-  offspring[na.omit(offspring$cregcode=="GL03"),]
            if((length(offspring$byear)==0)==T) {data_elm$arryear[i]<-data_elm$byear[i]+data_elm$afr_median[i]}
      else{data_elm$arryear[i]<- min(na.omit(offspring$byear)) }}
              
  else{if(crr$migrantstatus=="immigrant" & crr$sex=="M") {
              offspring <- data[data$IDf==crr$IDp & !is.na(data$IDf),]
              offspring <-  offspring[na.omit(offspring$cregcode=="GL03"),]
                  if((length(offspring$byear)==0)==T) {data_elm$arryear[i]<-data_elm$byear[i]+data_elm$afr_median[i]}
      else{
              data_elm$arryear[i]<- min(na.omit(offspring$byear)) }}
                   else{data_elm$arryear[i]<-crr$byear} # for resident, emmigrant, died in childhood, assumed migrant, incomplete life history
            }
}

data_elm[is.infinite(data_elm$arryear),] # not sure why these are here.

# All immigrants, so make arr_year = afr_median for cohort
data_elm$arryear[is.infinite(data_elm$arryear)] <- data_elm$byear[is.infinite(data_elm$arryear)]+data_elm$afr_median[is.infinite(data_elm$arryear)]

```

```{r}
migration_age <- 18

# Assigning departure year
for(i in seq_along(data_elm$IDp)) {
  crr <- data_elm[i,]
  if(crr$migrantstatus=="emigrant" & crr$sex=="F") {
            offspring <- data[data$IDm==crr$IDp & !is.na(data$IDm),]
            offspring <-  offspring[na.omit(!offspring$cregcode=="GL03"),]
            if((length(offspring$byear)==0)==T) {data_elm$depyear[i]<-data_elm$byear[i]+data_elm$afr_median[i]}
      else{
            data_elm$depyear[i]<- min(na.omit(offspring$byear)) }}
              else{if(crr$migrantstatus=="emigrant" & crr$sex=="M") {
              offspring <- data[data$IDf==crr$IDp & !is.na(data$IDf),]
              offspring <-  offspring[na.omit(!offspring$cregcode=="GL03"),]
                  if((length(offspring$byear)==0)==T) {data_elm$depyear[i]<-data_elm$byear[i]+data_elm$afr_median[i]}
      else{
              data_elm$depyear[i]<- min(na.omit(offspring$byear)) }}
                   else{if(crr$migrantstatus=="assumed_emigrant") {data_elm$depyear[i]<-crr$byear+ migration_age}
                     else{data_elm$depyear[i]<-crr$dyear.predicted} # for resident, immigrant, died in childhood, incomplete life history
                   }
              }
}
```

#### Sorting Negative immigrants

```{r}
# Check it all looks correct
data_elm$arr_dep_dif <- data_elm$depyear-data_elm$arryear

data_elm %>% group_by(migrantstatus) %>% summarise(mean=mean(arr_dep_dif))


# pdf(file = "elm_migrant_status_present_length_plot.pdf",   # The directory you want to save the file in
#     width = 12, # The width of the plot in inches
#     height = 7.5) # The height of the plot in inches

data_elm %>% 
  group_by(migrantstatus) %>% 
  summarise(mean_presence=mean(arr_dep_dif),sd_presence=sd(arr_dep_dif)) %>% 
  ggplot(aes(x=migrantstatus, y=mean_presence)) +
  geom_point()+
    geom_errorbar(aes(ymin=mean_presence+1.96*sd_presence,ymax=mean_presence-1.96*sd_presence)) +
    theme_classic()

hist.default(data_elm$arr_dep_dif[data_elm$migrantstatus=="emigrant"])
hist.default(data_elm$arr_dep_dif[data_elm$migrantstatus=="resident"])
hist.default(data_elm$arr_dep_dif[data_elm$migrantstatus=="died_in_childhood"])
hist.default(data_elm$arr_dep_dif[data_elm$migrantstatus=="incomplete_life_history"])

immigrant_errors <- data_elm[data_elm$migrantstatus=="immigrant" & data_elm$arr_dep_dif<5,] # where I have predicted dyear for some of the immigrants the death year is smaller than when they reproduced first (negative arr_dep_dif). For these I will set their depyear for one more year than their arrival year

data_elm$depyear[data_elm$migrantstatus=="immigrant" & data_elm$arr_dep_dif<1] <- data_elm$arryear[data_elm$migrantstatus=="immigrant" & data_elm$arr_dep_dif<1]+1

# Check it all looks correct
data_elm$arr_dep_dif <- data_elm$depyear-data_elm$arryear

hist.default(data_elm$arr_dep_dif[data_elm$migrantstatus=="immigrant"])

```


#### Sorting multiplesreg individuals 

A few individuals (n=~450) have multiple family code locations, i.e. have reproduced with different spouses or in different towns.

All individuals that had multiple family codes were residents and emigrants, so I have classed them as emigrants and used the byear of first child outside population as departure year

``` {r multiplesreg}
# Assigning multiplesreg individuals
data_elm$multiplesreg <- duplicated(data_elm$IDp)
dup.ind<- as.data.frame(data_elm$IDp[data_elm$multiplesreg==TRUE])#this code includes individuals who have multiple rows but sregs are all the same (e.g. multiple wives)

dup.data <- data_elm[data_elm$IDp %in% dup.ind,]

dup.ind$multiplesreg <- TRUE

colnames(dup.ind) <- c("IDp","multiplesreg")

data_elm <- left_join(data_elm, dup.ind)

# So use this code, I first create a summary table of migrant statuses and I can then filter for those that have the same migrant status multiple times. To check what they are. In this case only emmigrants have multiple so it is fine to use the loop below.
count.mst <- dup.data %>%
  count(IDp,migrantstatus) %>%
  arrange(IDp)

count.moves <- data_elm %>%
  filter(multiplesreg==TRUE) %>%
  count(IDp)

count.mst<-left_join(count.mst,count.moves, by="IDp")

count.mst %>% arrange(n.y)

count.mst <- count.mst %>%
  filter(!n.x==n.y)

for(i in seq_along(data_elm$IDp)) {
  if((data_elm$IDp[i] %in% count.mst$IDp)) {data_elm$multiplediffsreg[i] <- TRUE}
    else {data_elm$multiplediffsreg[i] <- FALSE}
}

# create unique individual df
data_elm_uni <- data_elm[data_elm$multiplesreg==FALSE,]

# Combining individual migrant statuses correctly for multiple regs
for(i in seq_along(data_elm_uni$IDp)) {
  print(i)
  id <- data_elm_uni$IDp[i]
  if(data_elm$multiplesreg[data_elm$IDp==id]==TRUE) {
    id.data <- data_elm[data_elm$IDp==id,]
    id.data <- id.data[id.data$migrantstatus=="emmigrant",]  ### This currently only works for emmigrant and resident combinations (the only combinations found with GL03)
    data_elm_uni$depyear[i] <- min(id.data$depyear)
  }
  else{
  }
}
sum(is.na(data_elm$arryear))
```

``` {r save file}
data_elm_uni$arryear <- round(data_elm_uni$arryear,0)
data_elm_uni$depyear <- round(data_elm_uni$depyear,0)

# We have successfully predicted the arrival and departure years for all individuals.
data_elm_uni %>% count(!is.na(arryear))
data_elm_uni %>% count(!is.na(depyear))

write.csv(data_elm_uni,"data_elm_uni.csv")

```


## Statistics for SUPM1

```{r}

data_elm_uni <- read.csv("data_elm_uni.csv")
data_lin_uni <- read.csv("data_lin_uni.csv")

nrow(data_elm_uni)
data_elm_uni %>% count(is.na(cregcode))
data_elm_uni %>% filter(!migrantstatus=="died_in_childhood"&!migrantstatus=="incomplete_life_history") %>% 
  count(is.na(sregcode))
data_elm_uni %>% count(is.na(dyear))

data_elm_uni %>% 
  count(is.dyear.known)

data_elm_uni %>%count(migrantstatus)


data_elm_uni <- read.csv("data_elm_uni.csv")
data_lin_uni <- read.csv("data_lin_uni.csv")

nrow(data_lin_uni)
data_lin_uni %>% count(is.na(cregcode))
data_lin_uni %>% filter(!migrantstatus=="died_in_childhood"&!migrantstatus=="incomplete_life_history") %>% 
  count(is.na(sregcode))
data_lin_uni %>% count(is.na(dyear))

data_lin_uni %>% 
  count(is.dyear.known)

data_lin_uni %>% 
  filter(cregcode=="GL03") %>% 
  count(sregcode=="GL03")

data_lin_uni %>%count(migrantstatus)

```


# 2. Pedigree-based estimation of IGC

We thank Darren Hunter for providing the initial code for the pedigree-based estimation of expected genetic contributions

## Elm

#### Subsetting pedigree for informative individuals

The model for estimating the genetic contributions is VERY intensive. And this is somewhat dependent on the size of the pedigree (though the number of years in the dataset is also a big dependency - however that is something I can't do anything about!). Therefore to make the computation quicker, I have subset the pedigree separately for both Elm and Linthal to include only individuals that are ancestors or descendants of those individuals we are interested in (in the data_elm_uni/data_lin_uni datafiles). I have done this using the visPedigree package).

```{r}
library(visPedigree)
ped <- read.delim("data_20220527.txt", sep ="\t")
ped <- ped[,c("IDp","IDf","IDm")] # Rows for each individual with mother and father IDs.
ped <- ped %>% distinct(IDp,.keep_all = T) # Make sure these are all unique rows or the prepped function will not work

tidyped <- tidyped(ped)

elmID <- data_elm_uni$IDp

informative_IDs_elm <- unique(tidyped(ped=tidyped,cand=elmID,trace="all")$Ind)

saveRDS(informative_IDs_elm,"informative_IDs_elm.rds")

```

### Females

Females and males are calculated separately.

#### Importing the data

```{r}

##### Packages

library("nadiv") #for creating the additive genetic relatedness matrix

###### Importing data
# First I must import the arrivial/departure information individuals for each individual in the population of interest

# Pedigree
ped <- read.delim("data_20220527.txt", sep ="\t")
ped <- ped[,c("IDp","IDf","IDm")] # Rows for each individual with mother and father IDs.
ped <- ped %>% distinct(IDp,.keep_all = T) # Make sure these are all unique rows or the prepped function will not work (this removes individuals who have multiple marriages, and therefore appear multiple times in the pedigree, their IDf and IDm will remain the same however so these duplicated rows can be removed

# arrival/departure information
data_elm_uni <- read.csv(file = "data_elm_uni.csv")

data_elm_uni <- data_elm_uni[,c("IDp","sex","arryear","depyear")] # only the columns I need for the analysis.
data_elm_uni <- data_elm_uni %>% distinct(IDp,sex,arryear,depyear) # again, make sure these are all unique rows (however this should not be neccessary, just a precaution)

Ped <- left_join(ped, data_elm_uni[,c("IDp","arryear","depyear")], by="IDp")

informative_IDs_elm <- readRDS("informative_IDs_elm.rds")

Ped <- Ped[Ped$IDp %in% informative_IDs_elm,]

Ped <- as.data.frame(Ped)

```


#### Preparing dataframes to be filled by model

```{r}
## Firstly I must establish when the loop/model will be ran from.

# For the focal years, I only want these to run for when there are individuals arriving in the population (there are just a few gaps early on)
years_arrival<- sort(unique(data_elm_uni$arryear[data_elm_uni$sex == "F" & !is.na(data_elm_uni$sex)]))

# And these should be tracked for all subsequent years
Female_min_arry <- min(na.omit(data_elm_uni$arryear[data_elm_uni$sex == "F"])) # set the years from with the genetic contributions will be ran from
Female_max_arry <- max(na.omit(data_elm_uni$arryear[data_elm_uni$sex == "F"]))
years <- Female_min_arry:Female_max_arry

years3<-years[1:length(years)]
years<-years[1:length(years)-1]


### Dataframes for storing model info

# Get number of years
length_years<-length(years)

All_Alive_BS<-vector("list", length(years)) # Create vector which lists individuals alive each year

### Create datafame to hold total genetic contributions for each cohort
# I am making the assumption that "cohort" for humans is 1 year, this can be grouped to a lower resolution at a later time

# Dataframe to hold Cohort genetic contributions
Female_Cohort_GenCon<-as.data.frame(matrix(NA,length_years,length_years))

### Create datafame to hold total genetic contributions individuals alive each year
Female_All_Alive_GenCon<-as.data.frame(matrix(NA,length_years,length_years))
names(Female_All_Alive_GenCon)<-paste("Y",years[1:length_years],sep="")

### Create a list to hold individual genetic contributions
afteryears.names<- paste("A", 0:(length_years-1) ,sep="")
afteryears <- vector("list", length(afteryears.names))
names(afteryears) <- afteryears.names

Female_Ind_GenCon<-rep(list(afteryears),length_years)
names(Female_Ind_GenCon)<-paste("Y",years[1:length_years],sep="")


saveRDS(Female_All_Alive_GenCon, file = "Elm_Female_All_Alive_GenCon.rds") # I have found it work best if you save the dfs as a RDS after each focal year is complete
saveRDS(Female_Cohort_GenCon, file = "Elm_Female_Cohort_GenCon.rds")
saveRDS(Female_Ind_GenCon, file = "Elm_Female_Ind_GenCon.rds")
```


#### The model to estimate pedigree-based genetic contributions

Now here is the model/loop that calculates the genetic contributions for all Female individuals and tracks them down each future year in the population

```{r}

for(x in 1:(length(years))){   ### for each year where individuals arrive
  y<-years[x]   ### get focal year
  Ped_Alt<-prepPed(Ped) ### prepare pedigree (sorts and adds founders - nadiv package)
  a<-as.character(na.omit(data_elm_uni$IDp[data_elm_uni$arryear==y & data_elm_uni$sex == "F"]))  ### select individuals arrive that year
  Alalive<-with(data_elm_uni,IDp[which(arryear<(y+1) & (depyear>y-1) & sex=="F")])  # Select all individuals alive that year (including
  # those born). Literal code translation= Arryear has happened & Depyear hasn't happened yet (and known)
  
  for(x2 in 1:length(years-1)){ ### For each year after focal year
    y2<-y+x2-1  ### get year (starting at the focal year)
    All_Alive_BS[[x2]]<-with(data_elm_uni,IDp[which(arryear<(y2+1) & depyear>(y2-1))])  ### get list of all individuals alive that year
  }
  
  Ped_Alt$IDm[Ped_Alt$arryear<=y]<-NA    ### ancestral information removed
  Ped_Alt$IDf[Ped_Alt$arryear<=y]<-NA   ### ancestral information removed
  
  mat<-makeA(Ped_Alt[1:3])    # create matrix with ancestors 
  matIDs<-as.character(row.names(mat))   ### Get ID's from matrix
  
  for(x3 in 1:length(years-1)){ ### For each subsequent year after focal year
    
    # get submatrix of only including focal cohort and all individuals alive in year
    matYb<-as.matrix(mat[as.character(c(matIDs[matIDs %in% a])),c(as.character(matIDs[matIDs %in% All_Alive_BS[[x3]]]))])
    # rows of focal individuals, columns of all individuals alive in the year "x3"
    
    # get submatrix of only including individuals alive in focal year and subsequent year
    AAmatYb<-as.matrix(mat[as.character(c(matIDs[matIDs %in% Alalive])),as.character(c(matIDs[matIDs %in% All_Alive_BS[[x3]]]))])
    # rows of alive individuals, columns of all individuals alive in the year "x3"
    
    Female_Cohort_GenCon[x3,x]<-sum(matYb) # Calculate total cohort genetic contribution
    
    Female_All_Alive_GenCon[[x3,x]]<-ifelse(y+x3<=max(years3),sum(AAmatYb),0) # Calculate the total genetic contribution of all individuals alive
    
    indvalues<- rowSums(matYb) # Sum up each individuals total genetic contributions
    
    Female_Ind_GenCon[[x]][[x3]]<-indvalues[as.character(a)] # Save the individuals genetic contributions according to focal year, subsequent year and ID
  }
  saveRDS(Female_All_Alive_GenCon, file = "Elm_Female_All_Alive_GenCon.rds") # I have found it work best if you save the dfs as a RDS after each focal year
  # is complete
  saveRDS(Female_Cohort_GenCon, file = "Elm_Female_Cohort_GenCon.rds")
  saveRDS(Female_Ind_GenCon, file = "Elm_Female_Ind_GenCon.rds")
  print(y)  ### print year - helps track progress of loop
}

```

### Males

#### Importing the data

```{r}

##### Packages

library("nadiv") #for creating the additive genetic relatedness matrix
library("tidyverse") # for some data sorting/handling

###### Importing data
# First I must import the arrival/departure information individuals for each individual in the population of interest

# Pedigree
ped <- read.delim("data_with_marriage.txt", sep ="\t")
ped <- ped[,c("IDp","IDf","IDm")] # Rows for each individual with mother and father IDs.
ped <- ped %>% distinct(IDp,.keep_all = T) # Make sure these are all unique rows or the prepped function will not work

# arrival/departure infomation
data_elm_uni <- read.csv(file = "data_elm_uni.csv")

data_elm_uni <- data_elm_uni[,c("IDp","sex","arryear","depyear")] # only the columns I need for the analysis.
data_elm_uni <- data_elm_uni %>% distinct(IDp,sex,arryear,depyear) # again, make sure these are all unique rows

Ped <- left_join(ped, data_elm_uni[,c("IDp","arryear","depyear")], by="IDp")
informative_IDs_elm <- readRDS("informative_IDs_elm.rds")

Ped <- Ped[Ped$IDp %in% informative_IDs_elm,]

Ped <- as.data.frame(Ped)

```

#### Preparing dataframes to be filled by model 

```{r}

#### Firstly I must establish when the loop/model will be ran from.

# For the focal years, I only want these to run for when there are individuals arriving in the population (there are just a few gaps early on)
years_arrival<- sort(unique(data_elm_uni$arryear[data_elm_uni$sex == "M" & !is.na(data_elm_uni$sex)]))

# And these should be tracked for all subsequent years
Male_min_arry <- min(na.omit(data_elm_uni$arryear[data_elm_uni$sex == "M"])) # set the years from with the genetic contributions will be ran from
Male_max_arry <- max(na.omit(data_elm_uni$arryear[data_elm_uni$sex == "M"]))
years <- Male_min_arry:Male_max_arry

years3<-years[1:length(years)]
years<-years[1:length(years)-1]


#### Dataframes for storing model info
#### Get number of years
length_years<-length(years)

All_Alive_BS<-vector("list", length(years)) # Create vector which lists individuals alive each year

### Create datafame to hold total genetic contributions for each cohort
# I am making the assumption that "cohort" for humans is 1 year, this can be grouped to a lower resolution at a later time

# Dataframe to hold Cohort genetic contributions
Male_Cohort_GenCon<-as.data.frame(matrix(NA,length_years,length_years))

### Create datafame to hold total genetic contributions individuals alive each year
Male_All_Alive_GenCon<-as.data.frame(matrix(NA,length_years,length_years))
names(Male_All_Alive_GenCon)<-paste("Y",years[1:length_years],sep="")

### Create a list to hold individual genetic contributions
afteryears.names<- paste("A", 0:(length_years-1) ,sep="")
afteryears <- vector("list", length(afteryears.names))
names(afteryears) <- afteryears.names

Male_Ind_GenCon<-rep(list(afteryears),length_years)
names(Male_Ind_GenCon)<-paste("Y",years[1:length_years],sep="")


saveRDS(Male_All_Alive_GenCon, file = "Elm_Male_All_Alive_GenCon.rds") # I have found it work best if you save the dfs as a RDS after each focal year
# is complete
saveRDS(Male_Cohort_GenCon, file = "Elm_Male_Cohort_GenCon.rds")
saveRDS(Male_Ind_GenCon, file = "Elm_Male_Ind_GenCon.rds")

```

#### The model

```{r}

# Now here is the model/loop that calculates the genetic contributions for all Male individuals and tracks them down each future year in the population

for(x in 1:(length(years))){   ### for each year where individuals arrrive
  y<-years[x]   ### get focal year
  Ped_Alt<-prepPed(Ped) ### prepare pedigree (sorts and adds founders - nadiv package)
  a<-as.character(na.omit(data_elm_uni$IDp[data_elm_uni$arryear==y & data_elm_uni$sex == "M"]))  ### select individuals arrive that year
  Alalive<-with(data_elm_uni,IDp[which(arryear<(y+1) & (depyear>y-1) & sex=="M")])  # Select all individuals alive that year (including
  # those born). Literal code translation= Arryear has happened & Depyear hasn't happened yet (and known)
  
  for(x2 in 1:length(years-1)){ ### For each year after focal year
    y2<-y+x2-1  ### get year (starting at the focal year)
    All_Alive_BS[[x2]]<-with(data_elm_uni,IDp[which(arryear<(y2+1) & depyear>(y2-1))])  ### get list of all individuals alive that year
  }
  
  Ped_Alt$IDm[Ped_Alt$arryear<=y]<-NA    ### ancestral information removed
  Ped_Alt$IDf[Ped_Alt$arryear<=y]<-NA   ### ancestral information removed
  
  mat<-makeA(Ped_Alt[1:3])    # create matrix with ancestors 
  matIDs<-as.character(row.names(mat))   ### Get ID's from matrix
  
  for(x3 in 1:length(years-1)){ ### For each subsequent year after focal year
    
    # get submatrix of only including focal cohort and all individuals alive in year
    matYb<-as.matrix(mat[as.character(c(matIDs[matIDs %in% a])),c(as.character(matIDs[matIDs %in% All_Alive_BS[[x3]]]))])
    # rows of focal individuals, columns of all individuals alive in the year "x3"
    
    # get submatrix of only including individuals alive in focal year and subsequent year
    AAmatYb<-as.matrix(mat[as.character(c(matIDs[matIDs %in% Alalive])),as.character(c(matIDs[matIDs %in% All_Alive_BS[[x3]]]))])
    # rows of alive individuals, columns of all individuals alive in the year "x3"
    
    Male_Cohort_GenCon[x3,x]<-sum(matYb) # Calculate total cohort genetic contribution
    
    Male_All_Alive_GenCon[[x3,x]]<-ifelse(y+x3<=max(years3),sum(AAmatYb),0) # Calculate the total genetic contribution of all individuals alive
    
    indvalues<- rowSums(matYb) # Sum up each individuals total genetic contributions
    
    Male_Ind_GenCon[[x]][[x3]]<-indvalues[as.character(a)] # Save the individuals genetic contributions according to focal year, subsequent year and ID
  }
  saveRDS(Male_All_Alive_GenCon, file = "Elm_Male_All_Alive_GenCon.rds") # I have found it work best if you save the dfs as a RDS after each focal year
  # is complete
  saveRDS(Male_Cohort_GenCon, file = "Elm_Male_Cohort_GenCon.rds")
  saveRDS(Male_Ind_GenCon, file = "Elm_Male_Ind_GenCon.rds")
  print(y)  ### print year - helps track progress of loop
}


```

### Cluster output collated

Data import and stitching is a bit awkward at the moment, but can be ignored if it has been done already once (hence why the code is #'ed). However, here is what I did to stitch the datafiles from separate cluster runs together

It is awkward because I had to stop my model running a couple of times (because it takes so long! ~25 days), save the output and restart from where I had previously got to. This means that the dataframes are different lengths because the dataframe length's are created based on the number of years between the first focal year and the final year. When I restarted the code running again, it started at a later year and therefore the subsequent data frames are shorter. THis has no impact on the results, but makes stitching together and running the dataframes a little more awkward. Especially for the indiviudal level data, where some birth cohorts have (e.g.) 402 years of data and others only have (e.g.) 302. (NAs dictate years in the future past the most recent population (e.g. the year 2040) - it would be easier if these just weren't created!). 

I have put some if/else statements within loops to help tackle this and though this solution is not perfect, it does seem to work. 

#### FEMALES

```{r}

# # Importing the datafiles from each run of the model
# Elm_Female_All_Alive_GenCon_1594_1693.rds <- readRDS(file = "Elm_Female_All_Alive_GenCon_1594-1693.rds")
# Elm_Female_Cohort_GenCon_1594_1693.rds <- readRDS(file = "Elm_Female_Cohort_GenCon_1594-1693.rds")
# Elm_Female_Ind_GenCon_1594_1693.rds <- readRDS(file = "Elm_Female_Ind_GenCon_1594-1693.rds")
# 
# Elm_Female_All_Alive_GenCon_1694.rds <- readRDS(file = "Elm_Female_All_Alive_GenCon_1694-.rds")
# Elm_Female_Cohort_GenCon_1694.rds <- readRDS(file = "Elm_Female_Cohort_GenCon_1694-.rds")
# Elm_Female_Ind_GenCon_1694.rds <- readRDS(file = "Elm_Female_Ind_GenCon_1694-.rds")
# 
# # I will tackle each "type" of datafile (all_alive, cohort, individual) separately.
# #### All_Alive_GenCon
# Elm_Female_All_Alive_GenCon_1594_1693.rds$row <- rownames(Elm_Female_All_Alive_GenCon_1594_1693.rds) #I assign a row number to each data set which will be used to match the two dataframes together with the "left_join()" function
# Elm_Female_All_Alive_GenCon_1594_1693.rds <- Elm_Female_All_Alive_GenCon_1594_1693.rds[,!is.na(Elm_Female_All_Alive_GenCon_1594_1693.rds[1,])] # I also remove all the years which the model did not reach during its run.
# 
# Elm_Female_All_Alive_GenCon_1694.rds$row <- rownames(Elm_Female_All_Alive_GenCon_1694.rds)
# 
# Elm_Female_All_Alive_GenCon_20210812 <- left_join(Elm_Female_All_Alive_GenCon_1594_1693.rds,Elm_Female_All_Alive_GenCon_1694.rds, by="row") # join the two dataframes
# 
# Elm_Female_All_Alive_GenCon_20210812 <- dplyr::select(Elm_Female_All_Alive_GenCon_20210812, -row) #remove the row column
# 
# Elm_Female_All_Alive_GenCon_20210812[is.na(Elm_Female_All_Alive_GenCon_20210812[,])] <- 0 # this is what the model normal produces instead of NAs, so I have repeated that here - an argument could be made that they should really be NAs but for the time beign I will keep them like this
# 
# #### Cohort_GenCon
# Elm_Female_Cohort_GenCon_1594_1693.rds$row <- rownames(Elm_Female_Cohort_GenCon_1594_1693.rds)
# Elm_Female_Cohort_GenCon_1594_1693.rds <- Elm_Female_Cohort_GenCon_1594_1693.rds[,!is.na(Elm_Female_Cohort_GenCon_1594_1693.rds[1,])]
# 
# colnames(Elm_Female_Cohort_GenCon_1694.rds) <- gsub("V","",colnames(Elm_Female_Cohort_GenCon_1694.rds)) #this part is slightly more awkward, I have to change the names of the second dataframe, increasing them by the number of years in the first ran dataframe. To do this, I must first remove the "V"s and then add on the number of years in the first dataframe before adding the V back in.
# colnames(Elm_Female_Cohort_GenCon_1694.rds) <- as.character(paste("V",as.numeric(colnames(Elm_Female_Cohort_GenCon_1694.rds))+(ncol(Elm_Female_Cohort_GenCon_1594_1693.rds)-1),sep = ""))
# 
# Elm_Female_Cohort_GenCon_1694.rds$row <- rownames(Elm_Female_Cohort_GenCon_1694.rds) # Joining by the same method.
# Elm_Female_Cohort_GenCon_20210812 <- left_join(Elm_Female_Cohort_GenCon_1594_1693.rds,Elm_Female_Cohort_GenCon_1694.rds, by="row")
# 
# Elm_Female_Cohort_GenCon_20210812 <- dplyr::select(Elm_Female_Cohort_GenCon_20210812, -row)
# 
# Elm_Female_Cohort_GenCon_20210812[is.na(Elm_Female_Cohort_GenCon_20210812[,])] <- 0
# 
# ## Ind_GenCon
# Elm_Female_Ind_GenCon_1594_1693.rds <- Elm_Female_Ind_GenCon_1594_1693.rds[c(1:100)] # Extract the first 100 (run) years
# Elm_Female_Ind_GenCon_20210812 <- c(Elm_Female_Ind_GenCon_1594_1693.rds, Elm_Female_Ind_GenCon_1694.rds) # Join together
# 
# rm(Elm_Female_All_Alive_GenCon_1594_1693.rds)
# rm(Elm_Female_Cohort_GenCon_1594_1693.rds)
# rm(Elm_Female_Ind_GenCon_1594_1693.rds)
# rm(Elm_Female_All_Alive_GenCon_1694.rds)
# rm(Elm_Female_Cohort_GenCon_1694.rds)
# rm(Elm_Female_Ind_GenCon_1694.rds)
# 
# write_rds(Elm_Female_All_Alive_GenCon_20210812,"Elm_Female_All_Alive_GenCon_20210812.rds")
# write_rds(Elm_Female_Cohort_GenCon_20210812,"Elm_Female_Cohort_GenCon_20210812.rds")
# write_rds(Elm_Female_Ind_GenCon_20210812,"Elm_Female_Ind_GenCon_20210812.rds")

# Once this has been done once (the assembled datafiles created), simply use... 

Elm_Female_All_Alive_GenCon_20210812 <- readRDS(file = "Elm_Female_All_Alive_GenCon_20210812.rds")
Elm_Female_Cohort_GenCon_20210812 <- readRDS(file = "Elm_Female_Cohort_GenCon_20210812.rds")
Elm_Female_Ind_GenCon_20210812 <- readRDS(file = "Elm_Female_Ind_GenCon_20210812.rds")
# I can provide the raw data files upon request
```

#### MALES

```{r}

# # Importing the datafiles from each run of the model
# Elm_Male_All_Alive_GenCon_1575_1657.rds <- readRDS(file = "Elm_Male_All_Alive_GenCon_1575-1657.rds")
# Elm_Male_Cohort_GenCon_1575_1657.rds <- readRDS(file = "Elm_Male_Cohort_GenCon_1575-1657.rds")
# Elm_Male_Ind_GenCon_1575_1657.rds <- readRDS(file = "Elm_Male_Ind_GenCon_1575-1657.rds")
# 
# Elm_Male_All_Alive_GenCon_1658.rds <- readRDS(file = "Elm_Male_All_Alive_GenCon_1658-.rds")
# Elm_Male_Cohort_GenCon_1658.rds <- readRDS(file = "Elm_Male_Cohort_GenCon_1658-.rds")
# Elm_Male_Ind_GenCon_1658.rds <- readRDS(file = "Elm_Male_Ind_GenCon_1658-.rds")
# 
# # I will tackle each "type" of datafile (all_alive, cohort, individual) separately.
# #### All_Alive_GenCon
# Elm_Male_All_Alive_GenCon_1575_1657.rds$row <- rownames(Elm_Male_All_Alive_GenCon_1575_1657.rds) #I assign a row number to each data set which will be used to match the two dataframes together with the "left_join()" function
# Elm_Male_All_Alive_GenCon_1575_1657.rds <- Elm_Male_All_Alive_GenCon_1575_1657.rds[,!is.na(Elm_Male_All_Alive_GenCon_1575_1657.rds[1,])] # I also remove all the years which the model did not reach during its run.
# 
# Elm_Male_All_Alive_GenCon_1658.rds$row <- rownames(Elm_Male_All_Alive_GenCon_1658.rds)
# 
# Elm_Male_All_Alive_GenCon_20210812 <- left_join(Elm_Male_All_Alive_GenCon_1575_1657.rds,Elm_Male_All_Alive_GenCon_1658.rds, by="row") # join the two dataframes
# 
# Elm_Male_All_Alive_GenCon_20210812 <- dplyr::select(Elm_Male_All_Alive_GenCon_20210812, -row) #remove the row column
# 
# Elm_Male_All_Alive_GenCon_20210812[is.na(Elm_Male_All_Alive_GenCon_20210812[,])] <- 0 # this is what the model normal produces instead of NAs, so I have repeated that here - an argument could be made that they should really be NAs but for the time beign I will keep them like this
# 
# #### Cohort_GenCon
# Elm_Male_Cohort_GenCon_1575_1657.rds$row <- rownames(Elm_Male_Cohort_GenCon_1575_1657.rds)
# Elm_Male_Cohort_GenCon_1575_1657.rds <- Elm_Male_Cohort_GenCon_1575_1657.rds[,!is.na(Elm_Male_Cohort_GenCon_1575_1657.rds[1,])]
# 
# colnames(Elm_Male_Cohort_GenCon_1658.rds) <- gsub("V","",colnames(Elm_Male_Cohort_GenCon_1658.rds)) #this part is slightly more awkward, I have to change the names of the second dataframe, increasing them by the number of years in the first ran dataframe. To do this, I must first remove the "V"s and then add on the number of years in the first dataframe before adding the V back in.
# colnames(Elm_Male_Cohort_GenCon_1658.rds) <- as.character(paste("V",as.numeric(colnames(Elm_Male_Cohort_GenCon_1658.rds))+(ncol(Elm_Male_Cohort_GenCon_1575_1657.rds)-1),sep = ""))
# 
# Elm_Male_Cohort_GenCon_1658.rds$row <- rownames(Elm_Male_Cohort_GenCon_1658.rds) # Joining by the same method.
# Elm_Male_Cohort_GenCon_20210812 <- left_join(Elm_Male_Cohort_GenCon_1575_1657.rds,Elm_Male_Cohort_GenCon_1658.rds, by="row")
# 
# Elm_Male_Cohort_GenCon_20210812 <- dplyr::select(Elm_Male_Cohort_GenCon_20210812, -row)
# 
# Elm_Male_Cohort_GenCon_20210812[is.na(Elm_Male_Cohort_GenCon_20210812[,])] <- 0
# 
# ## Ind_GenCon
# Elm_Male_Ind_GenCon_1575_1657.rds <- Elm_Male_Ind_GenCon_1575_1657.rds[c(1:83)] # Extract the first 100 (run) years
# Elm_Male_Ind_GenCon_20210812 <- c(Elm_Male_Ind_GenCon_1575_1657.rds, Elm_Male_Ind_GenCon_1658.rds) # Join together
# 
# rm(Elm_Male_All_Alive_GenCon_1575_1657.rds)
# rm(Elm_Male_Cohort_GenCon_1575_1657.rds)
# rm(Elm_Male_Ind_GenCon_1575_1657.rds)
# rm(Elm_Male_All_Alive_GenCon_1658.rds)
# rm(Elm_Male_Cohort_GenCon_1658.rds)
# rm(Elm_Male_Ind_GenCon_1658.rds)
# 
# write_rds(Elm_Male_All_Alive_GenCon_20210812,"Elm_Male_All_Alive_GenCon_20210812.rds")
# write_rds(Elm_Male_Cohort_GenCon_20210812,"Elm_Male_Cohort_GenCon_20210812.rds")
# write_rds(Elm_Male_Ind_GenCon_20210812,"Elm_Male_Ind_GenCon_20210812.rds")

# Once this has been done once (the assembled datafiles created), simply use...

Elm_Male_All_Alive_GenCon_20210812 <- readRDS(file = "Elm_Male_All_Alive_GenCon_20210812.rds")
Elm_Male_Cohort_GenCon_20210812 <- readRDS(file = "Elm_Male_Cohort_GenCon_20210812.rds")
Elm_Male_Ind_GenCon_20210812 <- readRDS(file = "Elm_Male_Ind_GenCon_20210812.rds")

```

## Linthal

#### Subsetting pedigree to include only informative individuals

```{r}
library(visPedigree)
ped <- read.delim("data_20220527.txt", sep ="\t")
ped <- ped[,c("IDp","IDf","IDm")] # Rows for each individual with mother and father IDs.
ped <- ped %>% distinct(IDp,.keep_all = T) # Make sure these are all unique rows or the prepped function will not work

tidyped <- tidyped(ped)

elmID <- data_elm_uni$IDp

informative_IDs_elm <- unique(tidyped(ped=tidyped,cand=elmID,trace="all")$Ind)

saveRDS(informative_IDs_elm,"informative_IDs_elm.rds")

```

### Females

#### Importing the data

```{r}
##### Packages

library("nadiv") #for creating the additive genetic relatedness matrix
library("tidyverse") # for some data sorting/handling

###### Importing data
# First I must import the arrivial/departure information individuals for each individual in the population of interest

# Pedigree
ped <- read.delim("data_with_marriage.txt", sep ="\t")
ped <- ped[,c("IDp","IDf","IDm")] # Rows for each individual with mother and father IDs.
ped <- ped %>% distinct(IDp,.keep_all = T) # Make sure these are all unique rows or the prepped function will not work

# arrival/departure infomation
data_lin_uni <- read.csv(file = "data_lin_uni.csv")
data_lin_uni$arryear <- round(data_lin_uni$arryear,0) # Some arrival and departure years are not whole, for this analysis we will round them to the nearest year.
data_lin_uni$depyear <- round(data_lin_uni$depyear,0) 

data_lin_uni <- data_lin_uni[,c("IDp","sex","arryear","depyear")] # only the columns I need for the analysis.
data_lin_uni <- data_lin_uni %>% distinct(IDp,sex,arryear,depyear) # again, make sure these are all unique rows

Ped <- left_join(ped, data_lin_uni[,c("IDp","arryear","depyear")], by="IDp")
informative_IDs_lin <- readRDS("informative_IDs_lin.rds")

Ped <- Ped[Ped$IDp %in% informative_IDs_lin,]

Ped <- as.data.frame(Ped)

```


#### Preparing dataframes to be filled by model

```{r}

#### Firstly I must establish when the loop/model will be ran from.

# For the focal years, I only want these to run for when there are individuals arriving in the population (there are just a few gaps early on)
years_arrival<- sort(unique(data_lin_uni$arryear[data_lin_uni$sex == "F" & !is.na(data_lin_uni$sex)]))

# And these should be tracked for all subsequent years
Female_min_arry <- min(na.omit(data_lin_uni$arryear[data_lin_uni$sex == "F"])) # set the years from with the genetic contributions will be ran from
Female_max_arry <- max(na.omit(data_lin_uni$arryear[data_lin_uni$sex == "F"]))
years <- Female_min_arry:Female_max_arry

years3<-years[1:length(years)]
years<-years[1:length(years)-1]


#### Dataframes for storing model info
#### Get number of years
length_years<-length(years)

All_Alive_BS<-vector("list", length(years)) # Create vector which lists individuals alive each year

### Create datafame to hold total genetic contributions for each cohort
# I am making the assumption that "cohort" for humans is 1 year, this can be grouped to a lower resolution at a later time

# Dataframe to hold Cohort genetic contributions
Female_Cohort_GenCon<-as.data.frame(matrix(NA,length_years,length_years))

### Create datafame to hold total genetic contributions individuals alive each year
Female_All_Alive_GenCon<-as.data.frame(matrix(NA,length_years,length_years))
names(Female_All_Alive_GenCon)<-paste("Y",years[1:length_years],sep="")

### Create a list to hold individual genetic contributions
afteryears.names<- paste("A", 0:(length_years-1) ,sep="")
afteryears <- vector("list", length(afteryears.names))
names(afteryears) <- afteryears.names

Female_Ind_GenCon<-rep(list(afteryears),length_years)
names(Female_Ind_GenCon)<-paste("Y",years[1:length_years],sep="")


saveRDS(Female_All_Alive_GenCon, file = "Lin_Female_All_Alive_GenCon.rds") # I have found it work best if you save the dfs as a RDS after each focal year
# is complete
saveRDS(Female_Cohort_GenCon, file = "Lin_Female_Cohort_GenCon.rds")
saveRDS(Female_Ind_GenCon, file = "Lin_Female_Ind_GenCon.rds")

```

#### The model

```{r}

# Now here is the model/loop that calculates the genetic contributions for all Female individuals and tracks them down each future year in the population

for(x in 1:(length(years))){   ### for each year where individuals arrrive
  y<-years[x]   ### get focal year
  Ped_Alt<-prepPed(Ped) ### prepare pedigree (sorts and adds founders - nadiv package)
  a<-as.character(na.omit(data_lin_uni$IDp[data_lin_uni$arryear==y & data_lin_uni$sex == "F"]))  ### select individuals arrive that year
  Alalive<-with(data_lin_uni,IDp[which(arryear<(y+1) & (depyear>y-1) & sex=="F")])  # Select all individuals alive that year (including
  # those born). Literal code translation= Arryear has happened & Depyear hasn't happened yet (and known)
  
  for(x2 in 1:length(years-1)){ ### For each year after focal year
    y2<-y+x2-1  ### get year (starting at the focal year)
    All_Alive_BS[[x2]]<-with(data_lin_uni,IDp[which(arryear<(y2+1) & depyear>(y2-1))])  ### get list of all individuals alive that year
  }
  
  Ped_Alt$IDm[Ped_Alt$arryear<=y]<-NA    ### ancestral information removed
  Ped_Alt$IDf[Ped_Alt$arryear<=y]<-NA   ### ancestral information removed
  
  mat<-makeA(Ped_Alt[1:3])    # create matrix with ancestors 
  matIDs<-as.character(row.names(mat))   ### Get ID's from matrix
  
  for(x3 in 1:length(years-1)){ ### For each subsequent year after focal year
    
    # get submatrix of only including focal cohort and all individuals alive in year
    matYb<-as.matrix(mat[as.character(c(matIDs[matIDs %in% a])),c(as.character(matIDs[matIDs %in% All_Alive_BS[[x3]]]))])
    # rows of focal individuals, columns of all individuals alive in the year "x3"
    
    # get submatrix of only including individuals alive in focal year and subsequent year
    AAmatYb<-as.matrix(mat[as.character(c(matIDs[matIDs %in% Alalive])),as.character(c(matIDs[matIDs %in% All_Alive_BS[[x3]]]))])
    # rows of alive individuals, columns of all individuals alive in the year "x3"
    
    Female_Cohort_GenCon[x3,x]<-sum(matYb) # Calculate total cohort genetic contribution
    
    Female_All_Alive_GenCon[[x3,x]]<-ifelse(y+x3<=max(years3),sum(AAmatYb),0) # Calculate the total genetic contribution of all individuals alive
    
    indvalues<- rowSums(matYb) # Sum up each individuals total genetic contributions
    
    Female_Ind_GenCon[[x]][[x3]]<-indvalues[as.character(a)] # Save the individuals genetic contributions according to focal year, subsequent year and ID
  }
  saveRDS(Female_All_Alive_GenCon, file = "Lin_Female_All_Alive_GenCon.rds") # I have found it work best if you save the dfs as a RDS after each focal year
  # is complete
  saveRDS(Female_Cohort_GenCon, file = "Lin_Female_Cohort_GenCon.rds")
  saveRDS(Female_Ind_GenCon, file = "Lin_Female_Ind_GenCon.rds")
  print(y)  ### print year - helps track progress of loop
}

```

### Males

#### Importing the data

```{r}

##### Packages

library("nadiv") #for creating the additive genetic relatedness matrix
library("tidyverse") # for some data sorting/handling

###### Importing data

# Pedigree, this is the full data set (ignore the name, this is just my ost recent copy of the datset and I addded the marriage variable for use in the estimation of arrival/departure years)
ped <- read.delim("data_with_marriage.txt", sep ="\t") 
ped <- ped[,c("IDp","IDf","IDm")] # Rows for each individual with mother and father IDs.
ped <- ped %>% distinct(IDp,.keep_all = T) # Make sure these are all unique rows or the prepped function will not work

# I must import the arrivial/departure year, and sex information individuals for each individual in the population of interest
data_lin_uni <- read.csv(file = "data_lin_uni.csv")
data_lin_uni$arryear <- round(data_lin_uni$arryear,0) # Some arrival and departure years are not whole, for this analysis we will round them to the nearest year.
data_lin_uni$depyear <- round(data_lin_uni$depyear,0) 

data_lin_uni <- data_lin_uni[,c("IDp","sex","arryear","depyear")] # only the columns I need for the analysis.
data_lin_uni <- data_lin_uni %>% distinct(IDp,sex,arryear,depyear) # again, make sure these are all unique rows

Ped <- left_join(ped, data_lin_uni[,c("IDp","arryear","depyear")], by="IDp") #join this to the pedigree
informative_IDs_lin <- readRDS("informative_IDs_lin.rds") # this contains a list of all individuals who are either from linthal or have at least one relative (ancestor or descendent) with linthal
# I added this as an attempt to reduce the size of the pedigree and speed up the generation of the relatedness matrix (but still takes around 8 hours for the initial focal years)
Ped <- Ped[Ped$IDp %in% informative_IDs_lin,]

Ped <- as.data.frame(Ped)

```


#### Preparing dataframes to be filled by model

```{r}

#### Firstly I must establish when the loop/model will be ran from.

# And these should be tracked for all subsequent years
Male_min_arry <- min(na.omit(data_lin_uni$arryear[data_lin_uni$sex == "M"])) # set the years from with the genetic contributions will be ran from
Male_max_arry <- max(na.omit(data_lin_uni$arryear[data_lin_uni$sex == "M"]))
years <- Male_min_arry:Male_max_arry

years3<-years[1:length(years)]
years<-years[1:length(years)-1]


#### Dataframes for storing model info
#### Get number of years
length_years<-length(years)

All_Alive_BS<-vector("list", length(years)) # Create vector which lists individuals alive each year

### Create datafame to hold total genetic contributions for each cohort
# I am making the assumption that "cohort" for humans is 1 year, this can be grouped to a lower resolution (e.g. 5-year cohorts) at a later time

# Dataframe to hold Cohort genetic contributions
Male_Cohort_GenCon<-as.data.frame(matrix(NA,length_years,length_years))

### Create datafame to hold total genetic contributions individuals alive each year
Male_All_Alive_GenCon<-as.data.frame(matrix(NA,length_years,length_years))
names(Male_All_Alive_GenCon)<-paste("Y",years[1:length_years],sep="")

### Create a list to hold individual genetic contributions
afteryears.names<- paste("A", 0:(length_years-1) ,sep="")
afteryears <- vector("list", length(afteryears.names))
names(afteryears) <- afteryears.names

Male_Ind_GenCon<-rep(list(afteryears),length_years)
names(Male_Ind_GenCon)<-paste("Y",years[1:length_years],sep="")


saveRDS(Male_All_Alive_GenCon, file = "Lin_Male_All_Alive_GenCon.rds") 
saveRDS(Male_Cohort_GenCon, file = "Lin_Male_Cohort_GenCon.rds")
saveRDS(Male_Ind_GenCon, file = "Lin_Male_Ind_GenCon.rds")

```

#### The model

```{r}
# Now here is the model/loop that calculates the genetic contributions for all male individuals and tracks them down each future year in the population

for(x in 1:(length(years))){   ### for each year where individuals arrrive
  y<-years[x]   ### get focal year
  Ped_Alt<-prepPed(Ped) ### prepare pedigree (sorts and adds founders - nadiv package)
  a<-as.character(na.omit(data_lin_uni$IDp[data_lin_uni$arryear==y & data_lin_uni$sex == "M"]))  ### select individuals arrive that year
  Alalive<-with(data_lin_uni,IDp[which(arryear<(y+1) & (depyear>y-1) & sex=="M")])  # Select all individuals alive that year (including
  # those born). Literal code translation= Arryear has happened & Depyear hasn't happened yet (and known)
  
  for(x2 in 1:length(years-1)){ ### For each year after focal year
    y2<-y+x2-1  ### get year (starting at the focal year)
    All_Alive_BS[[x2]]<-with(data_lin_uni,IDp[which(arryear<(y2+1) & depyear>(y2-1))])  ### get list of all individuals alive that year
  }
  
  Ped_Alt$IDm[Ped_Alt$arryear<=y]<-NA    ### ancestral information removed
  Ped_Alt$IDf[Ped_Alt$arryear<=y]<-NA   ### ancestral information removed
  
  mat<-makeA(Ped_Alt[1:3])    # create matrix with ancestors 
  matIDs<-as.character(row.names(mat))   ### Get ID's from matrix
  
  for(x3 in 1:length(years-1)){ ### For each subsequent year after focal year
    
    # get submatrix of only including focal cohort and all individuals alive in year
    matYb<-as.matrix(mat[as.character(c(matIDs[matIDs %in% a])),c(as.character(matIDs[matIDs %in% All_Alive_BS[[x3]]]))])
    # rows of focal individuals, columns of all individuals alive in the year "x3"
    
    # get submatrix of only including individuals alive in focal year and subsequent year
    AAmatYb<-as.matrix(mat[as.character(c(matIDs[matIDs %in% Alalive])),as.character(c(matIDs[matIDs %in% All_Alive_BS[[x3]]]))])
    # rows of alive individuals, columns of all individuals alive in the year "x3"
    
    Male_Cohort_GenCon[x3,x]<-sum(matYb) # Calculate total cohort genetic contribution
    
    Male_All_Alive_GenCon[[x3,x]]<-ifelse(y+x3<=max(years3),sum(AAmatYb),0) # Calculate the total genetic contribution of all individuals alive
    
    indvalues<- rowSums(matYb) # Sum up each individuals total genetic contributions
    
    Male_Ind_GenCon[[x]][[x3]]<-indvalues[as.character(a)] # Save the individuals genetic contributions according to focal year, subsequent year and ID
  }
  saveRDS(Male_All_Alive_GenCon, file = "Lin_Male_All_Alive_GenCon.rds") # I have found it work best if you save the dfs as a RDS after each focal year
  # is complete
  saveRDS(Male_Cohort_GenCon, file = "Lin_Male_Cohort_GenCon.rds")
  saveRDS(Male_Ind_GenCon, file = "Lin_Male_Ind_GenCon.rds")
  print(y)  ### print year - helps track progress of loop
}
```

### Sorting output


```{r fig.show="hold", out.width="10%"}

# # Importing the datafiles from each run of the model
# Lin_Female_All_Alive_GenCon_1578_1620.rds <- readRDS(file = "Lin_Female_All_Alive_GenCon_1578-1620.rds")
# Lin_Female_Cohort_GenCon_1578_1620.rds <- readRDS(file = "Lin_Female_Cohort_GenCon_1578-1620.rds")
# Lin_Female_Ind_GenCon_1578_1620.rds <- readRDS(file = "Lin_Female_Ind_GenCon_1578-1620.rds")
# 
# Lin_Female_All_Alive_GenCon_1621_1731.rds <- readRDS(file = "Lin_Female_All_Alive_GenCon_1621-1731.rds")
# Lin_Female_Cohort_GenCon_1621_1731.rds <- readRDS(file = "Lin_Female_Cohort_GenCon_1621-1731.rds")
# Lin_Female_Ind_GenCon_1621_1731.rds <- readRDS(file = "Lin_Female_Ind_GenCon_1621-1731.rds")
# 
# Lin_Female_All_Alive_GenCon_1732.rds <- readRDS(file = "Lin_Female_All_Alive_GenCon_1732_.rds")
# Lin_Female_Cohort_GenCon_1732.rds <- readRDS(file = "Lin_Female_Cohort_GenCon_1732_.rds")
# Lin_Female_Ind_GenCon_1732.rds <- readRDS(file = "Lin_Female_Ind_GenCon_1732_.rds")
# 
# # I will tackle each "type" of datafile (all_alive, cohort, individual) separately.
# #### All_Alive_GenCon
# Lin_Female_All_Alive_GenCon_1578_1620.rds$row <- rownames(Lin_Female_All_Alive_GenCon_1578_1620.rds) #I assign a row number to each data set which will be used to match the two dataframes together with the "left_join()" function
# Lin_Female_All_Alive_GenCon_1578_1620.rds <- Lin_Female_All_Alive_GenCon_1578_1620.rds[,!is.na(Lin_Female_All_Alive_GenCon_1578_1620.rds[1,])] # I also remove all the years which the model did not reach during its run.
# 
# # I will tackle each "type" of datafile (all_alive, cohort, individual) separately.
# #### All_Alive_GenCon
# Lin_Female_All_Alive_GenCon_1621_1731.rds$row <- rownames(Lin_Female_All_Alive_GenCon_1621_1731.rds) #I assign a row number to each data set which will be used to match the two dataframes together with the "left_join()" function
# Lin_Female_All_Alive_GenCon_1621_1731.rds <- Lin_Female_All_Alive_GenCon_1621_1731.rds[,!is.na(Lin_Female_All_Alive_GenCon_1621_1731.rds[1,])] # I also remove all the years which the model did not reach during its run.
# 
# Lin_Female_All_Alive_GenCon_1732.rds$row <- rownames(Lin_Female_All_Alive_GenCon_1732.rds)
# 
# Lin_Female_All_Alive_GenCon_20210812 <- left_join(Lin_Female_All_Alive_GenCon_1578_1620.rds,Lin_Female_All_Alive_GenCon_1621_1731.rds, by="row") # join the two dataframes
# 
# Lin_Female_All_Alive_GenCon_20210812 <- left_join(Lin_Female_All_Alive_GenCon_20210812, Lin_Female_All_Alive_GenCon_1732.rds, by="row") # join the two dataframes
# 
# Lin_Female_All_Alive_GenCon_20210812 <- select(Lin_Female_All_Alive_GenCon_20210812, -row) #remove the row column
# 
# Lin_Female_All_Alive_GenCon_20210812[is.na(Lin_Female_All_Alive_GenCon_20210812[,])] <- 0 # this is what the model normal produces instead of NAs, so I have repeated that here - an argument could be made that they should really be NAs but for the time beign I will keep them like this
# 
# #### Cohort_GenCon ####
# 
# Lin_Female_Cohort_GenCon_1578_1620.rds <- Lin_Female_Cohort_GenCon_1578_1620.rds[,!is.na(Lin_Female_Cohort_GenCon_1578_1620.rds[1,])] # I also remove all the years which the model did not reach during its run.
# Lin_Female_Cohort_GenCon_1621_1731.rds <- Lin_Female_Cohort_GenCon_1621_1731.rds[,!is.na(Lin_Female_Cohort_GenCon_1621_1731.rds[1,])] # I also remove all the years which the model did not reach during its run.
# Lin_Female_Cohort_GenCon_1732.rds <- Lin_Female_Cohort_GenCon_1732.rds[,!is.na(Lin_Female_Cohort_GenCon_1732.rds[1,])] # I also remove all the years which the model did not reach during its run.
# 
# Lin_Female_Cohort_GenCon_1578_1620.rds$row <- rownames(Lin_Female_Cohort_GenCon_1578_1620.rds)
# Lin_Female_Cohort_GenCon_1578_1620.rds <- Lin_Female_Cohort_GenCon_1578_1620.rds[,!is.na(Lin_Female_Cohort_GenCon_1578_1620.rds[1,])]
# 
# 
# colnames(Lin_Female_Cohort_GenCon_1621_1731.rds) <- gsub("V","",colnames(Lin_Female_Cohort_GenCon_1621_1731.rds)) #this part is slightly more awkward, I have to change the names of the second dataframe, increasing them by the number of years in the first ran dataframe. To do this, I must first remove the "V"s and then add on the number of years in the first dataframe before adding the V back in.
# colnames(Lin_Female_Cohort_GenCon_1621_1731.rds) <- as.character(paste("V",as.numeric(colnames(Lin_Female_Cohort_GenCon_1621_1731.rds))+(ncol(Lin_Female_Cohort_GenCon_1578_1620.rds)-1),sep = ""))
# 
# Lin_Female_Cohort_GenCon_1621_1731.rds$row <- rownames(Lin_Female_Cohort_GenCon_1621_1731.rds) # Joining by the same method.
# Lin_Female_Cohort_GenCon_20210812 <- left_join(Lin_Female_Cohort_GenCon_1578_1620.rds,Lin_Female_Cohort_GenCon_1621_1731.rds, by="row")
# 
# colnames(Lin_Female_Cohort_GenCon_1732.rds) <- gsub("V","",colnames(Lin_Female_Cohort_GenCon_1732.rds)) #this part is slightly more awkward, I have to change the names of the second dataframe, increasing them by the number of years in the first ran dataframe. To do this, I must first remove the "V"s and then add on the number of years in the first dataframe before adding the V back in.
# colnames(Lin_Female_Cohort_GenCon_1732.rds) <- as.character(paste("V",as.numeric(colnames(Lin_Female_Cohort_GenCon_1732.rds))+(ncol(Lin_Female_Cohort_GenCon_20210812)-1),sep = ""))
# 
# Lin_Female_Cohort_GenCon_1732.rds$row <- rownames(Lin_Female_Cohort_GenCon_1732.rds) # Joining by the same method.
# Lin_Female_Cohort_GenCon_20210812 <- left_join(Lin_Female_Cohort_GenCon_20210812,Lin_Female_Cohort_GenCon_1732.rds, by="row")
# 
# Lin_Female_Cohort_GenCon_20210812 <- select(Lin_Female_Cohort_GenCon_20210812, -row)
# 
# Lin_Female_Cohort_GenCon_20210812[is.na(Lin_Female_Cohort_GenCon_20210812[,])] <- 0
# 
# 
# ## Ind_GenCon
# Lin_Female_Ind_GenCon_1578_1620.rds <- Lin_Female_Ind_GenCon_1578_1620.rds[c(1:43)] # Extract the first 43 (run) years
# Lin_Female_Ind_GenCon_1621_1731.rds <- Lin_Female_Ind_GenCon_1621_1731.rds[c(1:111)] # Extract the first 100 (run) years
# 
# Lin_Female_Ind_GenCon_20210812 <- c(Lin_Female_Ind_GenCon_1578_1620.rds,Lin_Female_Ind_GenCon_1621_1731.rds,Lin_Female_Ind_GenCon_1732.rds) # Join together
# 
# rm(Lin_Female_All_Alive_GenCon_1578_1620.rds)
# rm(Lin_Female_Cohort_GenCon_1578_1620.rds)
# rm(Lin_Female_Ind_GenCon_1578_1620.rds)
# 
# rm(Lin_Female_All_Alive_GenCon_1621_1731.rds)
# rm(Lin_Female_Cohort_GenCon_1621_1731.rds)
# rm(Lin_Female_Ind_GenCon_1621_1731.rds)
# 
# rm(Lin_Female_All_Alive_GenCon_1732.rds)
# rm(Lin_Female_Cohort_GenCon_1732.rds)
# rm(Lin_Female_Ind_GenCon_1732.rds)
# 
# write_rds(Lin_Female_All_Alive_GenCon_20210812,"Lin_Female_All_Alive_GenCon_20210812.rds")
# write_rds(Lin_Female_Cohort_GenCon_20210812,"Lin_Female_Cohort_GenCon_20210812.rds")
# write_rds(Lin_Female_Ind_GenCon_20210812,"Lin_Female_Ind_GenCon_20210812.rds")
# 
# # Once this has been done once (the assembled datafiles created), simply use...

Lin_Female_All_Alive_GenCon_20210812 <- readRDS(file = "Lin_Female_All_Alive_GenCon_20210812.rds")
Lin_Female_Cohort_GenCon_20210812 <- readRDS(file = "Lin_Female_Cohort_GenCon_20210812.rds")
Lin_Female_Ind_GenCon_20210812 <- readRDS(file = "Lin_Female_Ind_GenCon_20210812.rds")

```


```{r fig.show="hold", out.width="10%"}
# 
# # Importing the datafiles from each run of the model
# Lin_Male_All_Alive_GenCon_1585_1636.rds <- readRDS(file = "Lin_Male_All_Alive_GenCon_1585-1636.rds")
# Lin_Male_Cohort_GenCon_1585_1636.rds <- readRDS(file = "Lin_Male_Cohort_GenCon_1585-1636.rds")
# Lin_Male_Ind_GenCon_1585_1636.rds <- readRDS(file = "Lin_Male_Ind_GenCon_1585-1636.rds")
# 
# Lin_Male_All_Alive_GenCon_1637_1789.rds <- readRDS(file = "Lin_Male_All_Alive_GenCon_0709.rds")
# Lin_Male_Cohort_GenCon_1637_1789.rds <- readRDS(file = "Lin_Male_Cohort_GenCon_0709.rds")
# Lin_Male_Ind_GenCon_1637_1789.rds <- readRDS(file = "Lin_Male_Ind_GenCon_0709.rds")
# 
# Lin_Male_All_Alive_GenCon_1790_1845.rds <- readRDS(file = "Lin_Male_All_Alive_GenCon_20210908.rds")
# Lin_Male_Cohort_GenCon_1790_1845.rds <- readRDS(file = "Lin_Male_Cohort_GenCon_20210908.rds")
# Lin_Male_Ind_GenCon_1790_1845.rds <- readRDS(file = "Lin_Male_Ind_GenCon_20210908.rds")
# 
# Lin_Male_All_Alive_GenCon_1846.rds <- readRDS(file = "Lin_Male_All_Alive_GenCon_1637_.rds")
# Lin_Male_Cohort_GenCon_1846.rds <- readRDS(file = "Lin_Male_Cohort_GenCon_1637_.rds")
# Lin_Male_Ind_GenCon_1846.rds <- readRDS(file = "Lin_Male_Ind_GenCon_1637_.rds")
# 
# # I will tackle each "type" of datafile (all_alive, cohort, individual) separately.
# #### All_Alive_GenCon
# Lin_Male_All_Alive_GenCon_1585_1636.rds$row <- rownames(Lin_Male_All_Alive_GenCon_1585_1636.rds) #I assign a row number to each data set which will be used to match the two dataframes together with the "left_join()" function
# Lin_Male_All_Alive_GenCon_1585_1636.rds <- Lin_Male_All_Alive_GenCon_1585_1636.rds[,!is.na(Lin_Male_All_Alive_GenCon_1585_1636.rds[1,])] # I also remove all the years which the model did not reach during its run.
# 
# ###### Joining on 2
# Lin_Male_All_Alive_GenCon_1637_1789.rds$row <- rownames(Lin_Male_All_Alive_GenCon_1637_1789.rds)
# 
# Lin_Male_All_Alive_GenCon_1637_1789.rds <- Lin_Male_All_Alive_GenCon_1637_1789.rds[,!is.na(Lin_Male_All_Alive_GenCon_1637_1789.rds[1,])] # I also remove all the years which the model did not reach during its run.
# 
# 
# Lin_Male_All_Alive_GenCon_20210812 <- left_join(Lin_Male_All_Alive_GenCon_1585_1636.rds,Lin_Male_All_Alive_GenCon_1637_1789.rds, by="row") # join the two dataframes
# 
# Lin_Male_All_Alive_GenCon_20210812 <- select(Lin_Male_All_Alive_GenCon_20210812, -row) #remove the row column
# 
# Lin_Male_All_Alive_GenCon_20210812[is.na(Lin_Male_All_Alive_GenCon_20210812[,])] <- 0 # this is what the model normal produces instead of NAs, so I have repeated that here - an argument could be made that they should really be NAs but for the time beign I will keep them like this
# 
# ###### Joining on 3
# Lin_Male_All_Alive_GenCon_1790_1845.rds$row <- rownames(Lin_Male_All_Alive_GenCon_1790_1845.rds)
# 
# Lin_Male_All_Alive_GenCon_1790_1845.rds <- Lin_Male_All_Alive_GenCon_1790_1845.rds[,!is.na(Lin_Male_All_Alive_GenCon_1790_1845.rds[1,])] # I also remove all the years which the model did not reach during its run.
# 
# Lin_Male_All_Alive_GenCon_20210812$row <- rownames(Lin_Male_All_Alive_GenCon_20210812)
# 
# Lin_Male_All_Alive_GenCon_20210812 <- left_join(Lin_Male_All_Alive_GenCon_20210812,Lin_Male_All_Alive_GenCon_1790_1845.rds, by="row") # join the two dataframes
# 
# Lin_Male_All_Alive_GenCon_20210812 <- select(Lin_Male_All_Alive_GenCon_20210812, -row) #remove the row column
# 
# Lin_Male_All_Alive_GenCon_20210812[is.na(Lin_Male_All_Alive_GenCon_20210812[,])] <- 0 # this is what the model normal produces instead of NAs, so I have repeated that here - an argument could be made that they should really be NAs but for the time beign I will keep them like this
# 
# ###### Joining on 4
# Lin_Male_All_Alive_GenCon_1846.rds$row <- rownames(Lin_Male_All_Alive_GenCon_1846.rds)
# 
# Lin_Male_All_Alive_GenCon_1846.rds <- Lin_Male_All_Alive_GenCon_1846.rds[,!is.na(Lin_Male_All_Alive_GenCon_1846.rds[1,])] # I also remove all the years which the model did not reach during its run.
# 
# Lin_Male_All_Alive_GenCon_1846.rds <-select(Lin_Male_All_Alive_GenCon_1846.rds,-colnames(Lin_Male_All_Alive_GenCon_1846.rds)[1:6]) # I also remove all the years for which I already have
# 
# 
# Lin_Male_All_Alive_GenCon_20210812$row <- rownames(Lin_Male_All_Alive_GenCon_20210812)
# 
# Lin_Male_All_Alive_GenCon_20210812 <- left_join(Lin_Male_All_Alive_GenCon_20210812,Lin_Male_All_Alive_GenCon_1846.rds, by="row") # join the two dataframes
# 
# Lin_Male_All_Alive_GenCon_20210812 <- select(Lin_Male_All_Alive_GenCon_20210812, -row) #remove the row column
# 
# Lin_Male_All_Alive_GenCon_20210812[is.na(Lin_Male_All_Alive_GenCon_20210812[,])] <- 0 # this is what the model normal produces instead of NAs, so I have repeated that here - an argument could be made that they should really be NAs but for the time beign I will keep them like this
# 
# #### Cohort_GenCon ####
# 
# Lin_Male_Cohort_GenCon_1585_1636.rds <- Lin_Male_Cohort_GenCon_1585_1636.rds[,!is.na(Lin_Male_Cohort_GenCon_1585_1636.rds[1,])] # I also remove all the years which the model did not reach during its run.
# Lin_Male_Cohort_GenCon_1637_1789.rds <- Lin_Male_Cohort_GenCon_1637_1789.rds[,!is.na(Lin_Male_Cohort_GenCon_1637_1789.rds[1,])] # I also remove all the years which the model did not reach during its run.
# Lin_Male_Cohort_GenCon_1790_1845.rds <- Lin_Male_Cohort_GenCon_1790_1845.rds[,!is.na(Lin_Male_Cohort_GenCon_1790_1845.rds[1,])] # I also remove all the years which the model did not reach during its run.
# Lin_Male_Cohort_GenCon_1846.rds <- Lin_Male_Cohort_GenCon_1846.rds[,!is.na(Lin_Male_Cohort_GenCon_1846.rds[1,])] # I also remove all the years which the model did not reach during its run.
# 
# Lin_Male_Cohort_GenCon_1846.rds <- select(Lin_Male_Cohort_GenCon_1846.rds,-colnames(Lin_Male_Cohort_GenCon_1846.rds)[1:6])
# 
# 
# Lin_Male_Cohort_GenCon_1585_1636.rds$row <- rownames(Lin_Male_Cohort_GenCon_1585_1636.rds)
# Lin_Male_Cohort_GenCon_1585_1636.rds <- Lin_Male_Cohort_GenCon_1585_1636.rds[,!is.na(Lin_Male_Cohort_GenCon_1585_1636.rds[1,])]
# 
# colnames(Lin_Male_Cohort_GenCon_1637_1789.rds) <- gsub("V","",colnames(Lin_Male_Cohort_GenCon_1637_1789.rds)) #this part is slightly more awkward, I have to change the names of the second dataframe, increasing them by the number of years in the first ran dataframe. To do this, I must first remove the "V"s and then add on the number of years in the first dataframe before adding the V back in.
# colnames(Lin_Male_Cohort_GenCon_1637_1789.rds) <- as.character(paste("V",as.numeric(colnames(Lin_Male_Cohort_GenCon_1637_1789.rds))+(ncol(Lin_Male_Cohort_GenCon_1585_1636.rds)-1),sep = ""))
# 
# Lin_Male_Cohort_GenCon_1637_1789.rds$row <- rownames(Lin_Male_Cohort_GenCon_1637_1789.rds) # Joining by the same method.
# Lin_Male_Cohort_GenCon_20210812 <- left_join(Lin_Male_Cohort_GenCon_1585_1636.rds,Lin_Male_Cohort_GenCon_1637_1789.rds, by="row")
# 
# colnames(Lin_Male_Cohort_GenCon_1790_1845.rds) <- gsub("V","",colnames(Lin_Male_Cohort_GenCon_1790_1845.rds)) #this part is slightly more awkward, I have to change the names of the second dataframe, increasing them by the number of years in the first ran dataframe. To do this, I must first remove the "V"s and then add on the number of years in the first dataframe before adding the V back in.
# colnames(Lin_Male_Cohort_GenCon_1790_1845.rds) <- as.character(paste("V",as.numeric(colnames(Lin_Male_Cohort_GenCon_1790_1845.rds))+(ncol(Lin_Male_Cohort_GenCon_20210812)-1),sep = ""))
# 
# Lin_Male_Cohort_GenCon_1790_1845.rds$row <- rownames(Lin_Male_Cohort_GenCon_1790_1845.rds) # Joining by the same method.
# Lin_Male_Cohort_GenCon_20210812 <- left_join(Lin_Male_Cohort_GenCon_20210812,Lin_Male_Cohort_GenCon_1790_1845.rds, by="row")
# 
# 
# colnames(Lin_Male_Cohort_GenCon_1846.rds) <- gsub("V","",colnames(Lin_Male_Cohort_GenCon_1846.rds)) #this part is slightly more awkward, I have to change the names of the second dataframe, increasing them by the number of years in the first ran dataframe. To do this, I must first remove the "V"s and then add on the number of years in the first dataframe before adding the V back in.
# colnames(Lin_Male_Cohort_GenCon_1846.rds) <- as.character(paste("V",as.numeric(colnames(Lin_Male_Cohort_GenCon_1846.rds))+(ncol(Lin_Male_Cohort_GenCon_20210812)-1),sep = ""))
# 
# Lin_Male_Cohort_GenCon_1846.rds$row <- rownames(Lin_Male_Cohort_GenCon_1846.rds) # Joining by the same method.
# Lin_Male_Cohort_GenCon_20210812$row <- rownames(Lin_Male_Cohort_GenCon_20210812)
# 
# Lin_Male_Cohort_GenCon_20210812 <- left_join(Lin_Male_Cohort_GenCon_20210812,Lin_Male_Cohort_GenCon_1846.rds, by="row")
# 
# Lin_Male_Cohort_GenCon_20210812 <- select(Lin_Male_Cohort_GenCon_20210812, -row)
# 
# 
# Lin_Male_Cohort_GenCon_20210812[is.na(Lin_Male_Cohort_GenCon_20210812[,])] <- 0
# 
# 
# 
# 
# 
# ## Ind_GenCon
# Lin_Male_Ind_GenCon_1585_1636.rds <- Lin_Male_Ind_GenCon_1585_1636.rds[c(1:52)] # Extract the first 43 (run) years
# Lin_Male_Ind_GenCon_1637_1789.rds <- Lin_Male_Ind_GenCon_1637_1789.rds[c(1:153)] # Extract the first 100 (run) years
# 
# Lin_Male_Ind_GenCon_1790_1845.rds <- Lin_Male_Ind_GenCon_1790_1845.rds[c(1:55)] # Extract the first 100 (run) years
# 
# Lin_Male_Ind_GenCon_20210812 <- c(Lin_Male_Ind_GenCon_1585_1636.rds,Lin_Male_Ind_GenCon_1637_1789.rds,Lin_Male_Ind_GenCon_1790_1845.rds,Lin_Male_Ind_GenCon_1846.rds)
# 
# 
# 
# write_rds(Lin_Male_All_Alive_GenCon_20210812,"Lin_Male_All_Alive_GenCon_20210812.rds")
# write_rds(Lin_Male_Cohort_GenCon_20210812,"Lin_Male_Cohort_GenCon_20210812.rds")
# write_rds(Lin_Male_Ind_GenCon_20210812,"Lin_Male_Ind_GenCon_20210812.rds")
# 
# # Once this has been done once (the assembled datafiles created), simply use...

Lin_Male_All_Alive_GenCon_20210812 <- readRDS(file = "Lin_Male_All_Alive_GenCon_20210812.rds")
Lin_Male_Cohort_GenCon_20210812 <- readRDS(file = "Lin_Male_Cohort_GenCon_20210812.rds")
Lin_Male_Ind_GenCon_20210812 <- readRDS(file = "Lin_Male_Ind_GenCon_20210812.rds")

```






# 3. Examination of stabilisation and data selection

From manuscript:
**Although initially IGC can fluctuate substantially over generations, they are expected to stabilise at an individual’s reproductive value, which can be considered the ultimate measure of fitness (31,42,43). We evaluated stabilisation of IGC by grouping individuals into 10-year birth cohorts and quantifying the Pearson correlation coefficient between these IGC from each subsequent year and the final year (1990). When this remained above a 0.95 threshold for a period of 2 generations, IGC were considered to have stabilised (4,6). We defined a generation as the mean parental age at offspring birth, which was 32.2 (±SE, ±0.04) and 32.1 (±0.05) yr for Linthal and Elm, respectively.**
**IGC were considered to have stabilised for individuals born before 1717 in Linthal and before 1734 in Elm (Supplementary Figure 1; the difference being likely due to the larger population size of Linthal). However, despite meeting the criteria for stabilisation of genetic contributions outlined above (4), visual inspection showed that although the fluctuations become minor, they do not reach a plateau over time (Supplementary Figure 2). We therefore   selected only individuals whose IGC were estimated over a period of at least approximately 8 generations after they were born – a period spanning an equivalent number of generations as previous studies. In total, IGC to the year 1990 from 3,728 focal individuals (1,896 from Linthal and 1,832 from Elm) were used in the analyses. The length over which IGC were estimated was at least 257.68 and 257.08 yr, and on average 314.97 (±0.93) and 318.44 (±0.88) years (for Linthal and Elm, respectively), with the birth years of focal individuals ranging between 1575-1735.**

Here is the code for carrying out this part of the analysis.

## Testing stabilsiation

First we tested stabilisation according to the definition Reid et al. 2019: correlations between expected genetic contributions for each year and the final year being above 0.95 for a duration of at least 2 generations.

#### Calculating generation times

For this part I need to apprixmate generation time in these populations

```{r fig.show="hold", out.width="25%"}
library(tidyverse)

data_elm_uni <- read.csv(file="data_elm_uni.csv")

gen_time_elm <- data_elm_uni[,c("IDp","IDm","IDf","byear")] # extracting appropriate columns

gen_time_elm <- gen_time_elm %>% drop_na() # removing NAs

# extracting mum birth info
mum_data_elm <- data_elm_uni[,c("IDp","byear")] 
mum_data_elm$IDm <- mum_data_elm$IDp
mum_data_elm$mumbyear <- mum_data_elm$byear
mum_data_elm <- subset(mum_data_elm, select = -c(byear) )

# adding to gen_time data
gen_time_elm <- left_join(gen_time_elm,mum_data_elm, by="IDm")

# extracting dad birth info
dad_data_elm <- data_elm_uni[,c("IDp","byear")]
dad_data_elm$IDf <- dad_data_elm$IDp
dad_data_elm$dadbyear <- dad_data_elm$byear
dad_data_elm <- subset(dad_data_elm, select = -c(byear) )

# adding to gen_time data
gen_time_elm <- left_join(gen_time_elm,dad_data_elm, by="IDf")

# Gathering to have one "parentbyear" column and another column, "parent" indicating if the it is the mum or the dad
gen_time_elm <- gather(gen_time_elm, dadbyear,mumbyear, key = "parent",value = "parentbyear")

gen_time_elm <- gen_time_elm %>% 
  dplyr::select(-IDp.y,-IDp) #removing excess columns

gen_time_elm$parentaggeatbirth <- gen_time_elm$byear-gen_time_elm$parentbyear # calculating the age at reproduction

```


```{r fig.show="hold", out.width="25%"}

data_lin_uni <- read.csv(file="data_lin_uni.csv")

gen_time_lin <- data_lin_uni[,c("IDp","IDm","IDf","byear")] # extracting appropriate columns

gen_time_lin <- gen_time_lin %>% drop_na() # removing NAs

# extracting mum birth info
mum_data_lin <- data_lin_uni[,c("IDp","byear")] 
mum_data_lin$IDm <- mum_data_lin$IDp
mum_data_lin$mumbyear <- mum_data_lin$byear
mum_data_lin <- subset(mum_data_lin, select = -c(byear) )

# adding to gen_time data
gen_time_lin <- left_join(gen_time_lin,mum_data_lin, by="IDm")

# extracting dad birth info
dad_data_lin <- data_lin_uni[,c("IDp","byear")]
dad_data_lin$IDf <- dad_data_lin$IDp
dad_data_lin$dadbyear <- dad_data_lin$byear
dad_data_lin <- subset(dad_data_lin, select = -c(byear) )

# adding to gen_time data
gen_time_lin <- left_join(gen_time_lin,dad_data_lin, by="IDf")

# Gathering to have one "parentbyear" column and another column, "parent" indicating if the it is the mum or the dad
gen_time_lin <- gather(gen_time_lin, dadbyear,mumbyear, key = "parent",value = "parentbyear")

gen_time_lin <- gen_time_lin %>% 
  dplyr::select(-IDp.y,-IDp) #removing excess columns

gen_time_lin$parentaggeatbirth <- gen_time_lin$byear-gen_time_lin$parentbyear # calculating the age at reproduction

hist.default(gen_time_elm$parentaggeatbirth) # visual inspection of data, few weirdly high values but shouldn't affect this calculation too much
mean(na.omit(gen_time_elm$parentaggeatbirth)) #median generation time, using median as it isnt quite normally distributed
hist.default(gen_time_lin$parentaggeatbirth) # visual inspection of data, few weirdly high values but shouldn't affect this calculation too much
mean(na.omit(gen_time_lin$parentaggeatbirth)) #median generation time, using median as it isnt quite normally distributed

```

```{r}
library(plotrix)
mean(na.omit(gen_time_elm$parentaggeatbirth))
std.error(na.omit(gen_time_elm$parentaggeatbirth))
mean(na.omit(gen_time_lin$parentaggeatbirth))
std.error(na.omit(gen_time_lin$parentaggeatbirth))
```
### Testing stabilisation

### Elm

#### Data preperation

##### Females 

``` {r stab_corr, data prep}
Elm_Female_All_Alive_GenCon_20210812 <- readRDS(file = "Elm_Female_All_Alive_GenCon_20210812.rds")
Elm_Female_Cohort_GenCon_20210812 <- readRDS(file = "Elm_Female_Cohort_GenCon_20210812.rds")
Elm_Female_Ind_GenCon_20210812 <- readRDS(file = "Elm_Female_Ind_GenCon_20210812.rds")

# Count number of indiviudals born/arrrived in each year
arrival_count <- t(Elm_Female_Cohort_GenCon_20210812[1,]) # number of individuals "arriving" each year
start_year <- as.numeric(gsub("Y","",colnames(Elm_Female_All_Alive_GenCon_20210812)[1]))
end_year <- as.numeric(gsub("Y","",colnames(Elm_Female_All_Alive_GenCon_20210812)[ncol(Elm_Female_All_Alive_GenCon_20210812)]))
rownames(arrival_count) <- start_year:end_year

arrival_count <- as.data.frame(arrival_count) 
arrival_count$year <- rownames(arrival_count)
years.data <- as.data.frame(arrival_count[!is.na(arrival_count$`1`) & arrival_count$`1`>0,])

# Individual genetic contributions ----------------------------------------

colnames(Elm_Female_All_Alive_GenCon_20210812) <- as.numeric(gsub("Y","",colnames(Elm_Female_All_Alive_GenCon_20210812)))

#Flips the data-set from wide to long
All_Alive_Contributions_20210812 <- gather(Elm_Female_All_Alive_GenCon_20210812[1,]) 
colnames(All_Alive_Contributions_20210812)<- c("Year", "Total_Genetic")
All_Alive_Contributions_20210812 <- as.data.frame(All_Alive_Contributions_20210812)
All_Alive_Contributions_20210812$Year <- as.numeric(All_Alive_Contributions_20210812$Year)

#Extract information about each individual born in the first year, and their genetic contributions to each year after 
#their birth. Then do this for each cohort in the dataset. Saving each as a new data frame

for(i in 1:nrow(years.data)) {
  year <- years.data[i,2]
  if(year<1694) {
    x <- data.frame(Elm_Female_Ind_GenCon_20210812[[paste("Y",year,sep = "")]])
    x$ID <- rownames(x)
    x <- reshape2::melt(x, id=c("ID"))
    x$Cohort <- as.numeric(year)
    x <- x[order(x$ID, x$variable),] 
    x$Year <- as.numeric(year):(as.numeric(year)+(ncol(Elm_Female_Cohort_GenCon_20210812)-1))
    assign(paste("Elm_Female_Genetic_Contributions_",year,sep=""),x) 
  }
  else{if(year<1694) {
    x <- data.frame(Elm_Female_Ind_GenCon_20210812[[paste("Y",year,sep = "")]])
    x$ID <- rownames(x)
    x <- reshape2::melt(x, id=c("ID"))
    x$Cohort <- as.numeric(year)
    x <- x[order(x$ID, x$variable),] 
    x$Year <- as.numeric(year):(as.numeric(year)+(ncol(Elm_Female_Cohort_GenCon_20210812)-1))
    assign(paste("Elm_Female_Genetic_Contributions_",year,sep=""),x) 
  }
    else{
      x <- data.frame(Elm_Female_Ind_GenCon_20210812[[paste("Y",year,sep = "")]])
      x$ID <- rownames(x)
      x <- reshape2::melt(x, id=c("ID"))
      x$Cohort <- as.numeric(year)
      x <- x[order(x$ID, x$variable),] 
      x$Year <- as.numeric(year):(as.numeric(year)+301)
      assign(paste("Elm_Female_Genetic_Contributions_",year,sep=""),x)
    }
  }
  
}

for(i in 1:nrow(years.data)) { # gathers the names of these datasets in prep for gethering them all into one file
  year <- years.data[i,2]
  years.data$data[i] <- paste("Elm_Female_Genetic_Contributions_",year,sep="")
} 

#Combine all of the above datasets
Elm_Female_GeneticContributions_20210812 <- rbind(mget(years.data$data)) #puts all together in a list

Elm_Female_GeneticContributions_20210812 <- bind_rows(Elm_Female_GeneticContributions_20210812) #puts all together in a df

rm(list = ls()[grepl("Elm_Female_Genetic_Contributions_", ls())]) #remove all individual year objects

Elm_Female_GeneticContributions_20210812 <- Elm_Female_GeneticContributions_20210812[!Elm_Female_GeneticContributions_20210812$Year>end_year,] #remove all irrelevant years

colnames(Elm_Female_GeneticContributions_20210812)<- c("ID", "Relative_Year", "Contribution", "Cohort", "Year")

Elm_Female_GeneticContributions_20210812$Contribution <- as.numeric(Elm_Female_GeneticContributions_20210812$Contribution)

Elm_Female_GeneticContributions_20210812[is.na(Elm_Female_GeneticContributions_20210812)] <- 0

Elm_Female_GeneticContributions_20210812$Total_Genetic <- lapply(Elm_Female_GeneticContributions_20210812$Year, function(x) All_Alive_Contributions_20210812[match(x, All_Alive_Contributions_20210812$Year), "Total_Genetic"])

Elm_Female_GeneticContributions_20210812$Total_Genetic <- as.numeric(Elm_Female_GeneticContributions_20210812$Total_Genetic)
Elm_Female_GeneticContributions_20210812$Proportional <- as.numeric(Elm_Female_GeneticContributions_20210812$Contribution/Elm_Female_GeneticContributions_20210812$Total_Genetic)

Elm_Female_GeneticContributions_20210812[is.na(Elm_Female_GeneticContributions_20210812)] <- 0
```

##### Males

``` {r}
Elm_Male_All_Alive_GenCon_20210812 <- readRDS(file = "Elm_Male_All_Alive_GenCon_20210812.rds")
Elm_Male_Cohort_GenCon_20210812 <- readRDS(file = "Elm_Male_Cohort_GenCon_20210812.rds")
Elm_Male_Ind_GenCon_20210812 <- readRDS(file = "Elm_Male_Ind_GenCon_20210812.rds")

# Count number of indiviudals born/arrrived in each year
arrival_count <- t(Elm_Male_Cohort_GenCon_20210812[1,]) # number of individuals "arriving" each year
start_year <- as.numeric(gsub("Y","",colnames(Elm_Male_All_Alive_GenCon_20210812)[1]))
end_year <- as.numeric(gsub("Y","",colnames(Elm_Male_All_Alive_GenCon_20210812)[ncol(Elm_Male_All_Alive_GenCon_20210812)]))
rownames(arrival_count) <- start_year:end_year

arrival_count <- as.data.frame(arrival_count) 
arrival_count$year <- rownames(arrival_count)
years.data <- as.data.frame(arrival_count[!is.na(arrival_count$`1`) & arrival_count$`1`>0,])

# Individual genetic contributions ----------------------------------------

colnames(Elm_Male_All_Alive_GenCon_20210812) <- as.numeric(gsub("Y","",colnames(Elm_Male_All_Alive_GenCon_20210812)))

#Flips the data-set from wide to long
All_Alive_Contributions_20210812 <- gather(Elm_Male_All_Alive_GenCon_20210812[1,]) 
colnames(All_Alive_Contributions_20210812)<- c("Year", "Total_Genetic")
All_Alive_Contributions_20210812 <- as.data.frame(All_Alive_Contributions_20210812)
All_Alive_Contributions_20210812$Year <- as.numeric(All_Alive_Contributions_20210812$Year)

#Extract information about each individual born in the first year, and their genetic contributions to each year after 
#their birth. Then do this for each cohort in the dataset. Saving each as a new data frame

for(i in 1:nrow(years.data)) {
  year <- years.data[i,2]
  if(year<1658) {
    x <- data.frame(Elm_Male_Ind_GenCon_20210812[[paste("Y",year,sep = "")]])
    x$ID <- rownames(x)
    x <- reshape2::melt(x, id=c("ID"))
    x$Cohort <- as.numeric(year)
    x <- x[order(x$ID, x$variable),] 
    x$Year <- as.numeric(year):(as.numeric(year)+(ncol(Elm_Male_Cohort_GenCon_20210812)-1))
    assign(paste("Elm_Male_Genetic_Contributions_",year,sep=""),x) 
  }
  else{
    x <- data.frame(Elm_Male_Ind_GenCon_20210812[[paste("Y",year,sep = "")]])
    x$ID <- rownames(x)
    x <- reshape2::melt(x, id=c("ID"))
    x$Cohort <- as.numeric(year)
    x <- x[order(x$ID, x$variable),] 
    x$Year <- as.numeric(year):(as.numeric(year)+333)
    assign(paste("Elm_Male_Genetic_Contributions_",year,sep=""),x)
  }
  
}

for(i in 1:nrow(years.data)) { # gathers the names of these datasets in prep for gethering them all into one file
  year <- years.data[i,2]
  years.data$data[i] <- paste("Elm_Male_Genetic_Contributions_",year,sep="")
} 

#Combine all of the above datasets
Elm_Male_GeneticContributions_20210812 <- rbind(mget(years.data$data)) #puts all together in a list

Elm_Male_GeneticContributions_20210812 <- bind_rows(Elm_Male_GeneticContributions_20210812) #puts all together in a df

rm(list = ls()[grepl("Elm_Male_Genetic_Contributions_", ls())]) #remove all individual year objects

Elm_Male_GeneticContributions_20210812 <- Elm_Male_GeneticContributions_20210812[!Elm_Male_GeneticContributions_20210812$Year>end_year,] #remove all irrelevant years

colnames(Elm_Male_GeneticContributions_20210812)<- c("ID", "Relative_Year", "Contribution", "Cohort", "Year")

Elm_Male_GeneticContributions_20210812$Contribution <- as.numeric(Elm_Male_GeneticContributions_20210812$Contribution)

Elm_Male_GeneticContributions_20210812[is.na(Elm_Male_GeneticContributions_20210812)] <- 0

Elm_Male_GeneticContributions_20210812$Total_Genetic <- lapply(Elm_Male_GeneticContributions_20210812$Year, function(x) All_Alive_Contributions_20210812[match(x, All_Alive_Contributions_20210812$Year), "Total_Genetic"])

Elm_Male_GeneticContributions_20210812$Total_Genetic <- as.numeric(Elm_Male_GeneticContributions_20210812$Total_Genetic)
Elm_Male_GeneticContributions_20210812$Proportional <- as.numeric(Elm_Male_GeneticContributions_20210812$Contribution/Elm_Male_GeneticContributions_20210812$Total_Genetic)

Elm_Male_GeneticContributions_20210812[is.na(Elm_Male_GeneticContributions_20210812)] <- 0
```

Going from the output of the cluster run to the dataset for generating the plots. this needs sorting.

#### Correlation Plots

```{r}
Elm_Male_GeneticContributions_20210812 <- read.csv("Elm_Male_GeneticContributions_20210812.csv")
Elm_Female_GeneticContributions_20210812 <- read.csv("Elm_Female_GeneticContributions_20210812.csv")

Elm_Male_GeneticContributions_20210812$Sex <- "Male"
Elm_Female_GeneticContributions_20210812$Sex <- "Female"

Elm_GeneticContributions_20210812 <- rbind(Elm_Male_GeneticContributions_20210812,Elm_Female_GeneticContributions_20210812)

## recalculate total.genetic for both sexes
Elm_GeneticContributions_20210812 <- dplyr::select(Elm_GeneticContributions_20210812,-Total_Genetic)

start_year<- min(Elm_GeneticContributions_20210812$Year)
end_year <- min(c(max(Elm_GeneticContributions_20210812$Year[Elm_GeneticContributions_20210812$Sex=="Male"]),max(Elm_GeneticContributions_20210812$Year[Elm_GeneticContributions_20210812$Sex=="Female"])))

Year<- start_year:end_year
All_Alive_BS <- as.data.frame(Year)

All_Alive_BS$Total_Genetic <- "NA"

for(i in 1:length(Year)){ ### For each year after focal year
    year<- Year[i] ### get year (starting at the focal year)
    All_Alive_BS$Total_Genetic[i]<-length(with(data_elm_uni,IDp[which(arryear<(year+1) & depyear>(year-1))]))  ### get list of all individuals alive that year
}

Elm_GeneticContributions_20210812 <- left_join(Elm_GeneticContributions_20210812,All_Alive_BS,by="Year")

# Recalculate proportional
Elm_GeneticContributions_20210812$Proportional <- as.numeric(Elm_GeneticContributions_20210812$Contribution)/as.numeric(Elm_GeneticContributions_20210812$Total_Genetic)

```

```{r fig.show="hold", out.width="25%"}
summary(Elm_GeneticContributions_20210812) # this datafile is a tidied dataframe containin the genetic contributions (both proportional and absolute) of all individuals, for all years.

# Add 10-year cohorts
start_year<- min(Elm_GeneticContributions_20210812$Year)
end_year <- min(c(max(Elm_GeneticContributions_20210812$Year[Elm_GeneticContributions_20210812$Sex=="Male"]),max(Elm_GeneticContributions_20210812$Year[Elm_GeneticContributions_20210812$Sex=="Female"])))

Elm_GeneticContributions_20210812$cohort.10y <- 
  cut(Elm_GeneticContributions_20210812$Cohort, c(seq(start_year-1,max(Elm_GeneticContributions_20210812$Year),10)), labels = seq(start_year,max(Elm_GeneticContributions_20210812$Year)-6,10))

tempsubset <- subset(Elm_GeneticContributions_20210812, select = c("ID", "Year", "Relative_Year", "Proportional", "cohort.10y","Cohort"))
tempsubset$Relative_Year <- as.numeric(gsub("A","",tempsubset$Relative_Year))

# Estimate correlations
#Subset and make data wide again 
Stabilisation <- subset(tempsubset, select = c("ID", "Year","Proportional", "cohort.10y","Cohort"))
Stabilisation <- spread(Stabilisation, as.numeric(Year), as.numeric(Proportional))

cohort.10y <- as.numeric(unique(sort(as.character(Stabilisation$cohort.10y))))

for (i in 1:NROW(cohort.10y)){
  cohorts <- cohort.10y[i]:(cohort.10y[i]+9)
  Cohort <- cohort.10y[i]
  x <- Stabilisation[Stabilisation$Cohort==cohorts[10],]
  x <- as.data.frame(x[,c(as.character(Cohort:end_year))])
  Correlation_x <- data.frame(cor(x, method = c("pearson")))
  Correlation_x <- dplyr::select(Correlation_x,paste("X",end_year,sep=""))
  Correlation_x$Year <- rownames(Correlation_x)
  Correlation_x$Cohort <- as.numeric(cohorts[1])
  assign(paste("Correlation_",cohorts[1],sep=""),Correlation_x)
}

cohorts_data <- as.data.frame(cohort.10y)

for(i in 1:NROW(cohort.10y)){
  cohort <- cohort.10y[i]
  cohorts_data$correlation_data[i] <- paste("Correlation_",cohort,sep="")
}

#Combine all of the above datasets
Elm_Correlations <- rbind(mget(cohorts_data$correlation_data)) #puts all together in a list

Elm_Correlations<- bind_rows(Elm_Correlations) #puts all together in a df

rm(list = ls()[grepl("Correlation_", ls())]) #remove all individual year objects

Elm_Correlations$Relative_Year <- as.numeric(Elm_Correlations$Year)-Elm_Correlations$Cohort
Elm_Correlations$Relative_Final_Year <- end_year-as.numeric(Elm_Correlations$Year)

Elm_Correlations$Final_Year <- end_year
Stabilisation_Year <- round(Elm_Correlations$Final_Year[1]-(2*mean(na.omit(gen_time_elm$parentaggeatbirth))),0)# 64 as this is the duration of 2 generations

Elm_Correlations <- rename(Elm_Correlations,Correlation=paste("X",end_year,sep=""))

Elm_Correlations$Correlation <- as.numeric(Elm_Correlations$Correlation)

Elm_Correlations_Stabilised <- Elm_Correlations[Elm_Correlations$Year==Stabilisation_Year,]

Elm_Correlations_Stabilised$`Stabilised.95` <- Elm_Correlations_Stabilised$Correlation>=0.95
Elm_Correlations_Stabilised$`Stabilised.99` <- Elm_Correlations_Stabilised$Correlation>=0.9

write.csv(Elm_Correlations_Stabilised, "Elm_Correlations_Stabilised.csv") # tgives the correlation coefficients for cohorts 2 generations before final year

```

Table showing the extent of correlation in proportional genetic contributions for 10-year birth cohorts between the years 1927 and 1991 for Elm.

##### Visually 

We can also look at the correlations between each year and the final year for all years to see how this changes over time.

```{r fig.show="hold", out.width="25%"}

# for(i in 1:length(cohort.10y)) {
#   
#   #Plot every year separately
#   years.to.plot <- as.numeric(cohort.10y[i])
#   
#   data <- Elm_Correlations[Elm_Correlations$Cohort %in% years.to.plot,]
#   
#   print(ggplot(data, aes(x=as.numeric(Year), y=Correlation, group=Cohort)) +
#           geom_line(aes(color=Cohort))+
#           geom_point(aes(color=Cohort))+
#           geom_hline(yintercept=0.95, linetype="dashed", color = "black")+
#           geom_vline(xintercept=Stabilisation_Year, linetype="dashed", color = "black") +
#           ylim(c(0,1)) +
#           theme_bw() +
#           labs(y= "Correlation in expected genetic contribution", x = "Year"))
# }

#Plot all years together
start <- 1
end <- 10

years.to.plot <- as.numeric(cohort.10y[start:end])

data <- Elm_Correlations[Elm_Correlations$Cohort %in% years.to.plot,]
#
# pdf(file="Elm_female_correlation_plot_1600s.pdf",width = 12, height = 7.5)

p1 <- ggplot(data, aes(x=as.numeric(Year), y=Correlation, group=as.factor(Cohort))) +
  geom_line(aes(color=as.factor(Cohort)))+
  geom_point(aes(color=as.factor(Cohort)))+
  geom_hline(yintercept=0.95, linetype="dashed", color = "black")+
  geom_vline(xintercept=Stabilisation_Year, linetype="dashed", color = "black") +
  theme_bw() +
  ylim(c(0,1)) +
  labs(y= "Correlation in expected genetic contribution", x = "Year")

#Plot all years together
start <- 11
end <- 20

years.to.plot <- as.numeric(cohort.10y[start:end])

data <- Elm_Correlations[Elm_Correlations$Cohort %in% years.to.plot,]
#
# pdf(file="Elm_female_correlation_plot.pdf",width = 12, height = 7.5)
# pdf(file="Elm_female_correlation_plot_1700s.pdf",width = 12, height = 7.5)

p2 <- ggplot(data, aes(x=as.numeric(Year), y=Correlation, group=as.factor(Cohort))) +
  geom_line(aes(color=as.factor(Cohort)))+
  geom_point(aes(color=as.factor(Cohort)))+
  geom_hline(yintercept=0.95, linetype="dashed", color = "black")+
  geom_vline(xintercept=Stabilisation_Year, linetype="dashed", color = "black") +
  theme_bw() +
  ylim(c(0,1)) +
  labs(y= "Correlation in expected genetic contribution", x = "Year")

#Plot all years together
start <- 21
end <- 30

years.to.plot <- as.numeric(cohort.10y[start:end])

data <- Elm_Correlations[Elm_Correlations$Cohort %in% years.to.plot,]
#
# pdf(file="Elm_female_correlation_plot.pdf",width = 12, height = 7.5)

# pdf(file="Elm_female_correlation_plot_1800s.pdf",width = 12, height = 7.5)

p3 <- ggplot(data, aes(x=as.numeric(Year), y=Correlation, group=as.factor(Cohort))) +
  geom_line(aes(color=as.factor(Cohort)))+
  geom_point(aes(color=as.factor(Cohort)))+
  geom_hline(yintercept=0.95, linetype="dashed", color = "black")+
  geom_vline(xintercept=Stabilisation_Year, linetype="dashed", color = "black") +
  theme_bw() +
  ylim(c(0,1)) +
  labs(y= "Correlation in expected genetic contribution", x = "Year")



#Plot all years together
start <- 31
end <- 42

years.to.plot <- as.numeric(cohort.10y[start:end])

data <- Elm_Correlations[Elm_Correlations$Cohort %in% years.to.plot,]
#
# pdf(file="Elm_female_correlation_plot.pdf",width = 12, height = 7.5)

# pdf(file="Elm_female_correlation_plot_1900s.pdf",width = 12, height = 7.5)

p4 <- ggplot(data, aes(x=as.numeric(Year), y=Correlation, group=as.factor(Cohort))) +
  geom_line(aes(color=as.factor(Cohort)))+
  geom_point(aes(color=as.factor(Cohort)))+
  geom_hline(yintercept=0.95, linetype="dashed", color = "black")+
  geom_vline(xintercept=Stabilisation_Year, linetype="dashed", color = "black") +
  theme_bw() +
  ylim(c(0,1)) +
  labs(y= "Correlation in expected genetic contribution", x = "Year")


print(p1)
print(p2)
print(p3)
print(p4)

```

#### Subset of those chosen for analysis

```{r}

1990-mean(na.omit(gen_time_elm$parentaggeatbirth))*8

# Therefore include only the cohorts before 1734

#Plot all years together
start <- 1
end <- 16

years.to.plot <- as.numeric(cohort.10y[start:end])

data <- Elm_Correlations[Elm_Correlations$Cohort %in% years.to.plot,]

data$Cohort <- as.factor(paste(data$Cohort,data$Cohort+9,sep = "-"))

SF1b <- ggplot(data, aes(x=as.numeric(Year), y=Correlation, group=Cohort)) +
  geom_line(aes(color=Cohort))+
  geom_point(aes(color=Cohort))+
  scale_color_viridis_d()  +
  geom_hline(yintercept=0.95, linetype="dashed", color = "black")+
  geom_vline(xintercept=Stabilisation_Year, linetype="dashed", color = "black") +
  ggtitle("Elm")+
  theme_bw() +
  ylim(c(0,1)) +
  labs(y= "", x = "Year")
SF1b

```
All above threshold of 0.95 by 1927


##### Plot of those removed

```{r}

1990-mean(na.omit(gen_time_elm$parentaggeatbirth))*8

# Therefore include only the cohorts before 1734

#Plot all years together
start <- 17
end <- 42

years.to.plot <- as.numeric(cohort.10y[start:end])

data <- Elm_Correlations[Elm_Correlations$Cohort %in% years.to.plot,]

data$Cohort <- as.factor(paste(data$Cohort,data$Cohort+9,sep = "-"))

SF1d <- ggplot(data, aes(x=as.numeric(Year), y=Correlation, group=Cohort)) +
  geom_line(aes(color=Cohort))+
  geom_point(aes(color=Cohort))+
  scale_color_viridis_d()  +
  geom_hline(yintercept=0.95, linetype="dashed", color = "black")+
  geom_vline(xintercept=Stabilisation_Year, linetype="dashed", color = "black") +
  ggtitle("Elm")+
  theme_bw() +
  ylim(c(0,1)) +
  labs(y= "", x = "Year")
SF1d

```

#### Proportional genetic contributions overtime

```{r}
Elm_Male_GeneticContributions_20210812 <- read.csv("Elm_Male_GeneticContributions_20210812.csv")
Elm_Female_GeneticContributions_20210812 <- read.csv("Elm_Female_GeneticContributions_20210812.csv")

Elm_Male_GeneticContributions_20210812$Sex <- "Male"
Elm_Female_GeneticContributions_20210812$Sex <- "Female"

Elm_GeneticContributions_20210812 <- rbind(Elm_Male_GeneticContributions_20210812,Elm_Female_GeneticContributions_20210812)

## recalculate total.genetic for both sexes
Elm_GeneticContributions_20210812 <- dplyr::select(Elm_GeneticContributions_20210812,-Total_Genetic)

start_year<- min(Elm_GeneticContributions_20210812$Year)
end_year <- min(c(max(Elm_GeneticContributions_20210812$Year[Elm_GeneticContributions_20210812$Sex=="Male"]),max(Elm_GeneticContributions_20210812$Year[Elm_GeneticContributions_20210812$Sex=="Female"])))

Year<- start_year:end_year
All_Alive_BS <- as.data.frame(Year)

All_Alive_BS$Total_Genetic <- "NA"

for(i in 1:length(Year)){ ### For each year after focal year
    year<- Year[i] ### get year (starting at the focal year)
    All_Alive_BS$Total_Genetic[i]<-length(with(data_elm_uni,IDp[which(arryear<(year+1) & depyear>(year-1))]))  ### get list of all individuals alive that year
}

Elm_GeneticContributions_20210812 <- left_join(Elm_GeneticContributions_20210812,All_Alive_BS,by="Year")

# Recalculate proportional
Elm_GeneticContributions_20210812$Proportional <- as.numeric(Elm_GeneticContributions_20210812$Contribution)/as.numeric(Elm_GeneticContributions_20210812$Total_Genetic)

# Add 10-year cohorts
start_year<- min(Elm_GeneticContributions_20210812$Year)
end_year <- min(c(max(Elm_GeneticContributions_20210812$Year[Elm_GeneticContributions_20210812$Sex=="Male"]),max(Elm_GeneticContributions_20210812$Year[Elm_GeneticContributions_20210812$Sex=="Female"])))

Elm_GeneticContributions_20210812$cohort.10y <- 
  cut(Elm_GeneticContributions_20210812$Cohort, c(seq(start_year-1,max(Elm_GeneticContributions_20210812$Year),10)), labels = seq(start_year,max(Elm_GeneticContributions_20210812$Year)-6,10))

Elm_GeneticContributions_10y.cohort <- Elm_GeneticContributions_20210812

Elm_GeneticContributions_10y.cohort$cohort.10y <- as.factor(paste(Elm_GeneticContributions_10y.cohort$cohort.10y, as.numeric(as.character(Elm_GeneticContributions_10y.cohort$cohort.10y))+9,sep = "-"))

Elm_GeneticContributions_10y.cohort <- Elm_GeneticContributions_10y.cohort %>% 
  group_by(cohort.10y,Year) %>% 
  summarise(Proportional.cohort=sum(Proportional))

#Plot all years together
start <- 1
end <- 16

years.to.plot <- as.character(unique(Elm_GeneticContributions_10y.cohort$cohort.10y)[start:end])
years.to.plot 

Elm_GeneticContributions_10y.cohort <- Elm_GeneticContributions_10y.cohort[Elm_GeneticContributions_10y.cohort$cohort.10y %in% years.to.plot,]

Elm_GeneticContributions_10y.cohort$Cohort <- Elm_GeneticContributions_10y.cohort$cohort.10y

SF2b <- 
  ggplot(Elm_GeneticContributions_10y.cohort, aes(x=as.numeric(Year), y=Proportional.cohort, group=Cohort)) +
  geom_line(aes(color=Cohort))+
  geom_point(aes(color=Cohort))+
  scale_color_viridis_d()  +
  theme_bw() +
  ggtitle("Elm") +
  xlim(c(1600,1990)) +
  ylim(c(0,0.6)) +
  labs(y= "", x = "Year")
SF2b
```

We can also look at this individually

```{r fig.show="hold", out.width="25%"}

tempsubset <- subset(Elm_GeneticContributions_20210812, select = c("ID", "Year", "Relative_Year", "Proportional", "cohort.10y","Cohort"))
tempsubset$Relative_Year <- as.numeric(gsub("A","",tempsubset$Relative_Year))

Stabilisation <- subset(tempsubset, select = c("ID", "Year","Proportional", "cohort.10y","Cohort"))
Stabilisation$cohort.10y <- as.factor(Stabilisation$cohort.10y)

for(i in 3:length(cohort.10y)) {
  cohort <-as.numeric(cohort.10y[i])
  data <- Stabilisation[Stabilisation$cohort.10y==cohort,]
  
  if(cohort==cohort.10y[3]){
  plot <- ggplot(data, aes(x=as.numeric(Year), y=Proportional, group=as.factor(ID))) +
  geom_line(aes(color=as.factor(ID)),alpha=0.5,size=0.5)+
  theme_bw() +
  ylim(c(0,.03)) +
  labs(y= paste(paste("Proportional genetic contribution for the " ,cohort), " 10-birth cohort"), x = paste("Years, for cohort",cohort,sep=" ")) +
  theme(legend.position = "none")
  
print(plot)  
    
  }
  else{
plot <- ggplot(data, aes(x=as.numeric(Year), y=Proportional, group=as.factor(ID))) +
  geom_line(aes(color=as.factor(ID)),alpha=0.5,size=0.5)+
  theme_bw() +
  # ylim(c(0,.07)) +
  labs(y= paste(paste("Proportional genetic contribution for the " ,cohort), " 10-birth cohort"), x = paste("Years, for cohort",cohort,sep=" ")) +
  theme(legend.position = "none")
  
print(plot)
}
}

```

### Linthal

#### Data preperation

Going from the output of the cluster run to the dataset for generating the plots. this needs sorting.

```{r fig.show="hold", out.width="10%"}

Lin_Female_All_Alive_GenCon_20210812 <- readRDS(file = "Lin_Female_All_Alive_GenCon_20210812.rds")
Lin_Female_Cohort_GenCon_20210812 <- readRDS(file = "Lin_Female_Cohort_GenCon_20210812.rds")
Lin_Female_Ind_GenCon_20210812 <- readRDS(file = "Lin_Female_Ind_GenCon_20210812.rds")

# Count number of indiviudals born/arrrived in each year
arrival_count <- t(Lin_Female_Cohort_GenCon_20210812[1,]) # number of individuals "arriving" each year
start_year <- as.numeric(gsub("Y","",colnames(Lin_Female_All_Alive_GenCon_20210812)[1]))
end_year <- as.numeric(gsub("Y","",colnames(Lin_Female_All_Alive_GenCon_20210812)[ncol(Lin_Female_All_Alive_GenCon_20210812)]))
rownames(arrival_count) <- start_year:end_year

arrival_count <- as.data.frame(arrival_count) 
arrival_count$year <- rownames(arrival_count)
years.data <- as.data.frame(arrival_count[!is.na(arrival_count$`1`) & arrival_count$`1`>0,])

# Individual genetic contributions ----------------------------------------

colnames(Lin_Female_All_Alive_GenCon_20210812) <- as.numeric(gsub("Y","",colnames(Lin_Female_All_Alive_GenCon_20210812)))

#Flips the data-set from wide to long
All_Alive_Contributions_20210812 <- gather(Lin_Female_All_Alive_GenCon_20210812[1,]) 
colnames(All_Alive_Contributions_20210812)<- c("Year", "Total_Genetic")
All_Alive_Contributions_20210812 <- as.data.frame(All_Alive_Contributions_20210812)
All_Alive_Contributions_20210812$Year <- as.numeric(All_Alive_Contributions_20210812$Year)

#Extract information about each individual born in the first year, and their genetic contributions to each year after 
#their birth. Then do this for each cohort in the dataset. Saving each as a new data frame

# This is a bit tricky in the stitched together data. for the Year argument you must set it to:
# as.numeric(year):(as.numeric(year)+([length of ind_gen_con df for that set of years]-1))

for(i in 1:nrow(years.data)) {
  year <- years.data[i,2]
  if(year<1621) {
    x <- data.frame(Lin_Female_Ind_GenCon_20210812[[paste("Y",year,sep = "")]])
    x$ID <- rownames(x)
    x <- reshape2::melt(x, id=c("ID"))
    x$Cohort <- as.numeric(year)
    x <- x[order(x$ID, x$variable),] 
    x$Year <- as.numeric(year):(as.numeric(year)+(ncol(Lin_Female_Cohort_GenCon_20210812)-1))
    assign(paste("Lin_Female_Genetic_Contributions_",year,sep=""),x) 
  }
  else{if(year<1732) {
    x <- data.frame(Lin_Female_Ind_GenCon_20210812[[paste("Y",year,sep = "")]])
    x$ID <- rownames(x)
    x <- reshape2::melt(x, id=c("ID"))
    x$Cohort <- as.numeric(year)
    x <- x[order(x$ID, x$variable),] 
    x$Year <- as.numeric(year):(as.numeric(year)+(373-1))
    assign(paste("Lin_Female_Genetic_Contributions_",year,sep=""),x) 
  }
    else{
    x <- data.frame(Lin_Female_Ind_GenCon_20210812[[paste("Y",year,sep = "")]])
    x$ID <- rownames(x)
    x <- reshape2::melt(x, id=c("ID"))
    x$Cohort <- as.numeric(year)
    x <- x[order(x$ID, x$variable),] 
    x$Year <- as.numeric(year):(as.numeric(year)+(262-1))
    assign(paste("Lin_Female_Genetic_Contributions_",year,sep=""),x) 
    }
  }
}

for(i in 1:nrow(years.data)) { # gathers the names of these datasets in prep for gethering them all into one file
  year <- years.data[i,2]
  years.data$data[i] <- paste("Lin_Female_Genetic_Contributions_",year,sep="")
} 

#Combine all of the above datasets
Lin_Female_GeneticContributions_20210812 <- rbind(mget(years.data$data)) #puts all together in a list

Lin_Female_GeneticContributions_20210812 <- bind_rows(Lin_Female_GeneticContributions_20210812) #puts all together in a df

rm(list = ls()[grepl("Lin_Female_Genetic_Contributions_", ls())]) #remove all individual year objects

Lin_Female_GeneticContributions_20210812 <- Lin_Female_GeneticContributions_20210812[!Lin_Female_GeneticContributions_20210812$Year>end_year,] #remove all irrelevant years

colnames(Lin_Female_GeneticContributions_20210812)<- c("ID", "Relative_Year", "Contribution", "Cohort", "Year")

Lin_Female_GeneticContributions_20210812$Contribution <- as.numeric(Lin_Female_GeneticContributions_20210812$Contribution)

Lin_Female_GeneticContributions_20210812[is.na(Lin_Female_GeneticContributions_20210812)] <- 0

Lin_Female_GeneticContributions_20210812$Total_Genetic <- lapply(Lin_Female_GeneticContributions_20210812$Year, function(x) All_Alive_Contributions_20210812[match(x, All_Alive_Contributions_20210812$Year), "Total_Genetic"])

Lin_Female_GeneticContributions_20210812$Total_Genetic <- as.numeric(Lin_Female_GeneticContributions_20210812$Total_Genetic)
Lin_Female_GeneticContributions_20210812$Proportional <- as.numeric(Lin_Female_GeneticContributions_20210812$Contribution/Lin_Female_GeneticContributions_20210812$Total_Genetic)

Lin_Female_GeneticContributions_20210812[is.na(Lin_Female_GeneticContributions_20210812)] <- 0
write.csv(Lin_Female_GeneticContributions_20210812,"Lin_Female_GeneticContributions_20210812.csv")
```


```{r }
Lin_Male_All_Alive_GenCon_20210812 <- readRDS(file = "Lin_Male_All_Alive_GenCon_20210812.rds")
Lin_Male_Cohort_GenCon_20210812 <- readRDS(file = "Lin_Male_Cohort_GenCon_20210812.rds")
Lin_Male_Ind_GenCon_20210812 <- readRDS(file = "Lin_Male_Ind_GenCon_20210812.rds")

# Count number of indiviudals born/arrrived in each year
arrival_count <- t(Lin_Male_Cohort_GenCon_20210812[1,]) # number of individuals "arriving" each year
start_year <- as.numeric(gsub("Y","",colnames(Lin_Male_All_Alive_GenCon_20210812)[1]))
end_year <- as.numeric(gsub("Y","",colnames(Lin_Male_All_Alive_GenCon_20210812)[ncol(Lin_Male_All_Alive_GenCon_20210812)]))
rownames(arrival_count) <- start_year:end_year

arrival_count <- as.data.frame(arrival_count) 
arrival_count$year <- rownames(arrival_count)
years.data <- as.data.frame(arrival_count[!is.na(arrival_count$`1`) & arrival_count$`1`>0,])

# Individual genetic contributions ----------------------------------------

colnames(Lin_Male_All_Alive_GenCon_20210812) <- as.numeric(gsub("Y","",colnames(Lin_Male_All_Alive_GenCon_20210812)))

#Flips the data-set from wide to long
All_Alive_Contributions_20210812 <- gather(Lin_Male_All_Alive_GenCon_20210812[1,]) 
colnames(All_Alive_Contributions_20210812)<- c("Year", "Total_Genetic")
All_Alive_Contributions_20210812 <- as.data.frame(All_Alive_Contributions_20210812)
All_Alive_Contributions_20210812$Year <- as.numeric(All_Alive_Contributions_20210812$Year)

#Extract information about each individual born in the first year, and their genetic contributions to each year after 
#their birth. Then do this for each cohort in the dataset. Saving each as a new data frame

# This is a bit tricky in the stitched together data. for the Year argument you must set it to:
# as.numeric(year):(as.numeric(year)+([length of ind_gen_con df for that set of years]-1))

for(i in 1:nrow(years.data)) {
  year <- years.data[i,2]
  if(year<1637) {
    x <- data.frame(Lin_Male_Ind_GenCon_20210812[[paste("Y",year,sep = "")]])
    x$ID <- rownames(x)
    x <- reshape2::melt(x, id=c("ID"))
    x$Cohort <- as.numeric(year)
    x <- x[order(x$ID, x$variable),] 
    x$Year <- as.numeric(year):(as.numeric(year)+(ncol(Lin_Male_Cohort_GenCon_20210812)-1))
    assign(paste("Lin_Male_Genetic_Contributions_",year,sep=""),x) 
  }
  else{if(year<1790) {
    x <- data.frame(Lin_Male_Ind_GenCon_20210812[[paste("Y",year,sep = "")]])
    x$ID <- rownames(x)
    x <- reshape2::melt(x, id=c("ID"))
    x$Cohort <- as.numeric(year)
    x <- x[order(x$ID, x$variable),] 
    x$Year <- as.numeric(year):(as.numeric(year)+(354-1))
    assign(paste("Lin_Male_Genetic_Contributions_",year,sep=""),x) 
  }
  else{if(year<1845) {
    x <- data.frame(Lin_Male_Ind_GenCon_20210812[[paste("Y",year,sep = "")]])
    x$ID <- rownames(x)
    x <- reshape2::melt(x, id=c("ID"))
    x$Cohort <- as.numeric(year)
    x <- x[order(x$ID, x$variable),] 
    x$Year <- as.numeric(year):(as.numeric(year)+(201-1))
    assign(paste("Lin_Male_Genetic_Contributions_",year,sep=""),x) 
  }
    else{
    x <- data.frame(Lin_Male_Ind_GenCon_20210812[[paste("Y",year,sep = "")]])
    x$ID <- rownames(x)
    x <- reshape2::melt(x, id=c("ID"))
    x$Cohort <- as.numeric(year)
    x <- x[order(x$ID, x$variable),] 
    x$Year <- as.numeric(year):(as.numeric(year)+(147-1))
    assign(paste("Lin_Male_Genetic_Contributions_",year,sep=""),x) 
    }
  }
  }
}

for(i in 1:nrow(years.data)) { # gathers the names of these datasets in prep for gethering them all into one file
  year <- years.data[i,2]
  years.data$data[i] <- paste("Lin_Male_Genetic_Contributions_",year,sep="")
} 

#Combine all of the above datasets
Lin_Male_GeneticContributions_20210812 <- rbind(mget(years.data$data)) #puts all together in a list

Lin_Male_GeneticContributions_20210812 <- bind_rows(Lin_Male_GeneticContributions_20210812) #puts all together in a df

rm(list = ls()[grepl("Lin_Male_Genetic_Contributions_", ls())]) #remove all individual year objects

Lin_Male_GeneticContributions_20210812 <- Lin_Male_GeneticContributions_20210812[!Lin_Male_GeneticContributions_20210812$Year>end_year,] #remove all irrelevant years

colnames(Lin_Male_GeneticContributions_20210812)<- c("ID", "Relative_Year", "Contribution", "Cohort", "Year")

Lin_Male_GeneticContributions_20210812$Contribution <- as.numeric(Lin_Male_GeneticContributions_20210812$Contribution)

Lin_Male_GeneticContributions_20210812[is.na(Lin_Male_GeneticContributions_20210812)] <- 0

Lin_Male_GeneticContributions_20210812$Total_Genetic <- lapply(Lin_Male_GeneticContributions_20210812$Year, function(x) All_Alive_Contributions_20210812[match(x, All_Alive_Contributions_20210812$Year), "Total_Genetic"])

Lin_Male_GeneticContributions_20210812$Total_Genetic <- as.numeric(Lin_Male_GeneticContributions_20210812$Total_Genetic)
Lin_Male_GeneticContributions_20210812$Proportional <- as.numeric(Lin_Male_GeneticContributions_20210812$Contribution/Lin_Male_GeneticContributions_20210812$Total_Genetic)

Lin_Male_GeneticContributions_20210812[is.na(Lin_Male_GeneticContributions_20210812)] <- 0

write.csv(Lin_Male_GeneticContributions_20210812,"Lin_Male_GeneticContributions_20210812.csv")

```

#### Correlation Plots

```{r}
Lin_Male_GeneticContributions_20210812 <- read.csv("Lin_Male_GeneticContributions_20210812.csv")
Lin_Female_GeneticContributions_20210812 <- read.csv("Lin_Female_GeneticContributions_20210812.csv")

Lin_Male_GeneticContributions_20210812$Sex <- "Male"
Lin_Female_GeneticContributions_20210812$Sex <- "Female"

Lin_GeneticContributions_20210812 <- rbind(Lin_Male_GeneticContributions_20210812,Lin_Female_GeneticContributions_20210812)

## recalculate total.genetic for both sexes
Lin_GeneticContributions_20210812 <- dplyr::select(Lin_GeneticContributions_20210812,-Total_Genetic)

start_year<- min(Lin_GeneticContributions_20210812$Year)
end_year <- min(c(max(Lin_GeneticContributions_20210812$Year[Lin_GeneticContributions_20210812$Sex=="Male"]),max(Lin_GeneticContributions_20210812$Year[Lin_GeneticContributions_20210812$Sex=="Female"])))

Year<- start_year:end_year
All_Alive_BS <- as.data.frame(Year)

All_Alive_BS$Total_Genetic <- "NA"

for(i in 1:length(Year)){ ### For each year after focal year
    year<- Year[i] ### get year (starting at the focal year)
    All_Alive_BS$Total_Genetic[i]<-length(with(data_lin_uni,IDp[which(arryear<(year+1) & depyear>(year-1))]))  ### get list of all individuals alive that year
}

Lin_GeneticContributions_20210812 <- left_join(Lin_GeneticContributions_20210812,All_Alive_BS,by="Year")

# Recalculate proportional
Lin_GeneticContributions_20210812$Proportional <- as.numeric(Lin_GeneticContributions_20210812$Contribution)/as.numeric(Lin_GeneticContributions_20210812$Total_Genetic)

```

```{r fig.show="hold", out.width="25%"}
summary(Lin_Female_GeneticContributions_20210812) # this datafile is a tidied dataframe containing the genetic contributions (both proportional and absolute) of all individuals, for all years.

# Add 10-year cohorts
start_year<- min(Lin_GeneticContributions_20210812$Year)
end_year <- min(c(max(Lin_GeneticContributions_20210812$Year[Lin_GeneticContributions_20210812$Sex=="Male"]),max(Lin_GeneticContributions_20210812$Year[Lin_GeneticContributions_20210812$Sex=="Female"])))

Lin_GeneticContributions_20210812$cohort.10y <- 
  cut(Lin_GeneticContributions_20210812$Cohort, c(seq(start_year-1,max(Lin_GeneticContributions_20210812$Year),10)), labels = seq(start_year,max(Lin_GeneticContributions_20210812$Year)-6,10))

tempsubset <- subset(Lin_GeneticContributions_20210812, select = c("ID", "Year", "Relative_Year", "Proportional", "cohort.10y","Cohort"))
tempsubset$Relative_Year <- as.numeric(gsub("A","",tempsubset$Relative_Year))

# Estimate correlations
#Subset and make data wide again 
Stabilisation <- subset(tempsubset, select = c("ID", "Year","Proportional", "cohort.10y","Cohort"))
Stabilisation <- spread(Stabilisation, as.numeric(Year), as.numeric(Proportional))

cohort.10y <- as.numeric(unique(sort(as.character(Stabilisation$cohort.10y))))

for (i in 1:NROW(cohort.10y)){
  cohorts <- cohort.10y[i]:(cohort.10y[i]+9)
  Cohort <- cohort.10y[i]
  x <- Stabilisation[Stabilisation$Cohort==cohorts[10],]
  x <- as.data.frame(x[,c(as.character(Cohort:end_year))])
  Correlation_x <- data.frame(cor(x, method = c("pearson")))
  Correlation_x <- dplyr::select(Correlation_x,paste("X",end_year,sep=""))
  Correlation_x$Year <- rownames(Correlation_x)
  Correlation_x$Cohort <- as.numeric(cohorts[1])
  assign(paste("Correlation_",cohorts[1],sep=""),Correlation_x)
}

cohorts_data <- as.data.frame(cohort.10y)

for(i in 1:NROW(cohort.10y)){
  cohort <- cohort.10y[i]
  cohorts_data$correlation_data[i] <- paste("Correlation_",cohort,sep="")
}
#Combine all of the above datasets
Lin_Correlations <- rbind(mget(cohorts_data$correlation_data)) #puts all together in a list

Lin_Correlations<- bind_rows(Lin_Correlations) #puts all together in a df

rm(list = ls()[grepl("Correlation_", ls())]) #remove all individual year objects

Lin_Correlations$Relative_Year <- as.numeric(Lin_Correlations$Year)-Lin_Correlations$Cohort
Lin_Correlations$Relative_Final_Year <- end_year-as.numeric(Lin_Correlations$Year)

Lin_Correlations$Final_Year <- end_year
Stabilisation_Year <- round(Lin_Correlations$Final_Year[1]-(2*mean(na.omit(gen_time_lin$parentaggeatbirth))),0)# 64 as this is the duration of 2 generations

Lin_Correlations <- rename(Lin_Correlations,Correlation=paste("X",end_year,sep=""))

Lin_Correlations$Correlation <- as.numeric(Lin_Correlations$Correlation)

Lin_Correlations_Stabilised <- Lin_Correlations[Lin_Correlations$Year==Stabilisation_Year,]

Lin_Correlations_Stabilised$`Stabilised.95` <- Lin_Correlations_Stabilised$Correlation>=0.95
Lin_Correlations_Stabilised$`Stabilised.99` <- Lin_Correlations_Stabilised$Correlation>=0.99

write.csv(Lin_Correlations_Stabilised, "Lin_Correlations_Stabilised.csv")
```

Table showing the extent of correlation in proportional genetic contributions for 10-year birth cohorts between the years 1927 and 1991 for Lin.

##### Visually 

We can also look at the correlations between each year and the final year for all years to see how this changes over time.

```{r fig.show="hold", out.width="25%"}

#Plot all years together
start <- 1
end <- 10

years.to.plot <- as.numeric(cohort.10y[start:end])

data <- Lin_Correlations[Lin_Correlations$Cohort %in% years.to.plot,]
#
# pdf(file="Lin_female_correlation_plot_1600s.pdf",width = 12, height = 7.5)

p1 <- ggplot(data, aes(x=as.numeric(Year), y=Correlation, group=as.factor(Cohort))) +
  geom_line(aes(color=as.factor(Cohort)))+
  geom_point(aes(color=as.factor(Cohort)))+
  geom_hline(yintercept=0.95, linetype="dashed", color = "black")+
  geom_vline(xintercept=Stabilisation_Year, linetype="dashed", color = "black") +
  theme_bw() +
  ylim(c(0,1)) +
  labs(y= "Correlation in expected genetic contribution", x = "Year")

#Plot all years together
start <- 11
end <- 20

years.to.plot <- as.numeric(cohort.10y[start:end])

data <- Lin_Correlations[Lin_Correlations$Cohort %in% years.to.plot,]
#
# pdf(file="Lin_female_correlation_plot.pdf",width = 12, height = 7.5)
# pdf(file="Lin_female_correlation_plot_1700s.pdf",width = 12, height = 7.5)

p2 <- ggplot(data, aes(x=as.numeric(Year), y=Correlation, group=as.factor(Cohort))) +
  geom_line(aes(color=as.factor(Cohort)))+
  geom_point(aes(color=as.factor(Cohort)))+
  geom_hline(yintercept=0.95, linetype="dashed", color = "black")+
  geom_vline(xintercept=Stabilisation_Year, linetype="dashed", color = "black") +
  theme_bw() +
  ylim(c(0,1)) +
  labs(y= "Correlation in expected genetic contribution", x = "Year")

#Plot all years together
start <- 21
end <- 30

years.to.plot <- as.numeric(cohort.10y[start:end])

data <- Lin_Correlations[Lin_Correlations$Cohort %in% years.to.plot,]
#
# pdf(file="Lin_female_correlation_plot.pdf",width = 12, height = 7.5)

# pdf(file="Lin_female_correlation_plot_1800s.pdf",width = 12, height = 7.5)

p3 <- ggplot(data, aes(x=as.numeric(Year), y=Correlation, group=as.factor(Cohort))) +
  geom_line(aes(color=as.factor(Cohort)))+
  geom_point(aes(color=as.factor(Cohort)))+
  geom_hline(yintercept=0.95, linetype="dashed", color = "black")+
  geom_vline(xintercept=Stabilisation_Year, linetype="dashed", color = "black") +
  theme_bw() +
  ylim(c(0,1)) +
  labs(y= "Correlation in expected genetic contribution", x = "Year")



#Plot all years together
start <- 31
end <- 42

years.to.plot <- as.numeric(cohort.10y[start:end])

data <- Lin_Correlations[Lin_Correlations$Cohort %in% years.to.plot,]
#
# pdf(file="Lin_female_correlation_plot.pdf",width = 12, height = 7.5)

# pdf(file="Lin_female_correlation_plot_1900s.pdf",width = 12, height = 7.5)

p4 <- ggplot(data, aes(x=as.numeric(Year), y=Correlation, group=as.factor(Cohort))) +
  geom_line(aes(color=as.factor(Cohort)))+
  geom_point(aes(color=as.factor(Cohort)))+
  geom_hline(yintercept=0.95, linetype="dashed", color = "black")+
  geom_vline(xintercept=Stabilisation_Year, linetype="dashed", color = "black") +
  theme_bw() +
  ylim(c(0,1)) +
  labs(y= "Correlation in expected genetic contribution", x = "Year")


print(p1)
print(p2)
print(p3)
print(p4)

```

## Subset of those chosen for analysis

```{r}

1990-mean(na.omit(gen_time_lin$parentaggeatbirth))*8

# Therefore include only the cohorts before 1734

#Plot all years together
start <- 1
end <- 14

years.to.plot <- as.numeric(cohort.10y[start:end])

data <- Lin_Correlations[Lin_Correlations$Cohort %in% years.to.plot,]

data$Cohort <- as.factor(paste(data$Cohort,data$Cohort+9,sep = "-"))

#
# pdf(file="lin_female_correlation_plot_1600s.pdf",width = 12, height = 7.5)

library(gcookbook)  # Load gcookbook for the uspopage data set

SF1a <- ggplot(data, aes(x=as.numeric(Year), y=Correlation, group=Cohort)) +
  geom_line(aes(color=Cohort))+
  geom_point(aes(color=Cohort))+
  scale_color_viridis_d()  +
  geom_hline(yintercept=0.95, linetype="dashed", color = "black")+
  geom_vline(xintercept=Stabilisation_Year, linetype="dashed", color = "black") +
  ggtitle("Linthal")+
  theme_bw() +
  ylim(c(0,1)) +
  labs(y= "", x = "Year")
SF1a
```

And those excluded

```{r}

1990-mean(na.omit(gen_time_lin$parentaggeatbirth))*8

# Therefore include only the cohorts before 1734

#Plot all years together
start <- 15
end <- 44

years.to.plot <- as.numeric(cohort.10y[start:end])

data <- Lin_Correlations[Lin_Correlations$Cohort %in% years.to.plot,]

data$Cohort <- as.factor(paste(data$Cohort,data$Cohort+9,sep = "-"))

#
# pdf(file="lin_female_correlation_plot_1600s.pdf",width = 12, height = 7.5)

library(gcookbook)  # Load gcookbook for the uspopage data set

SF1c <- ggplot(data, aes(x=as.numeric(Year), y=Correlation, group=Cohort)) +
  geom_line(aes(color=Cohort))+
  geom_point(aes(color=Cohort))+
  scale_color_viridis_d()  +
  geom_hline(yintercept=0.95, linetype="dashed", color = "black")+
  geom_vline(xintercept=Stabilisation_Year, linetype="dashed", color = "black") +
  theme_bw() +
  ggtitle("Linthal")+ 
  ylim(c(0,1)) +
  labs(y= "", x = "Year")
SF1c

```

All above threshold of 0.95 by 1927

#### Proportional genetic contributions overtime

```{r}
Lin_Male_GeneticContributions_20210812 <- read.csv("Lin_Male_GeneticContributions_20210812.csv")
Lin_Female_GeneticContributions_20210812 <- read.csv("Lin_Female_GeneticContributions_20210812.csv")

Lin_Male_GeneticContributions_20210812$Sex <- "Male"
Lin_Female_GeneticContributions_20210812$Sex <- "Female"

Lin_GeneticContributions_20210812 <- rbind(Lin_Male_GeneticContributions_20210812,Lin_Female_GeneticContributions_20210812)

## recalculate total.genetic for both sexes
Lin_GeneticContributions_20210812 <- dplyr::select(Lin_GeneticContributions_20210812,-Total_Genetic)

start_year<- min(Lin_GeneticContributions_20210812$Year)
end_year <- min(c(max(Lin_GeneticContributions_20210812$Year[Lin_GeneticContributions_20210812$Sex=="Male"]),max(Lin_GeneticContributions_20210812$Year[Lin_GeneticContributions_20210812$Sex=="Female"])))

Year<- start_year:end_year
All_Alive_BS <- as.data.frame(Year)

All_Alive_BS$Total_Genetic <- "NA"

for(i in 1:length(Year)){ ### For each year after focal year
    year<- Year[i] ### get year (starting at the focal year)
    All_Alive_BS$Total_Genetic[i]<-length(with(data_lin_uni,IDp[which(arryear<(year+1) & depyear>(year-1))]))  ### get list of all individuals alive that year
}

Lin_GeneticContributions_20210812 <- left_join(Lin_GeneticContributions_20210812,All_Alive_BS,by="Year")

# Recalculate proportional
Lin_GeneticContributions_20210812$Proportional <- as.numeric(Lin_GeneticContributions_20210812$Contribution)/as.numeric(Lin_GeneticContributions_20210812$Total_Genetic)

# Add 10-year cohorts
start_year<- min(Lin_GeneticContributions_20210812$Year)
end_year <- min(c(max(Lin_GeneticContributions_20210812$Year[Lin_GeneticContributions_20210812$Sex=="Male"]),max(Lin_GeneticContributions_20210812$Year[Lin_GeneticContributions_20210812$Sex=="Female"])))

Lin_GeneticContributions_20210812$cohort.10y <- 
  cut(Lin_GeneticContributions_20210812$Cohort, c(seq(start_year-1,max(Lin_GeneticContributions_20210812$Year),10)), labels = seq(start_year,max(Lin_GeneticContributions_20210812$Year)-6,10))

Lin_GeneticContributions_10y.cohort <- Lin_GeneticContributions_20210812

Lin_GeneticContributions_10y.cohort$cohort.10y <- as.factor(paste(Lin_GeneticContributions_10y.cohort$cohort.10y, as.numeric(as.character(Lin_GeneticContributions_10y.cohort$cohort.10y))+9,sep = "-"))

Lin_GeneticContributions_10y.cohort <- Lin_GeneticContributions_10y.cohort %>% 
  group_by(cohort.10y,Year) %>% 
  summarise(Proportional.cohort=sum(Proportional))

#Plot all years together
start <- 1
end <- 16

years.to.plot <- as.character(unique(Lin_GeneticContributions_10y.cohort$cohort.10y)[start:end])

Lin_GeneticContributions_10y.cohort <- Lin_GeneticContributions_10y.cohort[Lin_GeneticContributions_10y.cohort$cohort.10y %in% years.to.plot,]

Lin_GeneticContributions_10y.cohort$Cohort <- Lin_GeneticContributions_10y.cohort$cohort.10y

SF2a <- 
  ggplot(Lin_GeneticContributions_10y.cohort, aes(x=as.numeric(Year), y=Proportional.cohort, group=Cohort)) +
  geom_line(aes(color=Cohort))+
  geom_point(aes(color=Cohort))+
  scale_color_viridis_d()  +
  theme_bw() +
  xlim(c(1600,1990)) +
  ggtitle("Linthal") +
  ylim(c(0,0.6)) +
  labs(y= "", x = "Year")
SF2a
```

Individually per cohort

```{r fig.show="hold", out.width="25%"}

tempsubset <- subset(Lin_GeneticContributions_20210812, select = c("ID", "Year", "Relative_Year", "Proportional", "cohort.10y","Cohort"))
tempsubset$Relative_Year <- as.numeric(gsub("A","",tempsubset$Relative_Year))

Stabilisation <- subset(tempsubset, select = c("ID", "Year","Proportional", "cohort.10y","Cohort"))
Stabilisation$cohort.10y <- as.factor(Stabilisation$cohort.10y)

for(i in 3:length(cohort.10y)) {
  cohort <-as.numeric(cohort.10y[i])
  data <- Stabilisation[Stabilisation$cohort.10y==cohort,]
  
  if(cohort==cohort.10y[3]){
  plot <- ggplot(data, aes(x=as.numeric(Year), y=Proportional, group=as.factor(ID))) +
  geom_line(aes(color=as.factor(ID)),alpha=0.5,size=0.5)+
  theme_bw() +
  ylim(c(0,.03)) +
  labs(y= paste(paste("Proportional genetic contribution for the " ,cohort), " 10-birth cohort"), x = paste("Years, for cohort",cohort,sep=" ")) +
  theme(legend.position = "none")
  
print(plot)  
    
  }
  else{
plot <- ggplot(data, aes(x=as.numeric(Year), y=Proportional, group=as.factor(ID))) +
  geom_line(aes(color=as.factor(ID)),alpha=0.5,size=0.5)+
  theme_bw() +
  # ylim(c(0,.07)) +
  labs(y= paste(paste("Proportional genetic contribution for the " ,cohort), " 10-birth cohort"), x = paste("Years, for cohort",cohort,sep=" ")) +
  theme(legend.position = "none")
  
print(plot)
}
}

```

### Create output

```{r}

Elm_GeneticContributions_20210812 <- Elm_GeneticContributions_20210812 %>% dplyr::select(-cohort.5y)
Lin_GeneticContributions_20210812 <- Lin_GeneticContributions_20210812 %>% dplyr::select(-cohort.5y)

Elm_GeneticContributions_20210812$Parish <- "Elm"
Lin_GeneticContributions_20210812$Parish <- "Lin"

Elm_rv_data <- Elm_GeneticContributions_20210812[Elm_GeneticContributions_20210812$Year==1990,]
Lin_rv_data <- Lin_GeneticContributions_20210812[Lin_GeneticContributions_20210812$Year==1990,]

Elm_rv_data
Lin_rv_data

rv_data <- rbind(Elm_rv_data,Lin_rv_data)

write.csv(rv_data,"rv-data.csv")

```

### Supplementary Figures 1, 2 and 3

```{r}

library(ggpubr)

# stabilised
SF1 <- ggarrange(SF1a,SF1b,
                labels = c("a", "b"),
                ncol = 1, nrow = 2)

annotate_figure(SF1,
                left = text_grob("Correlation",rot=90,color = "black", size = 16),
                bottom = text_grob("", color = "black", size = 16)
)

# not stabilised 

# stabilised
SF2 <- ggarrange(SF1c,SF1d,
                labels = c("a", "b"),
                ncol = 1, nrow = 2)

annotate_figure(SF2,
                left = text_grob("Correlation",rot=90,color = "black", size = 16),
                bottom = text_grob("", color = "black", size = 16)
)


```

```{r}


library(ggpubr)

SF3 <- ggarrange(SF2a,SF2b,
                labels = c("a", "b"),
                ncol = 1, nrow = 2)

annotate_figure(SF3,
                left = text_grob("Total cohort IGC",rot=90,color = "black", size = 16),
                bottom = text_grob("", color = "black", size = 16)
)

```

# 4. Estimating Fitness Proxies

Here I create the fitness proxies (lifespan, lrs, lrssa, and ngo), as well as estimate the proportion of offspring that migrated that would be used as a covariate in the statistical models.

Here, I am going to create fitness proxies for indivduals in the dataset

```{r data_import}

library(tidyverse)

data <- read.delim("data_20220527.txt", sep ="\t")

```

## LRS 

```{r LRS_overall}

data <- dplyr::select(data,-lrs)

### Lifetime reproductive success (total number of children)
fathers <- unique(data[is.na(data$IDf)==F, c("IDp", "IDf")])
lrs.fathers <- aggregate(fathers$IDf, by=list(fathers$IDf), FUN=length)
colnames(lrs.fathers) <- c("IDp", "lrs")

mothers <- unique(data[is.na(data$IDm)==F, c("IDp", "IDm")])
lrs.mothers <- aggregate(mothers$IDm, by=list(mothers$IDm), FUN=length)
colnames(lrs.mothers) <- c("IDp", "lrs")

lrs <- rbind(lrs.fathers, lrs.mothers)
data <- merge(data, lrs, by="IDp", all.x=T, all.y=F)

data$lrs[is.na(data$lrs)==T] <- 0 #those who are NAs make 0

data$lrs[is.na(data$byear)==T | is.na(data$dyear)==T] <- NA  # Only calculate LRS if byear and dyear are known

summary(data$lrs)
  
```

## LRSSA

Lifetime reproductive success (total number of children) surviving to adulthood (LRSSA)

```{r LRSSA}
# Adulthood predicted from Fifth percentle of afr
afr <- data %>%
  drop_na(sex) %>% 
  group_by(sex) %>% 
 summarise(min.afr=quantile(afr,0.05,na.rm = T))

data <- left_join(data,afr,by="sex")

afr

data$min.afr[is.na(data$sex)] <- as.numeric(quantile(data$afr,0.05,na.rm = T))

# We can either assume that those without recorded death years left or died before adulthood.
sa.narm <- data[!data$lifespan<data$min.afr|is.na(data$lifespan)==T,]

sa <- data[data$lifespan>data$min.afr|is.na(data$lifespan)==T,]
### Lifetime reproductive success (total number of children)

fathers <- unique(sa[is.na(sa$IDf)==F, c("IDp", "IDf")])
lrssa.fathers <- aggregate(fathers$IDf, by=list(fathers$IDf), FUN=length)
colnames(lrssa.fathers) <- c("IDp", "lrssa")

mothers <- unique(sa[is.na(sa$IDm)==F, c("IDp", "IDm")])
lrssa.mothers <- aggregate(mothers$IDm, by=list(mothers$IDm), FUN=length)
colnames(lrssa.mothers) <- c("IDp", "lrssa")

lrssa <- rbind(lrssa.fathers, lrssa.mothers)
data <- merge(data, lrssa, by="IDp", all.x=T, all.y=F)

data$lrssa[is.na(data$lrssa)==T] <- 0 #those who are NAs make 0

data$lrssa[is.na(data$byear)==T | is.na(data$dyear)==T] <- NA  # Only calculate lrssa if byear and dyear are known

summary(data$lrs)
hist.default(data$lrs, ylim = c(0,20000),xlim=c(0,24),breaks = 24)
hist.default(data$lrssa, ylim = c(0,20000),xlim = c(0,24),breaks=24)

```

## The number of grandoffspring

Abreviated to ngo

```{r assigning_grandparents}

# Use pedigree, Remove duplicate individuals, then attach to data full data. Individuals only have one mother and father, so will not make any difference
data_uni <- dplyr::distinct(data,IDp,.keep_all = T)

# I have done this separately for the maternal and paternal grandparents

# Maternal (mgm = maternal grandmother, mgf = maternal grandfather)
for(i in seq_along(data_uni$IDp)){
  crr = data_uni[i,]
    if(is.na(crr$IDm) == T) {data_uni$IDmgm[i] = NA
  data_uni$IDmgf[i] = NA}
  else{
    mum = data_uni[which(data_uni$IDp == crr$IDm),]
    if(nrow(mum) == 0){data_uni$IDmgm[i] = NA
    data_uni$IDmgf[i] = NA}
    else{
      if(is.na(mum$IDm) == T){data_uni$IDmgm[i] = NA}
      else{data_uni$IDmgm[i] = mum$IDm}
      if(is.na(mum$IDf) == T){data_uni$IDmgf[i] = NA}
      else{data_uni$IDmgf[i] = mum$IDf}
    } } }

# paternal (pgm = paternal grandmother, pgf = paternal grandfather)
# Paternal
for(i in seq_along(data_uni$IDp)){
  crr = data_uni[i,]
  if(is.na(crr$IDf) == T){data_uni$IDpgm[i] = NA
  data_uni$IDpgf[i] = NA}
  else{
    dad = data_uni[which(data_uni$IDp == crr$IDf),]
    if(nrow(dad) == 0){data_uni$IDpgm[i] = NA
    data_uni$IDpgf[i] = NA}
    else{
      if(is.na(dad$IDm) == T){data_uni$IDpgm[i] = NA}
      else{data_uni$IDpgm[i] = dad$IDm}
      if(is.na(dad$IDf) == T){data_uni$IDpgf[i] = NA}
      else{data_uni$IDpgf[i] = dad$IDf}
    } } 
}

data <- left_join(data, data_uni[,c("IDp","IDmgm","IDmgf", "IDpgm","IDpgf")], by="IDp")

```

```{r grandoffspring}

### Ngo, number of grandoffspring
pgfathers <- unique(data[is.na(data$IDpgf)==F, c("IDp", "IDpgf")])
ngo.pgfathers <- aggregate(pgfathers$IDpgf, by=list(pgfathers$IDpgf), FUN=length)
colnames(ngo.pgfathers) <- c("IDp", "p.ngo")

mgfathers <- unique(data[is.na(data$IDf)==F, c("IDp", "IDmgf")])
ngo.mgfathers <- aggregate(mgfathers$IDmgf, by=list(mgfathers$IDmgf), FUN=length)
colnames(ngo.mgfathers) <- c("IDp", "m.ngo")

### Ngo, number of grandoffspring
pgmothers <- unique(data[is.na(data$IDpgm)==F, c("IDp", "IDpgm")])
ngo.pgmothers <- aggregate(pgmothers$IDpgm, by=list(pgmothers$IDpgm), FUN=length)
colnames(ngo.pgmothers) <- c("IDp", "p.ngo")

mgmothers <- unique(data[is.na(data$IDf)==F, c("IDp", "IDmgm")])
ngo.mgmothers <- aggregate(mgmothers$IDmgm, by=list(mgmothers$IDmgm), FUN=length)
colnames(ngo.mgmothers) <- c("IDp", "m.ngo")

m.ngo <- rbind(ngo.mgfathers, ngo.mgmothers)
data <- merge(data, m.ngo, by="IDp", all.x=T, all.y=F)

p.ngo <- rbind(ngo.pgfathers, ngo.pgmothers)
data <- merge(data, p.ngo, by="IDp", all.x=T, all.y=F)

data$p.ngo[is.na(data$p.ngo)==T] <- 0 #those who are NAs make 0
data$m.ngo[is.na(data$m.ngo)==T] <- 0 #those who are NAs make 0

data$ngo <- data$p.ngo +  data$m.ngo 

data$ngo[is.na(data$ngo)==T] <- 0 #those who are NAs make 0

data$ngo[is.na(data$byear)==T | is.na(data$dyear)==T] <- NA  # Only calculate ngo if byear and dyear are known
data$p.ngo[is.na(data$byear)==T | is.na(data$dyear)==T] <- NA 
data$m.ngo[is.na(data$byear)==T | is.na(data$dyear)==T] <- NA 

for(i in seq_along(data)){
  if(is.na(data$byear[i])==T) {data$fullifhis[i] <- 0}
  else{if(is.na(data$dyear[i])==T) {data$fullifhis[i] <- 0}
  else{data$fullifhis[i] <- 1}
  }
}

# For offspring's too
# Paternal
for(i in seq_along(data$IDp)){
  ID <- data$IDp[i]
  ID.data <- data[i,]
  if(is.na(ID.data$sex) == T){data$fullifhis_kids[i] <-  NA}
  else{if(ID.data$sex == "M") { #for determining whether to look in father or mother id column
    offspring_data <- data[!is.na(data$IDf) & data$IDf==ID,]
    ifelse(sum(offspring_data$fullifhis)<nrow(offspring_data),data$fullifhis_kids[i] <-  0,data$fullifhis_kids[i] <- 1) }
    else{offspring_data <- data[!is.na(data$IDm) & data$IDm==ID,]
    ifelse(sum(offspring_data$fullifhis)<nrow(offspring_data),data$fullifhis_kids[i] <-  0,data$fullifhis_kids[i] <- 1) }
  }
  print(i)
}

data$ngo.kk[is.na(data$fullifhis_kids)==F & data$fullifhis_kids==1] <- data$ngo[is.na(data$fullifhis_kids)==F & data$fullifhis_kids==1]  # Only calculate ngo if byear and dyear of kids is known (called ngo.kk)

summary(data$ngo.kk)
```

## Proportion of non-migrating offspring

Proportion of individuals offspring who have different birth and reg code as parents (did migrate)

```{r}

data_offspring_migration <- data[!is.na(data$IDf),]


# determining offspring who had a different sregcode from their father
for(i in 1:nrow(data_offspring_migration)) {
  IDp <- data_offspring_migration$IDp[i]
  IDf <- data_offspring_migration$IDf[i]
  IDp.sregcode <- data_offspring_migration$sregcode[data_offspring_migration$IDp==IDp]
  IDf.sregcode <- data_offspring_migration$sregcode[data_offspring_migration$IDp==IDf]
  if(is.na(IDf)) {data_offspring_migration$migrant.offspring[i] <- 0}
  else{if(any(is.na(IDp.sregcode))) {data_offspring_migration$migrant.offspring[i] <- 0}
  else{if(length(IDf.sregcode)==0) {data_offspring_migration$migrant.offspring[i] <- 0}
  else{if(any(is.na(IDf.sregcode))) {data_offspring_migration$migrant.offspring[i] <- 0}
  else{if(any(IDp.sregcode!=IDf.sregcode))
  {data_offspring_migration$migrant.offspring[i] <- 1}
    else{data_offspring_migration$migrant.offspring[i] <- 0}
    print(i)
  }
  }
}
  }
}

summary(as.factor(data_offspring_migration$migrant.offspring))

data <- left_join(data,data_offspring_migration[,c("IDp","migrant.offspring")],by="IDp")

data$migrant.offspring <- as.numeric(data$migrant.offspring)
hist.default(data$migrant.offspring)
# all good
```

Now I need to turn this into a proportion

```{r}

### migrators
migrators <- data[data$migrant.offspring==1&is.na(data$migrant.offspring)==F,]

fathers <- unique(migrators[is.na(migrators$IDf)==F, c("IDp", "IDf")])
lrs.migrators.fathers <- aggregate(fathers$IDf, by=list(fathers$IDf), FUN=length)
colnames(lrs.migrators.fathers) <- c("IDp", "lrs.migrators")

mothers <- unique(migrators[is.na(migrators$IDm)==F, c("IDp", "IDm")])
lrs.migrators.mothers <- aggregate(mothers$IDm, by=list(mothers$IDm), FUN=length)
colnames(lrs.migrators.mothers) <- c("IDp", "lrs.migrators")

lrs.migrators <- rbind(lrs.migrators.fathers, lrs.migrators.mothers)
data <- merge(data, lrs.migrators, by="IDp", all.x=T, all.y=F)

data$lrs.migrators[is.na(data$byear)==T | is.na(data$dyear)==T] <- NA  

### non_migrators
non_migrators <- data[!data$migrant.offspring==1|is.na(data$migrant.offspring)==T,]

fathers <- unique(non_migrators[is.na(non_migrators$IDf)==F, c("IDp", "IDf")])
lrs.non_migrators.fathers <- aggregate(fathers$IDf, by=list(fathers$IDf), FUN=length)
colnames(lrs.non_migrators.fathers) <- c("IDp", "lrs.non_migrators")

mothers <- unique(non_migrators[is.na(non_migrators$IDm)==F, c("IDp", "IDm")])
lrs.non_migrators.mothers <- aggregate(mothers$IDm, by=list(mothers$IDm), FUN=length)
colnames(lrs.non_migrators.mothers) <- c("IDp", "lrs.non_migrators")

lrs.non_migrators <- rbind(lrs.non_migrators.fathers, lrs.non_migrators.mothers)
data <- merge(data, lrs.non_migrators, by="IDp", all.x=T, all.y=F)

data$lrs.non_migrators[data$lrs==data$lrs.migrators] <- 0 

data$prop.lrs.non.migrators <- data$lrs.non_migrators/data$lrs

data$prop.lrs.non.migrators[is.na(data$prop.lrs.non.migrators)==T] <- 1

data$prop.lrs.non.migrators[is.na(data$byear)==T | is.na(data$dyear)==T] <- NA  

summary(data$prop.lrs.non.migrators)
hist.default(data$prop.lrs.non.migrators)

```

## Write csv

```{r}

fitness_proxy_data <- data[,c("IDp","lifespan","lrs","lrssa","ngo.kk","prop.lrs.non.migrators")]
write_csv(fitness_proxy_data,"fitness_proxy_data.csv")

```

### Sample sizes for fitness proxies

```{r}

# Data Import
genetic_contributions <- read.csv("rv-data.csv")

Elm_st_time<- 8*32.13458
Lin_st_time<-8*32.21

igc <- genetic_contributions[genetic_contributions$Parish=="Elm"& genetic_contributions$Cohort<(1990-Elm_st_time)|genetic_contributions$Parish=="Lin"& genetic_contributions$Cohort<(1990-Lin_st_time),]

igc$Sex <- as.factor(igc$Sex)
igc$Parish <- as.factor(igc$Parish)

fitness_metrics <- read.csv("fitness_proxy_data.csv")
fitness_metrics %>%  count(is.na(lifespan))
fitness_metrics %>% count(is.na(lrs))
fitness_metrics %>%  count(is.na(lrssa))
fitness_metrics %>%  count(is.na(ngo.kk))

fitness_metrics$ID <- fitness_metrics$IDp
fitness_metrics <- fitness_metrics[,c("ID","lifespan","lrs","lrssa","ngo.kk","prop.lrs.non.migrators")]

igc <- left_join(igc, fitness_metrics, by="ID")

# Sample sizes for 
igc %>% filter(!is.na(Proportional)) %>% count(is.na(lifespan))
igc %>% filter(!is.na(Proportional)) %>% count(is.na(lrs))
igc %>% filter(!is.na(Proportional)) %>% count(is.na(lrssa))
igc %>% filter(!is.na(Proportional)) %>% count(is.na(ngo.kk))
```

## Supplementary figure 4

```{r}
# Data Import
genetic_contributions <- read.csv("rv-data.csv")

Elm_st_time<- 8*32.13458
Lin_st_time<-8*32.21

igc <- genetic_contributions[genetic_contributions$Parish=="Elm"& genetic_contributions$Cohort<(1990-Elm_st_time)|genetic_contributions$Parish=="Lin"& genetic_contributions$Cohort<(1990-Lin_st_time),]

# Working out average length of IGCs length estimated
igc %>% 
  group_by(Parish) %>% 
summarise(mean.length = mean(Year-Cohort))

hist.default((igc$Year-igc$Cohort),breaks = seq(250,420,5),main = "",xlab = "Number of years after which IGCs estimated",xlim=c(250,420))

```


## Supplementary figure 5

### Model histograms

```{r fig.show="hold", out.width="50%"}
library(moments)
library(gridExtra)
# Data Import
genetic_contributions <- read.csv("rv-data.csv")

Elm_st_time<- 8*32.13458
Lin_st_time<-8*32.21

igc <- genetic_contributions[genetic_contributions$Parish=="Elm"& genetic_contributions$Cohort<(1990-Elm_st_time)|genetic_contributions$Parish=="Lin"& genetic_contributions$Cohort<(1990-Lin_st_time),]

igc$Sex <- as.factor(igc$Sex)
igc$Parish <- as.factor(igc$Parish)

fitness_metrics <- read.csv("fitness_proxy_data.csv")

fitness_metrics$ID <- fitness_metrics$IDp
fitness_metrics <- fitness_metrics[,c("ID","lrs","prop.lrs.non.migrators")]

igc <- left_join(igc, fitness_metrics, by="ID")

PE <- sum(igc$Proportional==0)/NROW(igc)

rv_ds <- igc %>%
  filter(!Proportional==0) %>%
  summarise(N=length(igc$Proportional),`Zero (%)`=PE*100,Mean=round(mean(Proportional),5),Var=var(Proportional),CV=(sd(Proportional)/mean(Proportional)*100), Skew=skewness(Proportional)) %>% 
  signif(digits = 3)
rv_ds
row.names(rv_ds) <- ""
```

```{r}

SF5.proportional <- igc %>% 
  filter(!Proportional==0) %>% 
  ggplot(aes(x=Proportional)) + 
  geom_histogram(breaks=seq(0, max(igc$Proportional), by=0.00025), 
                 binwidth = 0.7,
                 col="black", 
                 fill="darkgrey") + 
  labs(x="Proportional Genetic Contributions", y="")+
  theme_bw() +
  theme(axis.line = element_line(colour = "black"), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 8, angle = 0, family = "serif")) +
  theme(legend.position = "right",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="plain")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="plain", lineheight = 0.5))+ 
  annotation_custom(tableGrob(rv_ds), xmin=0.002, ymin=150)

```

```{r fig.show="hold", out.width="50%"}
# Data Import
genetic_contributions <- read.csv("rv-data.csv")

Elm_st_time<- 8*32.13458
Lin_st_time<-8*32.21

igc <- genetic_contributions[genetic_contributions$Parish=="Elm"& genetic_contributions$Cohort<(1990-Elm_st_time)|genetic_contributions$Parish=="Lin"& genetic_contributions$Cohort<(1990-Lin_st_time),]

igc$Sex <- as.factor(igc$Sex)
igc$Parish <- as.factor(igc$Parish)

fitness_metrics <- read.csv("fitness_proxy_data.csv")

fitness_metrics$ID <- fitness_metrics$IDp
fitness_metrics <- fitness_metrics[,c("ID","lrs","prop.lrs.non.migrators")]

igc <- left_join(igc, fitness_metrics, by="ID")

igc <- igc %>% drop_na(Proportional,lrs)

PE <- sum(igc$lrs==0)/NROW(igc)

rv_ds <- igc %>%
  filter(!lrs==0) %>%
  summarise(N=length(igc$lrs),`Zero (%)`=PE*100,Mean=round(mean(lrs),5),Var=var(lrs),CV=(sd(lrs)/mean(lrs)*100), Skew=round(skewness(lrs),1)) %>% 
  round(1)

row.names(rv_ds) <- ""
```

```{r}

SF5.lrs <- igc %>% 
  filter(!lrs==0) %>% 
  ggplot(aes(x=lrs)) + 
  geom_histogram(breaks=seq(0, max(igc$lrs), by=1), 
                 binwidth = 0.7,
                 col="black", 
                 fill="darkgrey") + 
  labs(x="LRS", y="")+
  theme_bw() +
  theme(axis.line = element_line(colour = "black"), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 8, angle = 0, family = "serif")) +
  theme(legend.position = "right",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="plain")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="plain", lineheight = 0.5))+ 
  annotation_custom(tableGrob(rv_ds), xmin=7, ymin=150)

```

```{r fig.show="hold", out.width="50%"}
# Data Import
genetic_contributions <- read.csv("rv-data.csv")

Elm_st_time<- 8*32.13458
Lin_st_time<-8*32.21

igc <- genetic_contributions[genetic_contributions$Parish=="Elm"& genetic_contributions$Cohort<(1990-Elm_st_time)|genetic_contributions$Parish=="Lin"& genetic_contributions$Cohort<(1990-Lin_st_time),]

igc$Sex <- as.factor(igc$Sex)
igc$Parish <- as.factor(igc$Parish)

fitness_metrics <- read.csv("fitness_proxy_data.csv")

fitness_metrics$ID <- fitness_metrics$IDp
fitness_metrics <- fitness_metrics[,c("ID","lrssa","prop.lrs.non.migrators")]

igc <- left_join(igc, fitness_metrics, by="ID")

igc <- igc %>% drop_na(Proportional,lrssa)

PE <- sum(igc$lrssa==0)/NROW(igc)

rv_ds <- igc %>%
  filter(!lrssa==0) %>%
  summarise(N=length(igc$lrssa),`Zero (%)`=PE*100,Mean=round(mean(lrssa),5),Var=var(lrssa),CV=(sd(lrssa)/mean(lrssa)*100), Skew=round(skewness(lrssa),1)) %>% 
  round(1)

row.names(rv_ds) <- ""
```

```{r}

SF5.lrssa <- igc %>% 
  filter(!lrssa==0) %>% 
  ggplot(aes(x=lrssa)) + 
  geom_histogram(breaks=seq(0, max(igc$lrssa), by=1), 
                 binwidth = 0.7,
                 col="black", 
                 fill="darkgrey") + 
  xlab(bquote(''*LRS[SA]*''))  +
  ylab("")+
  theme_bw() +
  theme(axis.line = element_line(colour = "black"), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 8, angle = 0, family = "serif")) +
  theme(legend.position = "right",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="plain")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="plain", lineheight = 0.5))+ 
  annotation_custom(tableGrob(rv_ds), xmin=7, ymin=150)

```

```{r fig.show="hold", out.width="50%"}
# Data Import
genetic_contributions <- read.csv("rv-data.csv")

Elm_st_time<- 8*32.13458
Lin_st_time<-8*32.21

igc <- genetic_contributions[genetic_contributions$Parish=="Elm"& genetic_contributions$Cohort<(1990-Elm_st_time)|genetic_contributions$Parish=="Lin"& genetic_contributions$Cohort<(1990-Lin_st_time),]

igc$Sex <- as.factor(igc$Sex)
igc$Parish <- as.factor(igc$Parish)

fitness_metrics <- read.csv("fitness_proxy_data.csv")

fitness_metrics$ID <- fitness_metrics$IDp
fitness_metrics <- fitness_metrics[,c("ID","lifespan","prop.lrs.non.migrators")]

igc <- left_join(igc, fitness_metrics, by="ID")

igc <- igc %>% drop_na(Proportional,lifespan)

PE <- sum(igc$lifespan<adulthood)/NROW(igc)

rv_ds <- igc %>%
  filter(!lifespan==0) %>%
  summarise(N=length(igc$lifespan),`Non-SA (%)`=PE*100,Mean=round(mean(lifespan),5),Var=var(lifespan),CV=(sd(lifespan)/mean(lifespan)*100), Skew=round(skewness(lifespan),1)) %>% 
  round(1)

row.names(rv_ds) <- ""
```

```{r}

SF5.lifespan <- igc %>%
  ggplot(aes(x=lifespan)) + 
  geom_histogram(breaks=seq(0, max(igc$lifespan), by=5), 
                 binwidth = 0.7,
                 col="black", 
                 fill="darkgrey") + 
  labs(x="Lifespan", y="")+
  theme_bw() +
  theme(axis.line = element_line(colour = "black"), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 8, angle = 0, family = "serif")) +
  theme(legend.position = "right",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="plain")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="plain", lineheight = 0.5))+ 
  annotation_custom(tableGrob(rv_ds), xmin=0, ymin=375)

```


```{r fig.show="hold", out.width="50%"}

# Data Import
genetic_contributions <- read.csv("rv-data.csv")

Elm_st_time<- 8*32.13458
Lin_st_time<-8*32.21

igc <- genetic_contributions[genetic_contributions$Parish=="Elm"& genetic_contributions$Cohort<(1990-Elm_st_time)|genetic_contributions$Parish=="Lin"& genetic_contributions$Cohort<(1990-Lin_st_time),]

igc$Sex <- as.factor(igc$Sex)
igc$Parish <- as.factor(igc$Parish)

fitness_metrics <- read.csv("fitness_proxy_data.csv")

fitness_metrics$ID <- fitness_metrics$IDp
fitness_metrics <- fitness_metrics[,c("ID","ngo.kk","prop.lrs.non.migrators")]

igc <- left_join(igc, fitness_metrics, by="ID")

igc <- igc %>% drop_na(Proportional,ngo.kk)

PE <- sum(igc$ngo.kk==0)/NROW(igc)

rv_ds <- igc %>%
  filter(!ngo.kk==0) %>%
  summarise(N=length(igc$ngo.kk),`Zero (%)`=PE*100,Mean=round(mean(ngo.kk),5),Var=var(ngo.kk),CV=(sd(ngo.kk)/mean(ngo.kk)*100), Skew=round(skewness(ngo.kk),1)) %>% 
  round(1)

row.names(rv_ds) <- ""
```

```{r}

SF5.ngo.kk <- igc %>% 
  filter(!ngo.kk==0) %>% 
  ggplot(aes(x=ngo.kk)) + 
  geom_histogram(breaks=seq(0, max(igc$ngo.kk), by=5), 
                 binwidth = 0.7,
                 col="black", 
                 fill="darkgrey") + 
  xlab(bquote(''*LRS[SA]*''))  +
  labs(x="Number of grandoffspring", y="")+
  theme_bw() +
  theme(axis.line = element_line(colour = "black"), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 8, angle = 0, family = "serif")) +
  theme(legend.position = "right",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="plain")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="plain", lineheight = 0.5))+ 
  annotation_custom(tableGrob(rv_ds), xmin=7, ymin=150)

```

```{r}

library(ggpubr)

sup_fig_5_abcde <- ggarrange(SF5.proportional,SF5.lifespan,SF5.lrs,SF5.lrssa,SF5.ngo.kk,
                labels = c("a", "b","c", "d","e"),
                ncol = 1, nrow = 5)

annotate_figure(sup_fig_5_abcde,
                left = text_grob("Count",rot=90,color = "black", size = 16))


```




# 5. Statistical models

## The power of fitness proxies to predict IGC

Below is the code for running the statistical models examining the power for fitness proxies to predict IGC. They are GLMMs zero-inflated beta models and use the packages brms and rstan. One is run for each of the different fitness proxies (Lifespan, LRS, LRSSA, and the number of grandoffspring (abbreviated to ngo.kk)). There is also a "null model" with no fitness proxy included.

### Packages

```{r}
library(tidyverse)
library(dplyr)
library(brms)
library(rstan)
```

### Null model

```{r}

# Data Import
genetic_contributions <- read.csv("rv-data.csv")

Elm_st_time<- 8*32.13458
Lin_st_time<-8*32.21

igc <- genetic_contributions[genetic_contributions$Parish=="Elm"& genetic_contributions$Cohort<(1990-Elm_st_time)|genetic_contributions$Parish=="Lin"& genetic_contributions$Cohort<(1990-Lin_st_time),]

# Working out average length of IGCs length estimated
igc %>% 
  group_by(Parish) %>% 
summarise(mean.length = mean(Year-Cohort))

pdf(file = "sup-fig-03-igcs_length.pdf",   # The directory you want to save the file in
    width = 10, # The width of the plot in inches
    height = 6) # The height of the plot in inches
hist.default((igc$Year-igc$Cohort),breaks = seq(250,420,5),main = "",xlab = "Number of years after which IGCs estimated",xlim=c(250,420))

igc$Sex <- as.factor(igc$Sex)
igc$Parish <- as.factor(igc$Parish)

fitness_metrics <- read.csv("fitness_proxy_data.csv")

fitness_metrics$ID <- fitness_metrics$IDp
fitness_metrics <- fitness_metrics[,c("ID","lrs","prop.lrs.non.migrators")]

igc <- left_join(igc, fitness_metrics, by="ID")

###Add 10-year cohort
igc$cohort.10y <- cut(igc$Cohort, c(1574,seq(1595,1735,10)), labels=c(1574,seq(1595,1725,10)))

igc$parish.cohort.10y <- paste(sep=":", igc$Parish,igc$cohort.10y)

d_nonNA <-igc %>%
  drop_na(lrs) %>%
  drop_na(Proportional) %>%
  drop_na(Parish) %>%
  drop_na(Sex) %>%
  drop_na(parish.cohort.10y) %>%
  drop_na(prop.lrs.non.migrators)

d_nonNA <- d_nonNA %>% dplyr::select(lrs,parish.cohort.10y,Parish,Sex,Proportional,prop.lrs.non.migrators)

saveRDS(d_nonNA, file = "data_m.fit.null_20220111.rds")

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)

# Model specification
m.fit.null_20220111 <-  brm(bf(formula = Proportional ~ Parish*Sex+Parish*prop.lrs.non.migrators+Sex*prop.lrs.non.migrators+(1|parish.cohort.10y),zi~Parish*Sex+Parish*prop.lrs.non.migrators+Sex*prop.lrs.non.migrators+(1|parish.cohort.10y)), family = zero_inflated_beta(),
                            warmup = 2000, iter= 6000, thin = 10,chains = 4, cores = 4, seed = 666,
                            file = "m.fit.null_20220111", data = d_nonNA)

saveRDS(m.fit.null_20220111, file = "m.fit.null_20220111.rds")

# Model specification without interactions
m.fit.null.nint_20220111 <-  brm(bf(formula = Proportional ~ Parish+Sex+prop.lrs.non.migrators+(1|parish.cohort.10y),zi~Parish+Sex+prop.lrs.non.migrators+(1|parish.cohort.10y)), family = zero_inflated_beta(),
                            warmup = 2000, iter= 6000, thin = 10,chains = 4, cores = 4, seed = 666,
                            file = "m.fit.null.nint_20220111", data = d_nonNA)

saveRDS(m.fit.null.nint_20220111, file = "m.fit.null.nint_20220111.rds")
```

### lifespan model

```{r}
# Data Import
genetic_contributions <- read.csv("rv-data.csv")

Elm_st_time<- 8*32.13458
Lin_st_time<-8*32.21

igc <- genetic_contributions[genetic_contributions$Parish=="Elm"& genetic_contributions$Cohort<(1990-Elm_st_time)|genetic_contributions$Parish=="Lin"& genetic_contributions$Cohort<(1990-Lin_st_time),]

igc$Sex <- as.factor(igc$Sex)
igc$Parish <- as.factor(igc$Parish)

fitness_metrics <- read.csv("fitness_proxy_data.csv")

fitness_metrics$ID <- fitness_metrics$IDp
fitness_metrics <- fitness_metrics[,c("ID","lifespan","prop.lrs.non.migrators")]

igc <- left_join(igc, fitness_metrics, by="ID")

###Add 10-year cohort
igc$cohort.10y <- cut(igc$Cohort, c(1574,seq(1595,1735,10)), labels=c(1574,seq(1595,1725,10)))

igc$parish.cohort.10y <- paste(sep=":", igc$Parish,igc$cohort.10y)

d_nonNA <-igc %>%
  drop_na(lifespan) %>%
  drop_na(Proportional) %>%
  drop_na(Parish) %>%
  drop_na(Sex) %>%
  drop_na(parish.cohort.10y) %>%
  drop_na(prop.lrs.non.migrators)

d_nonNA <- d_nonNA %>% dplyr::select(lifespan,parish.cohort.10y,Parish,Sex,Proportional,prop.lrs.non.migrators)

saveRDS(d_nonNA, file = "data_m.fit.lifespan_20220111.rds")

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)

# Model specification
m.fit.lifespan_20220111 <-  brm(bf(formula = Proportional ~ lifespan+Parish*Sex+Parish*prop.lrs.non.migrators+Sex*prop.lrs.non.migrators+(lifespan|parish.cohort.10y),zi~lifespan+Parish*Sex+Parish*prop.lrs.non.migrators+Sex*prop.lrs.non.migrators+(lifespan|parish.cohort.10y)), family = zero_inflated_beta(),
                            warmup = 2000, iter= 6000, thin = 10,chains = 4, cores = 4, seed = 666,
                            file = "m.fit.lifespan_20220111", data = d_nonNA)

saveRDS(m.fit.lifespan_20220111, file = "m.fit.lifespan_20220111.rds")

# Model specification without interactions
m.fit.lifespan.nint_20220111 <-  brm(bf(formula = Proportional ~ lifespan+Parish+Sex+prop.lrs.non.migrators+(lifespan|parish.cohort.10y),zi~lifespan+Parish+Sex+prop.lrs.non.migrators+(lifespan|parish.cohort.10y)), family = zero_inflated_beta(),
                                 warmup = 2000, iter= 6000, thin = 10,chains = 4, cores = 4, seed = 666,
                                 file = "m.fit.lifespan.nint_20220111", data = d_nonNA)

saveRDS(m.fit.lifespan.nint_20220111, file = "m.fit.lifespan.nint_20220111.rds")
```

### lrs model

```{r}

# Data Import
genetic_contributions <- read.csv("rv-data.csv")

Elm_st_time<- 8*32.13458
Lin_st_time<-8*32.21

igc <- genetic_contributions[genetic_contributions$Parish=="Elm"& genetic_contributions$Cohort<(1990-Elm_st_time)|genetic_contributions$Parish=="Lin"& genetic_contributions$Cohort<(1990-Lin_st_time),]

igc$Sex <- as.factor(igc$Sex)
igc$Parish <- as.factor(igc$Parish)

fitness_metrics <- read.csv("fitness_proxy_data.csv")

fitness_metrics$ID <- fitness_metrics$IDp
fitness_metrics <- fitness_metrics[,c("ID","lrs","prop.lrs.non.migrators")]

igc <- left_join(igc, fitness_metrics, by="ID")

###Add 10-year cohort
igc$cohort.10y <- cut(igc$Cohort, c(1574,seq(1595,1735,10)), labels=c(1574,seq(1595,1725,10)))

igc$parish.cohort.10y <- paste(sep=":", igc$Parish,igc$cohort.10y)

d_nonNA <-igc %>%
  drop_na(lrs) %>%
  drop_na(Proportional) %>%
  drop_na(Parish) %>%
  drop_na(Sex) %>%
  drop_na(parish.cohort.10y) %>%
  drop_na(prop.lrs.non.migrators)

d_nonNA <- d_nonNA %>% dplyr::select(lrs,parish.cohort.10y,Parish,Sex,Proportional,prop.lrs.non.migrators)

saveRDS(d_nonNA, file = "data_m.fit.lrs_20220111.rds")

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)

# Model specification
m.fit.lrs_20220111 <-  brm(bf(formula = Proportional ~ lrs+Parish*Sex+Parish*prop.lrs.non.migrators+Sex*prop.lrs.non.migrators+(lrs|parish.cohort.10y),zi~lrs+Parish*Sex+Parish*prop.lrs.non.migrators+Sex*prop.lrs.non.migrators+(lrs|parish.cohort.10y)), family = zero_inflated_beta(),
                                warmup = 2000, iter= 6000, thin = 10,chains = 4, cores = 4, seed = 666,
                                file = "m.fit.lrs_20220111", data = d_nonNA)

saveRDS(m.fit.lrs_20220111, file = "m.fit.lrs_20220111.rds")

# Model specification without interactions
m.fit.lrs.nint_20220111 <-  brm(bf(formula = Proportional ~ lrs+Parish+Sex+prop.lrs.non.migrators+(lrs|parish.cohort.10y),zi~lrs+Parish+Sex+prop.lrs.non.migrators+(lrs|parish.cohort.10y)), family = zero_inflated_beta(),
                                     warmup = 2000, iter= 6000, thin = 10,chains = 4, cores = 4, seed = 666,
                                     file = "m.fit.lrs.nint_20220111", data = d_nonNA)

saveRDS(m.fit.lrs.nint_20220111, file = "m.fit.lrs.nint_20220111.rds")

```

### lrssa model

```{r}
# Data Import
genetic_contributions <- read.csv("rv-data.csv")

Elm_st_time<- 8*32.13458
Lin_st_time<-8*32.21

igc <- genetic_contributions[genetic_contributions$Parish=="Elm"& genetic_contributions$Cohort<(1990-Elm_st_time)|genetic_contributions$Parish=="Lin"& genetic_contributions$Cohort<(1990-Lin_st_time),]

igc$Sex <- as.factor(igc$Sex)
igc$Parish <- as.factor(igc$Parish)

fitness_metrics <- read.csv("fitness_proxy_data.csv")

fitness_metrics$ID <- fitness_metrics$IDp
fitness_metrics <- fitness_metrics[,c("ID","lrssa","prop.lrs.non.migrators")]

igc <- left_join(igc, fitness_metrics, by="ID")

###Add 10-year cohort
igc$cohort.10y <- cut(igc$Cohort, c(1574,seq(1595,1735,10)), labels=c(1574,seq(1595,1725,10)))

igc$parish.cohort.10y <- paste(sep=":", igc$Parish,igc$cohort.10y)

d_nonNA <-igc %>%
  drop_na(lrssa) %>%
  drop_na(Proportional) %>%
  drop_na(Parish) %>%
  drop_na(Sex) %>%
  drop_na(parish.cohort.10y) %>%
  drop_na(prop.lrs.non.migrators)

d_nonNA <- d_nonNA %>% dplyr::select(lrssa,parish.cohort.10y,Parish,Sex,Proportional,prop.lrs.non.migrators)

saveRDS(d_nonNA, file = "data_m.fit.lrssa_20220111.rds")

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)

# Model specification
m.fit.lrssa_20220111 <-  brm(bf(formula = Proportional ~ lrssa+Parish*Sex+Parish*prop.lrs.non.migrators+Sex*prop.lrs.non.migrators+(lrssa|parish.cohort.10y),zi~lrssa+Parish*Sex+Parish*prop.lrs.non.migrators+Sex*prop.lrs.non.migrators+(lrssa|parish.cohort.10y)), family = zero_inflated_beta(),
                                warmup = 2000, iter= 6000, thin = 10,chains = 4, cores = 4, seed = 666,
                                file = "m.fit.lrssa_20220111", data = d_nonNA)

saveRDS(m.fit.lrssa_20220111, file = "m.fit.lrssa_20220111.rds")

# Model specification without interactions
m.fit.lrssa.nint_20220111 <-  brm(bf(formula = Proportional ~ lrssa+Parish+Sex+prop.lrs.non.migrators+(lrssa|parish.cohort.10y),zi~lrssa+Parish+Sex+prop.lrs.non.migrators+(lrssa|parish.cohort.10y)), family = zero_inflated_beta(),
                                     warmup = 2000, iter= 6000, thin = 10,chains = 4, cores = 4, seed = 666,
                                     file = "m.fit.lrssa.nint_20220111", data = d_nonNA)

saveRDS(m.fit.lrssa.nint_20220111, file = "m.fit.lrssa.nint_20220111.rds")


```

### The number of grandoffspring model

```{r}
# Data Import
genetic_contributions <- read.csv("rv-data.csv")

Elm_st_time<- 8*32.13458
Lin_st_time<-8*32.21

igc <- genetic_contributions[genetic_contributions$Parish=="Elm"& genetic_contributions$Cohort<(1990-Elm_st_time)|genetic_contributions$Parish=="Lin"& genetic_contributions$Cohort<(1990-Lin_st_time),]

igc$Sex <- as.factor(igc$Sex)
igc$Parish <- as.factor(igc$Parish)

fitness_metrics <- read.csv("fitness_proxy_data.csv")

fitness_metrics$ID <- fitness_metrics$IDp
fitness_metrics <- fitness_metrics[,c("ID","ngo.kk","prop.lrs.non.migrators")]

igc <- left_join(igc, fitness_metrics, by="ID")

###Add 10-year cohort
igc$cohort.10y <- cut(igc$Cohort, c(1574,seq(1595,1735,10)), labels=c(1574,seq(1595,1725,10)))

igc$parish.cohort.10y <- paste(sep=":", igc$Parish,igc$cohort.10y)

d_nonNA <-igc %>%
  drop_na(ngo.kk) %>%
  drop_na(Proportional) %>%
  drop_na(Parish) %>%
  drop_na(Sex) %>%
  drop_na(parish.cohort.10y) %>%
  drop_na(prop.lrs.non.migrators)

d_nonNA <- d_nonNA %>% dplyr::select(ngo.kk,parish.cohort.10y,Parish,Sex,Proportional,prop.lrs.non.migrators)

saveRDS(d_nonNA, file = "data_m.fit.ngo.kk_20220111.rds")

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)

# Model specification
m.fit.ngo.kk_20220111 <-  brm(bf(formula = Proportional ~ ngo.kk+Parish*Sex+Parish*prop.lrs.non.migrators+Sex*prop.lrs.non.migrators+(ngo.kk|parish.cohort.10y),zi~ngo.kk+Parish*Sex+Parish*prop.lrs.non.migrators+Sex*prop.lrs.non.migrators+(ngo.kk|parish.cohort.10y)), family = zero_inflated_beta(),
                                warmup = 2000, iter= 6000, thin = 10,chains = 4, cores = 4, seed = 666,
                                file = "m.fit.ngo.kk_20220111", data = d_nonNA)

saveRDS(m.fit.ngo.kk_20220111, file = "m.fit.ngo.kk_20220111.rds")

# Model specification without interactions
m.fit.ngo.kk.nint_20220111 <-  brm(bf(formula = Proportional ~ ngo.kk+Parish+Sex+prop.lrs.non.migrators+(ngo.kk|parish.cohort.10y),zi~ngo.kk+Parish+Sex+prop.lrs.non.migrators+(ngo.kk|parish.cohort.10y)), family = zero_inflated_beta(),
                                     warmup = 2000, iter= 6000, thin = 10,chains = 4, cores = 4, seed = 666,
                                     file = "m.fit.ngo.kk.nint_20220111", data = d_nonNA)

saveRDS(m.fit.ngo.kk.nint_20220111, file = "m.fit.ngo.kk.nint_20220111.rds")
```

## Is LRS an unbiased estimate of IGC

Below are the models run examing the bias in LRS, the relationship between mean IGC of offspring and an individuals LRS

```{r}
#### Offspring genetic contributions model ####

# # Packages
library(tidyverse)
library(dplyr)
library(brms)
library(rstan)
# 
# 
# Data Import
genetic_contributions <- read.csv("rv-data.csv")

# Adding parental information
parental_IDs <- read.delim(file = "data_GL20210824.txt")
parental_IDs$ID <- parental_IDs$IDp
parental_IDs <- parental_IDs[,c("ID","IDm","IDf")]

genetic_contributions <- left_join(genetic_contributions,parental_IDs,by="ID")

# Calculating mean offspring values
mean_offspring_rvs_IDf <- genetic_contributions %>% 
  group_by(IDf) %>% 
  summarise(mean_offspring_gc = mean(Proportional)) %>% 
  rename(ID=IDf)

mean_offspring_rvs_IDm <- genetic_contributions %>% 
  group_by(IDm) %>% 
  summarise(mean_offspring_gc = mean(Proportional)) %>% 
  rename(ID=IDm)

mean_offspring_rvs <- rbind(mean_offspring_rvs_IDf,mean_offspring_rvs_IDm)
mean_offspring_rvs$mean_offspring_gc <- mean_offspring_rvs$mean_offspring_gc+.000000001

genetic_contributions <- left_join(genetic_contributions,mean_offspring_rvs,by="ID")

hist.default(genetic_contributions$mean_offspring_gc[genetic_contributions$mean_offspring_gc>0])

Elm_st_time<- 8*32.13458
Lin_st_time<-8*32.21

genetic_contributions_g8 <- genetic_contributions[genetic_contributions$Parish=="Elm"& genetic_contributions$Cohort<(1990-Elm_st_time)|genetic_contributions$Parish=="Lin"& genetic_contributions$Cohort<(1990-Lin_st_time),]


genetic_contributions_g8$Sex <- as.factor(genetic_contributions_g8$Sex)
genetic_contributions_g8$Parish <- as.factor(genetic_contributions_g8$Parish)

fitness_metrics <- read.csv("fitness_proxy_data.csv")

fitness_metrics$ID <- fitness_metrics$IDp
fitness_metrics <- fitness_metrics[,c("ID","lrs","lrssa","lifespan","prop.lrs.non.migrators")]

genetic_contributions_g8 <- left_join(genetic_contributions_g8, fitness_metrics, by="ID")

## Add 10-year cohort
genetic_contributions_g8$cohort.10y <- cut(genetic_contributions_g8$Cohort, c(1574,seq(1595,1735,10)), labels=c(1574,seq(1595,1725,10)))

genetic_contributions_g8$parish.cohort.10y <- paste(sep=":", genetic_contributions_g8$Parish,genetic_contributions_g8$cohort.10y)

write.csv(genetic_contributions_g8,"genetic_contributions_g8.csv")

d_nonNA <-genetic_contributions_g8 %>% 
  drop_na(lrs) %>% 
  drop_na(mean_offspring_gc) %>% 
  drop_na(Parish) %>% 
  drop_na(Sex) %>% 
  drop_na(lifespan) %>%
  drop_na(parish.cohort.10y) %>% 
  drop_na(prop.lrs.non.migrators) 

d_nonNA <- d_nonNA %>% dplyr::select(lrs,lifespan,parish.cohort.10y,Parish,Sex,mean_offspring_gc,prop.lrs.non.migrators)

d_nonNA <- na.omit(d_nonNA)

saveRDS(d_nonNA, file = "data_m.offgc_20220131.rds")

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)

m.offgc.lrs.lifespan_20220131 <-  brm(bf(formula = mean_offspring_gc ~ lrs+lifespan+Parish*Sex+Parish*prop.lrs.non.migrators+Sex*prop.lrs.non.migrators+(lrs|parish.cohort.10y)),family = Beta,
                          warmup = 2000, iter= 6000, thin = 11,chains = 4, cores = 4, seed = 666,
                          file = "m.offgc.lrs.lifespan_20220131", data = d_nonNA)

saveRDS(m.offgc.lrs.lifespan_20220131, file = "m.offgc.lrs.lifespan_20220131.rds")

m.offgc.lrs.lifespan.nint_20220131 <-  brm(bf(formula = mean_offspring_gc ~ lrs+lifespan+Parish*Sex+prop.lrs.non.migrators+(lrs|parish.cohort.10y)),family = Beta,
                                    warmup = 2000, iter= 6000, thin = 11,chains = 4, cores = 4, seed = 666,
                                    file = "m.offgc.lrs.lifespan.nint_20220131", data = d_nonNA)

saveRDS(m.offgc.lrs.lifespan.nint_20220131, file = "m.offgc.lrs.lifespan.nint_20220131.rds")
```

# 6. Model Results and Figures

## The power of fitness proxies to predict IGC 

### Import models

```{r}

library(brms)
library(bayesplot)
library(bayestestR)

library(tidybayes)
library(tidyverse)
library(sjstats)

library(ggplot2) #for figures
library(ggpubr)

```

```{r}

m.fit.null_20220111 <- readRDS(file = "statistical_models_20220113/m.fit.null_20220111.rds")
m.fit.null.nint_20220111 <- readRDS(file = "statistical_models_20220113/m.fit.null.nint_20220111.rds")

m.fit.lifespan_20220111 <- readRDS(file = "statistical_models_20220113/m.fit.lifespan_20220111.rds")
m.fit.lifespan.nint_20220111 <- readRDS(file = "statistical_models_20220113/m.fit.lifespan.nint_20220111.rds")

m.fit.lrs_20220111 <- readRDS(file = "statistical_models_20220113/m.fit.lrs_20220111.rds")
m.fit.lrs.nint_20220111 <- readRDS(file = "statistical_models_20220113/m.fit.lrs.nint_20220111.rds")

m.fit.lrssa_20220111 <- readRDS(file = "statistical_models_20220113/m.fit.lrssa_20220111.rds")
m.fit.lrssa.nint_20220111 <- readRDS(file = "statistical_models_20220113/m.fit.lrssa.nint_20220111.rds")

m.fit.ngo.kk_20220111 <- readRDS(file = "statistical_models_20220113/m.fit.ngo.kk_20220111.rds")
m.fit.ngo.kk.nint_20220111 <- readRDS(file = "statistical_models_20220113/m.fit.ngo.kk.nint_20220111.rds")

```

### Null model 

#### Data checks

```{r}
summary(m.fit.null_20220111)$formula
summary(m.fit.null.nint_20220111)$formula

prior_summary(m.fit.null_20220111)
prior_summary(m.fit.null.nint_20220111)

## Convergrence of models (check Rhat)
tidy_stan(m.fit.null_20220111)
tidy_stan(m.fit.null.nint_20220111)

pp_check(m.fit.null_20220111,nsamples = 50)
pp_check(m.fit.null.nint_20220111,nsamples = 50)
# the pp_check function was used to check that simulated data from the model matched the original data well
```
#### Results

```{r}
# Bayesian R-squared
bayes_R2(m.fit.null_20220111)
bayes_R2(m.fit.null.nint_20220111)

# Visual representation of results (I removed the intercepts from this display becuase it is not especially interesting)
mcmc_areas(m.fit.null_20220111,pars = parnames(m.fit.null_20220111)[3:16], prob = .95)
mcmc_areas(m.fit.null.nint_20220111,pars = parnames(m.fit.null.nint_20220111)[3:10], prob = .95)
```
### Lifespan model 

#### Data checks

```{r}
summary(m.fit.lifespan_20220111)$formula
summary(m.fit.lifespan.nint_20220111)$formula

prior_summary(m.fit.lifespan_20220111)
prior_summary(m.fit.lifespan.nint_20220111)

## Convergrence of models
tidy_stan(m.fit.lifespan_20220111)
tidy_stan(m.fit.lifespan.nint_20220111)

pp_check(m.fit.lifespan_20220111,nsamples = 50)
pp_check(m.fit.lifespan.nint_20220111,nsamples = 50)

```

#### Results

```{r}
bayes_R2(m.fit.lifespan_20220111)
bayes_R2(m.fit.lifespan.nint_20220111)

mcmc_areas(m.fit.lifespan_20220111,pars = parnames(m.fit.lifespan_20220111)[3:16], prob = .95)
mcmc_areas(m.fit.lifespan.nint_20220111,pars = parnames(m.fit.lifespan.nint_20220111)[3:10], prob = .95)
```

### lrs model 

#### Data checks

```{r}
summary(m.fit.lrs_20220111)$formula
summary(m.fit.lrs.nint_20220111)$formula

prior_summary(m.fit.lrs_20220111)
prior_summary(m.fit.lrs.nint_20220111)

## Convergrence of models
tidy_stan(m.fit.lrs_20220111)
tidy_stan(m.fit.lrs.nint_20220111)

pp_check(m.fit.lrs_20220111,nsamples = 50)
pp_check(m.fit.lrs.nint_20220111,nsamples = 50)

```

#### Results

```{r}
bayes_R2(m.fit.lrs_20220111)
bayes_R2(m.fit.lrs.nint_20220111)

mcmc_areas(m.fit.lrs_20220111,pars = parnames(m.fit.lrs_20220111)[3:16], prob = .95)
mcmc_areas(m.fit.lrs.nint_20220111,pars = parnames(m.fit.lrs.nint_20220111)[3:10], prob = .95)
```

### lrssa model 

#### Data checks

```{r}
summary(m.fit.lrssa_20220111)$formula
summary(m.fit.lrssa.nint_20220111)$formula

prior_summary(m.fit.lrssa_20220111)
prior_summary(m.fit.lrssa.nint_20220111)

## Convergrence of models
tidy_stan(m.fit.lrssa_20220111)
tidy_stan(m.fit.lrssa.nint_20220111)

pp_check(m.fit.lrssa_20220111,nsamples = 50)
pp_check(m.fit.lrssa.nint_20220111,nsamples = 50)

```

#### Results

```{r}
bayes_R2(m.fit.lrssa_20220111)
bayes_R2(m.fit.lrssa.nint_20220111)

mcmc_areas(m.fit.lrssa_20220111,pars = parnames(m.fit.lrssa_20220111)[3:16], prob = .95)
mcmc_areas(m.fit.lrssa.nint_20220111,pars = parnames(m.fit.lrssa.nint_20220111)[3:10], prob = .95)
```

### ngo.kk model 

#### Data checks

```{r}
summary(m.fit.ngo.kk_20220111)$formula
summary(m.fit.ngo.kk.nint_20220111)$formula

prior_summary(m.fit.ngo.kk_20220111)
prior_summary(m.fit.ngo.kk.nint_20220111)

## Convergrence of models
tidy_stan(m.fit.ngo.kk_20220111)
tidy_stan(m.fit.ngo.kk.nint_20220111)

pp_check(m.fit.ngo.kk_20220111,nsamples = 50)
pp_check(m.fit.ngo.kk.nint_20220111,nsamples = 50)

```

#### Results

```{r}
bayes_R2(m.fit.ngo.kk_20220111)
bayes_R2(m.fit.ngo.kk.nint_20220111)

mcmc_areas(m.fit.ngo.kk_20220111,pars = parnames(m.fit.ngo.kk_20220111)[3:16], prob = .95)
mcmc_areas(m.fit.ngo.kk.nint_20220111,pars = parnames(m.fit.ngo.kk.nint_20220111)[3:10], prob = .95)
```

### Summary tables and figures

#### Figure 1

### Conditional plots

```{r}


ce_fig_lifespan <- conditional_effects(m.fit.lifespan.nint_20220111,prob = .95) %>% 
  plot(points = T,
       point_args=c(alpha=.3,size=2),
        line_args=c(colour="black"))
      
figure_01a <- ce_fig_lifespan$lifespan +
  scale_alpha_continuous(0.1) +
  ylab("")+
  ylim(0,0.01) +
  xlab(bquote("Lifespan"))  +
  scale_fill_manual(values = "green") +
  scale_color_manual(values = "orange")+
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        axis.line.x.bottom = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 16, angle = 0, family = "serif")) +
  theme(legend.position = "right",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="plain")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="plain", lineheight = 0.5))

```

```{r}


ce_fig_lrs<- conditional_effects(m.fit.lrs.nint_20220111,prob = .95) %>% 
  plot(points = T,
       point_args=c(alpha=.3,size=2),
        line_args=c(colour="black"))
      
figure_01b <- 
  ce_fig_lrs$lrs +
  scale_alpha_continuous(0.1) +
  ylab("")+
  ylim(0,0.01) +
  xlab(bquote("LRS"))  +
  scale_fill_manual(values = "green") +
  scale_color_manual(values = "orange")+
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        axis.line.x.bottom = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 16, angle = 0, family = "serif")) +
  theme(legend.position = "right",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="plain")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="plain", lineheight = 0.5))

```

```{r}

ce_fig_lrssa<- conditional_effects(m.fit.lrssa.nint_20220111,prob = .95) %>% 
  plot(points = T,
       point_args=c(alpha=.3,size=2),
        line_args=c(colour="black"))
      
figure_01c <- ce_fig_lrssa$lrssa +
  scale_alpha_continuous(0.1) +
  ylab("")+
  ylim(0,0.01) +
  xlab(bquote(''*LRS[SA]*''))  +
  scale_fill_manual(values = "green") +
  scale_color_manual(values = "orange")+
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        axis.line.x.bottom = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 16, angle = 0, family = "serif")) +
  theme(legend.position = "right",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="plain")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="plain", lineheight = 0.5))

```

```{r}

ce_fig_ngo.kk<- conditional_effects(m.fit.ngo.kk.nint_20220111,prob = .95) %>% 
  plot(points = T,
       point_args=c(alpha=.3,size=2),
        line_args=c(colour="black"))
      
pdf(file = "figure_01-ngo.kk-20220111.pdf",width = 5,height = 3)
figure_01d <- ce_fig_ngo.kk$ngo.kk +
  scale_alpha_continuous(0.1) +
  ylab("")+
  xlab(bquote('Number of grandoffspring'))  +
  scale_fill_manual(values = "green") +
  scale_color_manual(values = "orange")+
  ylim(0,0.01) +
  xlim(0,70) +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        axis.line.x.bottom = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 16, angle = 0, family = "serif")) +
  theme(legend.position = "right",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="plain")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="plain", lineheight = 0.5))

```

```{r}

library(ggpubr)

figure_01_abcd <- ggarrange(figure_01a,figure_01b,figure_01c,figure_01d,
                labels = c("a", "b","c", "d"),
                ncol = 2, nrow = 2)

annotate_figure(figure_01_abcd,
                left = text_grob("Indivdual genetic contributions (IGCs)",rot=90,color = "black", size = 16),
                bottom = text_grob("Fitness proxy value", color = "black", size = 16)
)

```

#### Table 1 

##### Beta distribution estimates

```{r}
#posterior estimate 
posterior_summary <- rbind(posterior_summary(m.fit.lifespan.nint_20220111)[1:14,c(1,3,4)],posterior_summary(m.fit.lrs.nint_20220111)[1:14,c(1,3,4)],posterior_summary(m.fit.lrssa.nint_20220111)[1:14,c(1,3,4)],posterior_summary(m.fit.ngo.kk.nint_20220111)[1:14,c(1,3,4)])
posterior_summary <- as.data.frame(round(posterior_summary,3))
posterior_summary$`95%.CIs` <- paste(posterior_summary$Q2.5,posterior_summary$Q97.5,sep=" - ")
posterior_summary$`95%.CIs` <- paste(paste("[",posterior_summary$`95%.CIs`,sep=""),"]",sep="")
posterior_summary <- posterior_summary[,c(1,4)]

write.csv(rbind(posterior_summary,r2_summary),"results_table1_beta_20220111.csv")
```

##### Probability of Direction 

```{r}

pd <- rbind(p_direction(m.fit.lifespan.nint_20220111,effects = c("fixed")),p_direction(m.fit.lrs.nint_20220111,effects = c("fixed")),
p_direction(m.fit.lrssa.nint_20220111,effects = c("fixed")),p_direction(m.fit.ngo.kk.nint_20220111,effects = c("fixed")))
write.csv(pd[,c(1,2)],"pd_results_beta_table1_20220111.csv")

pd <- rbind(p_direction(m.fit.lifespan.nint_20220111,effects = c("fixed"),component = "zi"),p_direction(m.fit.lrs.nint_20220111,effects = c("fixed"),component = "zi"),
p_direction(m.fit.lrssa.nint_20220111,effects = c("fixed"),component = "zi"),p_direction(m.fit.ngo.kk.nint_20220111,effects = c("fixed"),component = "zi"))
write.csv(pd[,c(1,2)],"pd_zi_results_table1_20220111.csv")

```

#### Table 2

```{r}

r2_summary <- rbind(bayes_R2(m.fit.lifespan_20220111),bayes_R2(m.fit.lrs_20220111),bayes_R2(m.fit.lrssa_20220111),bayes_R2(m.fit.ngo.kk_20220111))
r2_summary <- as.data.frame(round(r2_summary,3))
r2_summary$`95%.CIs` <- paste(r2_summary$Q2.5,r2_summary$Q97.5,sep=" - ")
r2_summary <- r2_summary[,c(1,5)]
r2_summary$`95%.CIs` <- paste(paste("[",r2_summary$`95%.CIs`,sep=""),"]",sep="")
r2_summary
# Data Import
genetic_contributions <- read.csv("rv-data.csv")

Elm_st_time<- 8*32.13458
Lin_st_time<-8*32.21

igc <- genetic_contributions[genetic_contributions$Parish=="Elm"& genetic_contributions$Cohort<(1990-Elm_st_time)|genetic_contributions$Parish=="Lin"& genetic_contributions$Cohort<(1990-Lin_st_time),]

igc$Sex <- as.factor(igc$Sex)
igc$Parish <- as.factor(igc$Parish)

fitness_metrics <- read.csv("fitness_proxy_data.csv")

fitness_metrics$ID <- fitness_metrics$IDp
fitness_metrics <- fitness_metrics[,c("ID","ngo.kk","lifespan","lrs","lrssa","ngo.kk","prop.lrs.non.migrators")]

igc <- left_join(igc, fitness_metrics, by="ID")

## Add 10-year cohort
igc$cohort.10y <- cut(igc$Cohort, c(1574,seq(1595,1735,10)), labels=c(1574,seq(1595,1725,10)))

igc$parish.cohort.10y <- paste(sep=":", igc$Parish,igc$cohort.10y)

d_nonNA <-igc %>%
  drop_na(lifespan) %>%
  drop_na(lrs) %>% 
  drop_na(lrssa) %>% 
  drop_na(ngo.kk) %>% 
  drop_na(Proportional) %>%
  drop_na(Parish) %>%
  drop_na(Sex) %>%
  drop_na(parish.cohort.10y) %>%
  drop_na(prop.lrs.non.migrators)

d_nonNA <- d_nonNA %>% dplyr::select(lifespan,lrs,lrssa,ngo.kk,parish.cohort.10y,Parish,Sex,Proportional,prop.lrs.non.migrators)

library("Hmisc")
rcorr(as.matrix(d_nonNA[,1:4]))

```
#### Supplementary Table 2

##### posterior distribtuion estimates

```{r}

posterior_summary <- rbind(posterior_summary(m.fit.lifespan_20220111)[1:20,c(1,3,4)],posterior_summary(m.fit.lrs_20220111)[1:20,c(1,3,4)],posterior_summary(m.fit.lrssa_20220111)[1:20,c(1,3,4)],posterior_summary(m.fit.ngo.kk_20220111)[1:20,c(1,3,4)])
posterior_summary <- as.data.frame(round(posterior_summary,3))
posterior_summary$`95%.CIs` <- paste(posterior_summary$Q2.5,posterior_summary$Q97.5,sep=" - ")
posterior_summary$`95%.CIs` <- paste(paste("[",posterior_summary$`95%.CIs`,sep=""),"]",sep="")
posterior_summary <- posterior_summary[,c(1,4)]

write.csv(posterior_summary,"supplementary_results_table2_20220111.csv")
```

##### Probability direction

```{r}

pd <- rbind(p_direction(m.fit.lifespan_20220111,effects = c("fixed")),p_direction(m.fit.lrs_20220111,effects = c("fixed")),
p_direction(m.fit.lrssa_20220111,effects = c("fixed")),p_direction(m.fit.ngo.kk_20220111,effects = c("fixed")))
write.csv(pd[,c(1,2)],"pd_beta_supplementary_results_table2_20220111.csv")

pd <- rbind(p_direction(m.fit.lifespan_20220111,effects = c("fixed"),component = "zi"),p_direction(m.fit.lrs_20220111,effects = c("fixed"),component = "zi"),
p_direction(m.fit.lrssa_20220111,effects = c("fixed"),component = "zi"),p_direction(m.fit.ngo.kk_20220111,effects = c("fixed"),component = "zi"))
write.csv(pd[,c(1,2)],"pd_zi_supplementary_results_table2_20220111.csv")

```

## Is LRS an unbiased estimate of IGC?

```{r}

m.offgc.lrs.lifespan_20220131 <- readRDS(file = "statistical_models_20220113/m.offgc.lrs.lifespan_20220131.rds")
m.offgc.lrs.lifespan.nint_20220131 <- readRDS(file = "statistical_models_20220113/m.offgc.lrs.lifespan.nint_20220131.rds")

```

### Model checks

```{r}
summary(m.offgc.lrs.lifespan.nint_20220131)$formula
summary(m.offgc.lrs.lifespan_20220131)$formula

prior_summary(m.offgc.lrs.lifespan_20220131)
prior_summary(m.offgc.lrs.lifespan.nint_20220131)

## Convergrence of models
tidy_stan(m.offgc.lrs.lifespan_20220131)
tidy_stan(m.offgc.lrs.lifespan.nint_20220131)

pp_check(m.offgc.lrs.lifespan_20220131,nsamples = 50)
pp_check(m.offgc.lrs.lifespan.nint_20220131,nsamples = 50)

```


### Results

```{r}
bayes_R2(m.offgc.lrs.lifespan_20220131)
bayes_R2(m.offgc.lrs.lifespan.nint_20220131)

mcmc_areas(m.offgc.lrs.lifespan.nint_20220131,pars = parnames(m.offgc.lrs.lifespan.nint_20220131)[2:9], prob = .95)
mcmc_areas(m.offgc.lrs.lifespan_20220131,pars = parnames(m.offgc.lrs.lifespan_20220131)[2:11], prob = .95)

```
#### Table 3

```{r}
#posterior estimate 
posterior_summary <- posterior_summary(m.offgc.lrs.lifespan.nint_20220131)[1:7,c(1,3,4)]
posterior_summary <- as.data.frame(round(posterior_summary,3))
posterior_summary$`95%.CIs` <- paste(posterior_summary$Q2.5,posterior_summary$Q97.5,sep=" - ")
posterior_summary$`95%.CIs` <- paste(paste("[",posterior_summary$`95%.CIs`,sep=""),"]",sep="")
posterior_summary <- posterior_summary[,c(1,4)]

write.csv(posterior_summary,"results_table3_20220217.csv")
```

```{r}
pd <- p_direction(m.offgc.lrs.lifespan.nint_20220131,effects = c("fixed"))
write.csv(pd[,c(1,2)],"pd_results_table3_20220217.csv")
```

#### Supplementary Table 3

```{r}
#posterior estimate 
posterior_summary <- posterior_summary(m.offgc.lrs.lifespan_20220131)[1:9,c(1,3,4)]
posterior_summary <- as.data.frame(round(posterior_summary,3))
posterior_summary$`95%.CIs` <- paste(posterior_summary$Q2.5,posterior_summary$Q97.5,sep=" - ")
posterior_summary$`95%.CIs` <- paste(paste("[",posterior_summary$`95%.CIs`,sep=""),"]",sep="")
posterior_summary <- posterior_summary[,c(1,4)]

write.csv(posterior_summary,"supplementary_table_3_20220217.csv")
```

```{r}
pd <- p_direction(m.offgc.lrs.lifespan_20220131,effects = c("fixed"))
write.csv(pd[,c(1,2)],"pd_supplementary_table_3_20220217.csv")
```


#### Figure 2

```{r}

ce_fig.offgc.lrs <- conditional_effects(m.offgc.lrs.lifespan.nint_20220131,prob = .95) %>% 
  plot(points = T,
       point_args=c(alpha=.3,size=2),
        line_args=c(colour="black"))

ce_fig.offgc.lrs$lrs +
  scale_alpha_continuous(0.1) +
  ylab("Mean offspring IGCs")+
  xlab(bquote('LRS'))  +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        axis.line.x.bottom = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text = element_text(colour = "black", size = 16, angle = 0, family = "serif")) +
  theme(legend.position = "right",legend.justification = c(0.01, 1))+
  theme(axis.title.x =  element_text(colour = "black", size = 16, face="plain")) +
  theme(axis.title.y = element_text(colour = "black", size = 16, face="plain", lineheight = 0.5))

```




